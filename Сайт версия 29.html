<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>–°—É—Ä–≥—É—Ç–Ω–µ—Ñ—Ç–µ–≥–∞–∑ ‚Äî –£—á—ë—Ç –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">

<style>
  :root{
    /* === CORPORATE BACKGROUND / CONTRAST (UPDATED) === */
    --bg:#eef1f5;                 /* —Å–ø–æ–∫–æ–π–Ω—ã–π —Å–µ—Ä–æ-–≥–æ–ª—É–±–æ–π —Ñ–æ–Ω */
    --panel:#ffffff;              /* –±–µ–ª—ã–µ –ø–∞–Ω–µ–ª–∏ */
    --border:#d9dee7;             /* –∑–∞–º–µ—Ç–Ω–µ–µ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–∏ */
    --shadow:0 6px 16px rgba(15, 23, 42, .10);

    --text:#1f2937;
    --muted:#667085;

    --brand:#0f224d;
    --brand2:#1b2a45;

    --ok:#28a745;
    --warn:#ff9900;
    --bad:#ff4d4f;

    --chip:#f1f5f9;
    --chipText:#334155;

    --rowHover:#f7f9fc;
  }

  body.theme-dark{
    /* === DARK THEME STRICT (UPDATED) === */
    --bg:#0b1220;
    --panel:#101a2f;
    --border:rgba(255,255,255,.12);
    --shadow:0 14px 36px rgba(0,0,0,.45);

    --text:#e5e7eb;
    --muted:#94a3b8;

    --brand:#1e3a8a;
    --brand2:#1d4ed8;

    --chip:rgba(255,255,255,.06);
    --chipText:#e5e7eb;

    --rowHover:rgba(255,255,255,.05);
  }

  /* === BODY BACKGROUND STRICT + LIGHT VIGNETTE (UPDATED) === */
  body{
    margin:0;
    font-family:'Roboto',sans-serif;
    background:var(--bg);
    color:var(--text);
    min-height:100vh;
  }
  body::before{
    content:"";
    position:fixed;
    inset:0;
    pointer-events:none;
    background: radial-gradient(1200px 700px at 50% -10%, rgba(255,255,255,.55), transparent 60%);
    opacity:.35;
  }
  body.theme-dark::before{
    background: radial-gradient(1200px 700px at 50% -10%, rgba(255,255,255,.08), transparent 60%);
    opacity:1;
  }

  .header{
    position:sticky; top:0; z-index:50;
    background:var(--brand); color:#fff;
    padding:12px 18px;
    display:flex; align-items:center; gap:12px;
    box-shadow:0 6px 16px rgba(0,0,0,.25);
  }
  .logo{
    width:44px; height:44px; background:#fff; color:var(--brand);
    font-weight:800; border-radius:10px; display:flex; align-items:center; justify-content:center; font-size:18px;
  }
  .header h2{ margin:0; font-size:18px; font-weight:700; }
  .header-actions{ margin-left:auto; display:flex; gap:10px; align-items:center; flex-wrap:wrap; }

  .role-pill{
    display:inline-flex; gap:8px; align-items:center;
    background: rgba(255,255,255,.14);
    padding:6px 10px; border-radius:999px;
    font-size:12px;
  }
  .role-dot{ width:10px; height:10px; border-radius:999px; background:#cbd5e1; box-shadow: inset 0 0 0 2px rgba(255,255,255,.25); }
  .role-pill[data-role="viewer"] .role-dot{ background:#94a3b8; }
  .role-pill[data-role="editor"] .role-dot{ background:#60a5fa; }
  .role-pill[data-role="admin"]  .role-dot{ background:#fb7185; }
  .role-pill b{ font-weight:800; }

  .btn{
    background: rgba(255,255,255,.14);
    border:1px solid rgba(255,255,255,.18);
    color:white;
    padding:7px 10px;
    border-radius:10px;
    cursor:pointer;
    font-weight:700;
    transition: transform .15s ease, background .15s ease;
    user-select:none;
  }
  .btn:hover{ background: rgba(255,255,255,.20); transform: translateY(-1px); }
  .btn:disabled{ opacity:.55; cursor:not-allowed; transform:none; }

  /* === OPTIONAL: make layout more ‚Äúcorporate‚Äù on wide screens (UPDATED) === */
  .container{
    padding:12px;
    max-width:1400px;
    margin:0 auto;
  }

  .filters{
    position:sticky; top:72px; z-index:40;
    background: color-mix(in srgb, var(--bg) 92%, transparent);
    backdrop-filter: blur(10px);
    border-bottom:1px solid var(--border);
    padding:10px 0 6px;
  }
  .select-container{ display:flex; align-items:center; gap:12px; flex-wrap:wrap; padding:0 10px; }
  .select-container b{ font-size:14px; margin-right:6px; color:var(--muted); }
  .select-container select, .select-container input{
    font-size:14px; padding:8px 10px; border-radius:10px; border:1px solid var(--border);
    background:var(--panel); color:var(--text); outline:none;
  }
  .select-container input{ min-width:160px; }
  h3#title{ margin:10px 10px 8px; font-size:1.05em; }

  .separator{
    background:var(--panel);
    border-radius:14px;
    margin:0 10px 14px;
    overflow:hidden;

    /* UPDATED: stronger separators/readability */
    border:1px solid var(--border);
    box-shadow:var(--shadow);
  }
  .separator[data-status="repair"]{ border-left:6px solid var(--warn); }
  .separator[data-status="working"]{ border-left:6px solid var(--ok); }
  .separator[data-inspect="bad"]{ box-shadow:0 0 0 1px color-mix(in srgb, var(--bad) 45%, transparent), var(--shadow); }
  .separator[data-to="overdue"]{ border-right:6px solid var(--bad); }
  .separator[data-to="soon"]{ border-right:6px solid var(--warn); }

  /* UPDATED: header background ‚Äúcorporate‚Äù */
  .separator-header{
    background:#f3f6fb;
    padding:12px 14px;
    font-weight:800;
    cursor:pointer;
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:12px;
  }
  body.theme-dark .separator-header{
    background: rgba(255,255,255,.04);
  }

  .sep-left{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
  .sep-right{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; }

  .status-dot{
    width:10px; height:10px; border-radius:999px;
    background:var(--ok);
    box-shadow:0 0 0 3px color-mix(in srgb, var(--ok) 18%, transparent);
  }
  .separator[data-status="repair"] .status-dot{
    background:var(--warn);
    box-shadow:0 0 0 3px color-mix(in srgb, var(--warn) 18%, transparent);
  }

  .chips{ display:flex; align-items:center; gap:6px; flex-wrap:wrap; }
  .chip{
    display:inline-flex; align-items:center; gap:6px;
    padding:4px 8px; border-radius:999px;
    background:var(--chip); color:var(--chipText);
    border:1px solid var(--border);
    font-size:12px;
    user-select:none;
  }
  .chip strong{ font-weight:900; }
  .chip.bad{ border-color: color-mix(in srgb, var(--bad) 40%, var(--border)); }
  .chip.warn{ border-color: color-mix(in srgb, var(--warn) 40%, var(--border)); }
  .chip.ok{ border-color: color-mix(in srgb, var(--ok) 40%, var(--border)); }

  .separator-body{ max-height:0; overflow:hidden; transition:max-height .28s ease; padding:0 14px; }

  .tabs{ display:flex; border-bottom:1px solid var(--border); margin:10px 0 8px; flex-wrap:wrap; gap:8px; }
  .tab-button{
    padding:8px 12px;
    border:none;
    background: color-mix(in srgb, var(--panel) 92%, var(--chip));
    color:var(--text);
    font-weight:800;
    cursor:pointer;
    border-radius:12px 12px 0 0;
    transition: transform .15s ease, background .15s ease;
    display:inline-flex; align-items:center; gap:8px;
  }
  .tab-button:hover{ transform: translateY(-1px); }
  .tab-button.active{ background:var(--panel); border-bottom:3px solid var(--brand); }
  .tab-count{
    min-width:22px; height:18px;
    border-radius:999px;
    background: color-mix(in srgb, var(--brand) 18%, transparent);
    color: var(--text);
    display:inline-flex;
    align-items:center; justify-content:center;
    font-size:12px;
    font-weight:900;
    border:1px solid var(--border);
  }
  .tab-content{ display:none; padding:8px 0 10px; }
  .tab-content.active{ display:block; }

  table{ width:100%; border-collapse:separate; border-spacing:0; border-radius:12px; overflow:hidden; margin-top:10px; border:1px solid var(--border); }
  th{ background:var(--brand); color:#fff; font-weight:700; text-align:left; padding:10px; }
  td{ padding:10px; border-bottom:1px solid var(--border); vertical-align:top; }

  /* UPDATED: stronger row hover, but still strict */
  tr:hover{ background: color-mix(in srgb, var(--rowHover) 70%, var(--panel)); }

  .pdf-btn{
    background:var(--brand); color:#fff; border:none;
    padding:8px 12px; border-radius:12px;
    font-weight:800; cursor:pointer;
    transition: background .15s ease, transform .15s ease;
    margin-top:8px;
  }
  .pdf-btn:hover{ background:var(--brand2); transform: translateY(-1px); }
  .pdf-btn:disabled{ opacity:.55; cursor:not-allowed; transform:none; }

  .status-select{
    font-size:12px; padding:6px 10px; border-radius:10px;
    border:1px solid var(--border); background:var(--panel); color:var(--text);
    cursor:pointer;
  }
  .status-select:disabled{ opacity:.6; cursor:not-allowed; }

  .smalltext{ font-size:12px; color:var(--muted); }

  .journal{ margin-top:10px; }
  .journal h4{ margin:6px 0 8px; }
  .journal textarea{
    width:100%; height:70px; margin-top:5px;
    border-radius:12px; border:1px solid var(--border);
    padding:10px; background:var(--panel); color:var(--text);
  }
  .journal .grid{ display:grid; grid-template-columns:170px 1fr; gap:10px; align-items:center; }
  .journal .grid .full{ grid-column:1 / -1; }
  .journal input[type="date"], .journal input[type="text"], .journal input[type="number"]{
    padding:8px 10px; border-radius:12px; border:1px solid var(--border);
    background:var(--panel); color:var(--text);
  }
  .journal input[type="file"]{ color:var(--text); }
  .journal .photo-row{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; margin-top:6px; }
  .thumb{ width:46px; height:46px; object-fit:cover; border-radius:12px; border:1px solid var(--border); cursor:pointer; }

  .delete-btn{
    background:#dc3545; color:white; border:none;
    padding:6px 10px; border-radius:10px;
    cursor:pointer; font-size:12px; font-weight:800;
  }
  .delete-btn:hover{ filter: brightness(.92); }
  .delete-btn:disabled{ opacity:.55; cursor:not-allowed; }

  .summary-row{
    display:flex; align-items:flex-start; justify-content:space-between; gap:12px;
    background:var(--panel);
    border-radius:14px;
    padding:12px;
    margin:10px 10px 12px;
    flex-wrap:wrap;

    /* UPDATED: stronger border/shadow */
    border:1px solid var(--border);
    box-shadow:var(--shadow);
  }
  .summary-row .left{ font-weight:800; min-width:260px; }
  .summary-row .right{ display:flex; gap:10px; align-items:flex-start; flex-wrap:wrap; }

  .summary-actions{ display:flex; gap:8px; flex-wrap:wrap; }
  .summary-actions .pdf-btn{ margin-top:0; padding:8px 10px; border-radius:12px; }

  .dashboard{
    background: color-mix(in srgb, var(--panel) 92%, var(--chip));
    border:1px solid var(--border);
    border-radius:14px;
    padding:12px;
    min-width: min(540px, 100%);
    box-shadow:var(--shadow);
  }
  .dash-title{ font-weight:900; margin:0 0 10px; }
  .dash-grid{
    display:grid;
    grid-template-columns: repeat(4, minmax(170px, 1fr));
    gap:10px;
  }
  .kpi{
    background:var(--panel);
    border-radius:14px;
    border:1px solid var(--border);
    padding:10px;
    box-shadow: 0 2px 8px rgba(0,0,0,.05);
    transition: transform .15s ease;
    position:relative;
    overflow:hidden;
  }
  .kpi:hover{ transform: translateY(-1px); }
  .kpi .k{ font-size:12px; color:var(--muted); font-weight:800; }
  .kpi .v{ font-size:22px; font-weight:900; margin-top:6px; letter-spacing:.2px; }
  .kpi .s{ font-size:12px; color:var(--muted); margin-top:6px; }
  .bar{ height:10px; border-radius:999px; background: color-mix(in srgb, var(--border) 70%, transparent); overflow:hidden; margin-top:8px; }
  .bar > div{ height:100%; background:var(--brand); width:0%; transition: width .45s ease; }

  .spark{ position:absolute; right:8px; bottom:8px; width:72px; height:26px; opacity:.9; }
  .spark polyline{ fill:none; stroke: color-mix(in srgb, var(--brand) 70%, white); stroke-width:2; }

  .empty{
    margin:14px 10px;
    background:var(--panel);
    border:1px dashed var(--border);
    border-radius:14px;
    padding:18px;
    box-shadow:var(--shadow);
  }
  .empty h3{ margin:0 0 8px; }
  .empty p{ margin:0; color:var(--muted); }

  .skeleton{
    margin:10px 10px;
    border-radius:14px;
    background:var(--panel);
    border:1px solid var(--border);
    box-shadow:var(--shadow);
    padding:14px;
    overflow:hidden;
  }
  .sk-line{
    height:12px; border-radius:999px;
    background: color-mix(in srgb, var(--border) 55%, transparent);
    position:relative; overflow:hidden;
    margin:10px 0;
  }
  .sk-line::after{
    content:""; position:absolute; inset:0;
    transform: translateX(-60%);
    background: linear-gradient(90deg, transparent, rgba(255,255,255,.22), transparent);
    animation: shimmer 1.1s infinite;
  }
  body.theme-dark .sk-line::after{
    background: linear-gradient(90deg, transparent, rgba(255,255,255,.10), transparent);
  }
  @keyframes shimmer{ 0%{ transform: translateX(-60%);} 100%{ transform: translateX(60%);} }

  .overlay{
    position:fixed; inset:0; background:rgba(0,0,0,.45);
    display:flex; align-items:center; justify-content:center;
    z-index:9999;
  }
  .modal{
    width:min(920px, calc(100% - 24px));
    background:var(--panel); color:var(--text);
    border-radius:16px; padding:16px;
    box-shadow: 0 18px 50px rgba(0,0,0,.35);
    border:1px solid var(--border);
  }
  .modal h3{ margin:0 0 8px; }
  .modal p{ margin:0 0 12px; color:var(--muted); }
  .modal .row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
  .modal input{
    flex:1;
    padding:10px 12px; border-radius:12px; border:1px solid var(--border);
    background:var(--panel); color:var(--text);
  }
  .modal .hint{ font-size:12px; color:var(--muted); margin-top:10px; }

  .list-table td{ cursor:pointer; }
  .pill{ display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; border:1px solid var(--border); background:var(--chip); color:var(--chipText); }

  @media (max-width:900px){
    .dash-grid{ grid-template-columns: repeat(2, minmax(160px, 1fr)); }
    .filters{ top:74px; }
  }
  @media (max-width:768px){
    .journal .grid{ grid-template-columns: 1fr; }
    .filters{ top:74px; }
  }

  /* =====================
     üî• Visual upgrade pack
  ====================== */

  /* better text rendering */
  body{ -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }

  /* subtle background texture */
  body::after{
    content:"";
    position:fixed;
    inset:0;
    pointer-events:none;
    background:
      radial-gradient(900px 420px at 10% 10%, rgba(59,130,246,.12), transparent 55%),
      radial-gradient(820px 420px at 90% 20%, rgba(34,197,94,.10), transparent 55%),
      radial-gradient(900px 520px at 50% 110%, rgba(245,158,11,.08), transparent 55%);
    opacity:.8;
    mix-blend-mode: multiply;
  }
  body.theme-dark::after{
    mix-blend-mode: screen;
    opacity:.55;
  }

  /* polished focus */
  :is(button, input, select, textarea):focus{
    outline: none;
  }
  :is(button, input, select, textarea):focus-visible{
    box-shadow: 0 0 0 4px color-mix(in srgb, var(--brand) 25%, transparent);
    border-color: color-mix(in srgb, var(--brand) 45%, var(--border));
  }

  /* scrollbars (desktop) */
  *::-webkit-scrollbar{ width: 10px; height: 10px; }
  *::-webkit-scrollbar-thumb{
    background: color-mix(in srgb, var(--brand) 25%, var(--border));
    border-radius: 999px;
    border: 2px solid color-mix(in srgb, var(--panel) 80%, transparent);
  }
  *::-webkit-scrollbar-track{ background: transparent; }

  /* HERO */
  .hero{
    position:relative;
    margin: 12px 12px 0;
    border-radius: 18px;
    overflow:hidden;
    border:1px solid var(--border);
    box-shadow: var(--shadow);
    min-height: 220px;
    background: var(--panel);
  }
  .hero-bg{
    position:absolute;
    inset:0;
    background:
      linear-gradient(120deg, rgba(15,34,77,.90), rgba(15,34,77,.55));
    background-size: cover;
    background-position: center;
    filter: saturate(1.05);
    transform: scale(1.02);
  }
  body.theme-dark .hero-bg{
    filter: saturate(1.05) brightness(.85);
  }
  .hero-overlay{
    position:absolute;
    inset:0;
    background: radial-gradient(800px 300px at 30% 20%, rgba(255,255,255,.20), transparent 60%);
    opacity:.9;
  }
  body.theme-dark .hero-overlay{
    background: radial-gradient(800px 300px at 30% 20%, rgba(255,255,255,.08), transparent 60%);
    opacity:1;
  }
  .hero-inner{
    position:relative;
    z-index:2;
    padding: 18px 18px 16px;
    display:flex;
    align-items:flex-end;
    justify-content:space-between;
    gap: 14px;
    flex-wrap: wrap;
    color:#fff;
  }
  .hero-brand{ display:flex; gap:14px; align-items:center; flex-wrap:wrap; }
  .hero-logo{
    width:86px; height:86px;
    object-fit:contain;
    background:rgba(255,255,255,.92);
    border-radius:18px;
    padding:10px;
    box-shadow: 0 12px 30px rgba(0,0,0,.30);
  }
  .hero-logo-fallback{
    width:86px; height:86px;
    border-radius:18px;
    background:rgba(255,255,255,.92);
    color: var(--brand);
    font-weight: 1000;
    display:grid;
    place-items:center;
    font-size: 22px;
    box-shadow: 0 12px 30px rgba(0,0,0,.30);
  }
  .hero-text h1{
    margin:0;
    font-size: 30px;
    letter-spacing:.4px;
    text-shadow: 0 10px 24px rgba(0,0,0,.35);
  }
  .hero-text p{
    margin: 6px 0 0;
    opacity:.92;
    max-width: 720px;
    text-shadow: 0 10px 24px rgba(0,0,0,.35);
  }
  .hero-badges{
    display:flex;
    gap:8px;
    flex-wrap:wrap;
    margin-top:10px;
  }
  .hb{
    display:inline-flex;
    align-items:center;
    gap:8px;
    background: rgba(255,255,255,.14);
    border:1px solid rgba(255,255,255,.18);
    padding: 6px 10px;
    border-radius: 999px;
    font-size: 12px;
    backdrop-filter: blur(10px);
  }
  .hb b{ font-weight: 1000; }
  .hero-actions{
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    align-items:center;
  }
  .cta{
    border:none;
    cursor:pointer;
    font-weight: 900;
    padding: 10px 14px;
    border-radius: 14px;
    background: rgba(255,255,255,.92);
    color: var(--brand);
    box-shadow: 0 12px 30px rgba(0,0,0,.30);
    transition: transform .15s ease, filter .15s ease;
  }
  .cta:hover{ transform: translateY(-1px); filter: brightness(.98); }
  .cta.ghost{
    background: rgba(255,255,255,.14);
    color:#fff;
    border: 1px solid rgba(255,255,255,.20);
    box-shadow: none;
  }

  /* TOP NAV */
  .top-nav{
    margin: 10px 12px 0;
    background: color-mix(in srgb, var(--panel) 92%, var(--chip));
    border:1px solid var(--border);
    border-radius: 16px;
    padding: 10px;
    display:flex;
    gap: 10px;
    align-items:center;
    flex-wrap: wrap;
    box-shadow: var(--shadow);
    position: sticky;
    top: 72px;
    z-index: 45;
    backdrop-filter: blur(10px);
  }
  .top-spacer{ flex:1; }
  .top-link{
    border:none;
    cursor:pointer;
    padding: 9px 12px;
    border-radius: 999px;
    font-weight: 900;
    background: var(--chip);
    color: var(--text);
    border: 1px solid var(--border);
    transition: transform .15s ease, background .15s ease, color .15s ease;
  }
  .top-link:hover{ transform: translateY(-1px); background: color-mix(in srgb, var(--brand) 12%, var(--chip)); }
  .top-link.active{ background: var(--brand); color:#fff; border-color: color-mix(in srgb, var(--brand) 55%, var(--border)); }
  .top-mini{
    border:none;
    cursor:pointer;
    width: 40px;
    height: 40px;
    border-radius: 14px;
    background: var(--panel);
    border: 1px solid var(--border);
    font-weight: 900;
    transition: transform .15s ease;
  }
  .top-mini:hover{ transform: translateY(-1px); }

  /* SETTINGS */
  .settings-card{
    background: color-mix(in srgb, var(--panel) 92%, var(--chip));
    border:1px solid var(--border);
    border-radius: 16px;
    padding: 12px;
    box-shadow: var(--shadow);
  }
  .settings-title{ font-weight: 1000; margin-bottom: 8px; }
  .settings-row{ display:flex; gap:10px; align-items:center; }

  /* separator improvements */
  .separator{
    transition: transform .16s ease, box-shadow .16s ease;
    will-change: transform;
  }
  .separator:hover{
    transform: translateY(-2px);
    box-shadow: 0 16px 34px rgba(0,0,0,.16);
  }
  .separator-header{
    position: relative;
  }
  .separator-header::after{
    content:"";
    position:absolute;
    left:0; right:0; bottom:0;
    height: 1px;
    background: linear-gradient(90deg, transparent, color-mix(in srgb, var(--border) 65%, transparent), transparent);
    opacity:.65;
  }

  /* floating action buttons */
  .fab-wrap{
    position: fixed;
    right: 14px;
    bottom: 14px;
    display:flex;
    flex-direction: column;
    gap: 10px;
    z-index: 9998;
  }
  .fab{
    width: 46px;
    height: 46px;
    border-radius: 16px;
    border: 1px solid var(--border);
    background: var(--panel);
    box-shadow: var(--shadow);
    cursor:pointer;
    font-weight: 1000;
    transition: transform .15s ease;
  }
  .fab:hover{ transform: translateY(-2px); }

  /* status pulse */
  .status-dot{ animation: pulse 1.8s infinite; }
  @keyframes pulse{
    0%{ box-shadow:0 0 0 0 color-mix(in srgb, var(--ok) 55%, transparent);}
    70%{ box-shadow:0 0 0 10px rgba(0,0,0,0);}
    100%{ box-shadow:0 0 0 0 rgba(0,0,0,0);}
  }

  @media (max-width: 768px){
    .hero-inner{ align-items:flex-start; }
    .hero-text h1{ font-size: 24px; }
    .hero{ min-height: 240px; }
  }


  /* === Forecasting tab === */
  .forecast-wrap{
    display:grid;
    grid-template-columns: 320px 1fr;
    gap:14px;
    margin-top:10px;
  }
  @media (max-width:900px){
    .forecast-wrap{ grid-template-columns:1fr; }
  }
  .forecast-card{
    background:var(--panel);
    border:1px solid var(--border);
    border-radius:14px;
    padding:12px;
    box-shadow:var(--shadow);
  }
  .forecast-title{ font-weight:900; margin:0 0 8px; }
  .forecast-kpi{ display:flex; gap:10px; flex-wrap:wrap; }
  .risk-pill{
    display:inline-flex; align-items:center; gap:8px;
    padding:6px 10px; border-radius:999px;
    border:1px solid var(--border);
    background:var(--chip);
    font-weight:900; font-size:12px;
  }
  .risk-pill.high{ border-color: color-mix(in srgb, var(--bad) 45%, var(--border)); }
  .risk-pill.med{ border-color: color-mix(in srgb, var(--warn) 45%, var(--border)); }
  .risk-pill.low{ border-color: color-mix(in srgb, var(--ok) 45%, var(--border)); }
  .zone-list{ margin:8px 0 0; padding:0; list-style:none; }
  .zone-list li{ padding:8px 10px; border:1px solid var(--border); border-radius:12px; background:color-mix(in srgb, var(--panel) 92%, var(--chip)); margin-top:8px; }
  .zone-list b{ font-weight:900; }
  .zone-note{ color:var(--muted); font-size:12px; margin-top:6px; }

  .shell-scheme{
    display:grid;
    grid-template-columns: repeat(6, minmax(120px, 1fr));
    gap:10px;
  }
  @media (max-width:900px){
    .shell-scheme{ grid-template-columns: repeat(3, minmax(120px, 1fr)); }
  }
  @media (max-width:520px){
    .shell-scheme{ grid-template-columns: repeat(2, minmax(120px, 1fr)); }
  }
  .shell{
    border:1px solid var(--border);
    background: color-mix(in srgb, var(--panel) 88%, var(--chip));
    border-radius:14px;
    padding:10px;
    cursor:pointer;
    text-align:left;
    box-shadow: 0 2px 10px rgba(0,0,0,.10);
    transition: transform .15s ease, box-shadow .15s ease;
  }
  .shell:hover{ transform: translateY(-1px); box-shadow: 0 10px 22px rgba(0,0,0,.14); }
  .shell[data-level="hi"]{ border-color: color-mix(in srgb, var(--bad) 55%, var(--border)); }
  .shell[data-level="med"]{ border-color: color-mix(in srgb, var(--warn) 55%, var(--border)); }
  .shell[data-level="low"]{ border-color: color-mix(in srgb, var(--ok) 55%, var(--border)); }
  .shell-top{ font-weight:900; font-size:14px; }
  .shell-bot{ margin-top:8px; font-size:12px; color:var(--muted); }
  .shell-bar{ height:10px; border-radius:999px; background: color-mix(in srgb, var(--border) 70%, transparent); overflow:hidden; margin-top:8px; }
  .shell-bar > div{ height:100%; background:var(--brand); }

  .forecast-sub{ font-weight:900; margin:12px 0 6px; }
  .forecast-list{ margin:0; padding-left:18px; }

  .sep-scheme{
    width:100%;
    height:auto;
    display:block;
  }
  .z{
    fill: color-mix(in srgb, var(--brand) 18%, transparent);
    stroke: color-mix(in srgb, var(--border) 70%, transparent);
    stroke-width:1.2;
    transition: .18s ease;
  }
  .z:hover{ filter: brightness(1.08); cursor:pointer; }
  .z.high{ fill: color-mix(in srgb, var(--bad) 28%, transparent); stroke: color-mix(in srgb, var(--bad) 55%, var(--border)); }
  .z.med { fill: color-mix(in srgb, var(--warn) 24%, transparent); stroke: color-mix(in srgb, var(--warn) 55%, var(--border)); }
  .z.low { fill: color-mix(in srgb, var(--ok) 20%, transparent); stroke: color-mix(in srgb, var(--ok) 55%, var(--border)); }


  /* === Predicted defects tab (new) === */
  .pd-wrap{
    display:grid;
    grid-template-columns: minmax(280px, 330px) 1fr;
    gap:14px;
    margin-top:10px;
  }
  @media (max-width: 980px){
    .pd-wrap{ grid-template-columns: 1fr; }
  }
  @media (max-width: 520px){
    .pd-grid{ grid-template-columns: 1fr; }
  }
  .pd-card{
    background:var(--panel);
    overflow:hidden;
    border:1px solid var(--border);
    border-radius:14px;
    padding:12px;
    box-shadow:var(--shadow);
  }
  .pd-title{ font-weight:1000; margin:0 0 10px; display:flex; align-items:center; gap:10px; }
  .pd-sub{ color:var(--muted); font-size:12px; margin-top:6px; line-height:1.35; }
  .pd-grid{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap:8px;
    align-items:end;
  }
  .pd-grid .full{ grid-column: 1 / -1; }
  .pd-grid label{ font-size:12px; color:var(--muted); font-weight:800; }
  .pd-grid input, .pd-grid select{
    width:100%;
    padding:8px;
    border-radius:10px;
    border:1px solid var(--border);
    background:var(--panel);
    color:var(--text);
    font-weight:700;
  }
  .pd-actions{ display:flex; gap:8px; flex-wrap:wrap; margin-top:10px; }
  .pd-actions .pdf-btn{ margin-top:0; }
  .pd-mini{
    font-size:12px;
    color:var(--muted);
    margin-top:10px;
  }

  .pd-scheme-card{
    background:var(--panel);
    border:1px solid var(--border);
    border-radius:14px;
    padding:12px;
    box-shadow:var(--shadow);
  }
  .pd-scheme-head{
    display:flex;
    justify-content:space-between;
    align-items:flex-start;
    gap:10px;
    flex-wrap:wrap;
    margin-bottom:10px;
  }
  .pd-kpis{ display:flex; gap:8px; flex-wrap:wrap; }
  .pd-pill{
    display:inline-flex; align-items:center; gap:8px;
    padding:6px 10px;
    border-radius:999px;
    border:1px solid var(--border);
    background:var(--chip);
    font-size:12px;
    font-weight:900;
  }
  .pd-pill.ok{ border-color: color-mix(in srgb, var(--ok) 45%, var(--border)); }
  .pd-pill.warn{ border-color: color-mix(in srgb, var(--warn) 45%, var(--border)); }
  .pd-pill.bad{ border-color: color-mix(in srgb, var(--bad) 45%, var(--border)); }

  .pd-svg{
    width:100%;
    height:auto;
    display:block;
    border-radius:12px;
    border:1px solid var(--border);
    background: color-mix(in srgb, var(--panel) 90%, var(--chip));
  }
  .pd-shell{
    stroke: color-mix(in srgb, var(--border) 70%, transparent);
    stroke-width: 1.2;
    cursor:pointer;
    transition: filter .15s ease, transform .15s ease;
    transform-origin: center;
  }
  .pd-shell:hover{ filter: brightness(1.06); }
  .pd-shell.sel{ stroke: color-mix(in srgb, var(--brand) 65%, var(--border)); stroke-width: 2.2; }

  .pd-legend{
    display:flex;
    gap:8px;
    flex-wrap:wrap;
    margin-top:10px;
    font-size:12px;
    color:var(--muted);
  }
  .pd-legend span{
    display:inline-flex;
    align-items:center;
    gap:8px;
    padding:6px 10px;
    border-radius:999px;
    border:1px solid var(--border);
    background: var(--chip);
    color: var(--chipText);
    font-weight:800;
  }
  .pd-dot{ width:10px; height:10px; border-radius:999px; border:1px solid var(--border); background: var(--panel); }
  .pd-dot.ok{ background: color-mix(in srgb, var(--ok) 60%, white); }
  .pd-dot.warn{ background: color-mix(in srgb, var(--warn) 70%, white); }
  .pd-dot.bad{ background: color-mix(in srgb, var(--bad) 70%, white); }

  .pd-chart{
    margin-top:10px;
    border:1px solid var(--border);
    border-radius:12px;
    padding:10px;
    background: color-mix(in srgb, var(--panel) 92%, var(--chip));
  }
  .pd-chart-head{
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:10px;
    flex-wrap:wrap;
  }
  .pd-canvas{
    width:100%;
    height:220px;
    display:block;
    margin-top:10px;
    border-radius:10px;
    background: color-mix(in srgb, var(--panel) 92%, transparent);
    border:1px solid color-mix(in srgb, var(--border) 70%, transparent);
  }

  .pd-objlist{ margin:10px 0 0; padding:0; list-style:none; display:grid; gap:8px; }
  .pd-objlist li{
    border:1px solid var(--border);
    border-radius:12px;
    background: color-mix(in srgb, var(--panel) 92%, var(--chip));
    padding:10px;
    display:flex;
    justify-content:space-between;
    gap:10px;
    align-items:flex-start;
  }
  .pd-objlist b{ font-weight:1000; }
  .pd-objmeta{ font-size:12px; color:var(--muted); margin-top:4px; line-height:1.3; }
  .pd-table{
    width:100%;
    margin-top:10px;
    border:1px solid var(--border);
    border-radius:12px;
    overflow:hidden;
  }

</style>
</head>

<body>
  <div class="header">
    <div class="logo">–°–ù–ì</div>
    <h2>–°—É—Ä–≥—É—Ç–Ω–µ—Ñ—Ç–µ–≥–∞–∑ ¬∑ –£—á—ë—Ç –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è</h2>

    <div class="header-actions">
      <button class="btn" id="themeBtn" onclick="toggleTheme()" title="–¢–µ–º–∞">–¢–µ–º–∞</button>

      <div class="role-pill" id="rolePill" data-role="" title="–¢–µ–∫—É—â–∞—è —Ä–æ–ª—å –¥–æ—Å—Ç—É–ø–∞">
        <span class="role-dot"></span>
        –†–æ–ª—å: <b id="roleLabel">‚Äî</b>
        <button class="btn" onclick="logout()">–í—ã–π—Ç–∏</button>
      </div>
    </div>
  </div>

  <!-- Hero -->
  <section class="hero" aria-label="–°—É—Ä–≥—É—Ç–Ω–µ—Ñ—Ç–µ–≥–∞–∑">
    <div class="hero-bg" aria-hidden="true"></div>
    <div class="hero-overlay" aria-hidden="true"></div>
    <div class="hero-inner">
      <div class="hero-brand">        <div id="heroLogoFallback" class="hero-logo-fallback" style="display:grid;">–°–ù–ì</div>
        <div class="hero-text">
          <h1>–°—É—Ä–≥—É—Ç–Ω–µ—Ñ—Ç–µ–≥–∞–∑</h1>
          <p>–°–∏—Å—Ç–µ–º–∞ —É—á—ë—Ç–∞, —Ä–µ–º–æ–Ω—Ç–æ–≤ –∏ –∫–æ–Ω—Ç—Ä–æ–ª—è –¢–û / –ù–í–û / –ì–ò –ø–æ –î–ù–°</p>
          <div class="hero-badges">
            <span class="hb"><b id="hbWs">‚Äî</b> —Ü–µ—Ö</span>
            <span class="hb"><b id="hbDns">‚Äî</b> –î–ù–°</span>
            <span class="hb"><b id="hbRepair">‚Äî</b> –≤ —Ä–µ–º–æ–Ω—Ç–µ</span>
            <span class="hb"><b id="hbBad">‚Äî</b> –ø—Ä–æ—Å—Ä–æ—á–µ–∫</span>
          </div>
        </div>
      </div>

      <div class="hero-actions">
        <button class="cta" onclick="focusNav('analytics')">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</button>
        <button class="cta ghost" onclick="focusNav('docs')">–î–æ–∫—É–º–µ–Ω—Ç—ã</button>
        <button class="cta ghost" onclick="focusNav('work')">–ö —Ä–∞–±–æ—Ç–µ</button>
      </div>
    </div>
  </section>

  <!-- –í–µ—Ä—Ö–Ω—è—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è -->
  <nav class="top-nav" aria-label="–ù–∞–≤–∏–≥–∞—Ü–∏—è">
    <button class="top-link active" data-nav="home" onclick="setTopNav(this); focusNav('home')">–ì–ª–∞–≤–Ω–∞—è</button>
    <button class="top-link" data-nav="analytics" onclick="setTopNav(this); focusNav('analytics')">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</button>
    <button class="top-link" data-nav="docs" onclick="setTopNav(this); focusNav('docs')">–î–æ–∫—É–º–µ–Ω—Ç—ã</button>
    <button class="top-link" data-nav="work" onclick="setTopNav(this); focusNav('work')">–†–∞–±–æ—Ç–∞</button>
    <div class="top-spacer"></div>
    <button class="top-mini" onclick="openSettings()">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
  </nav>

  <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ (–º–∏–Ω–∏) -->
  <div id="settingsOverlay" class="overlay" style="display:none;">
    <div class="modal" style="width:min(620px, calc(100% - 24px));">
      <div style="display:flex; justify-content:space-between; gap:10px; align-items:flex-start; flex-wrap:wrap;">
        <div>
          <h3 style="margin:0 0 6px;">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
          <div class="smalltext">–õ–æ–∫–∞–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ –±—Ä–∞—É–∑–µ—Ä–µ (localStorage / sessionStorage).</div>
        </div>
        <button class="pdf-btn" style="margin-top:0;" onclick="closeSettings()">‚úñ</button>
      </div>

      <div style="margin-top:12px; display:grid; gap:10px;">
        <div class="settings-card">
          <div class="settings-title">–í–Ω–µ—à–Ω–∏–π –≤–∏–¥</div>
          <div class="settings-row">
            <button class="pdf-btn" style="margin-top:0;" onclick="toggleTheme()">–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ç–µ–º—É</button>
            <span class="smalltext">–°–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –∫–∞–∫ ui_theme</span>
          </div>
        </div>

        <div class="settings-card">
          <div class="settings-title">–î–∞–Ω–Ω—ã–µ</div>
          <div class="settings-row" style="flex-wrap:wrap;">
            <button class="pdf-btn" style="margin-top:0;" onclick="exportData()">–≠–∫—Å–ø–æ—Ä—Ç</button>
            <label class="pdf-btn" style="margin-top:0; cursor:pointer;">
              –ò–º–ø–æ—Ä—Ç <input id="importFile" type="file" accept="application/json" style="display:none" onchange="importData(this.files[0])">
            </label>
            <button class="delete-btn" onclick="resetData()">–°–±—Ä–æ—Å</button>
          </div>
          <div class="smalltext" style="margin-top:8px;">–≠–∫—Å–ø–æ—Ä—Ç/–∏–º–ø–æ—Ä—Ç ‚Äî –æ–¥–∏–Ω JSON-—Ñ–∞–π–ª —Å–æ –≤—Å–µ–º–∏ –∫–ª—é—á–∞–º–∏ localStorage.</div>
        </div>

        <div class="settings-card" id="customFieldsSettingsCard">
          <div class="settings-title">–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–∞—Å–ø–æ—Ä—Ç–∞ (–¥–æ–ø. –ø–æ–ª—è)</div>
          <div class="smalltext">–î–æ—Å—Ç—É–ø–Ω–æ –¥–ª—è —Ä–æ–ª–∏ <b>editor</b> –∏–ª–∏ <b>admin</b>. –≠—Ç–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ—è–≤—è—Ç—Å—è –≤–æ –≤–∫–ª–∞–¥–∫–µ ¬´–ü–∞—Å–ø–æ—Ä—Ç¬ª.</div>
          <div id="customFieldsSettingsBox" style="margin-top:10px;"></div>
        </div>

      </div>
    </div>
  </div>

  <!-- Floating actions -->
  <div class="fab-wrap" aria-label="–ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è">
    <button class="fab" title="–í–≤–µ—Ä—Ö" onclick="window.scrollTo({top:0, behavior:'smooth'})">‚¨ÜÔ∏è</button>
    <button class="fab" title="–°–ø–∏—Å–æ–∫ —Ä–µ–º–æ–Ω—Ç–æ–≤" onclick="openRepairList()">–†–µ–º</button>
    <button class="fab" title="–¢–µ–º–∞" onclick="toggleTheme()">–¢–µ–º–∞</button>
  </div>



  <!-- –í—Ö–æ–¥ -->
  <div id="authOverlay" class="overlay" style="display:none;">
    <div class="modal" style="width:min(520px, calc(100% - 24px));">
      <h3>–í—Ö–æ–¥</h3>
      <p>–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å –¥–ª—è –¥–æ—Å—Ç—É–ø–∞.</p>
      <div class="row">
        <input id="authPassword" type="password" placeholder="–ü–∞—Ä–æ–ª—å">
        <button class="pdf-btn" onclick="login()">–í–æ–π—Ç–∏</button>
      </div>
      <!-- ‚úÖ –ü–û–î–°–ö–ê–ó–ö–ê –° –ü–ê–†–û–õ–ï–ú –£–î–ê–õ–ï–ù–ê (–ø—É–Ω–∫—Ç 2) -->
    </div>
  </div>

  <!-- –°–ø–∏—Å–æ–∫ —Ä–µ–º–æ–Ω—Ç–æ–≤ -->
  <div id="repairListOverlay" class="overlay" style="display:none;">
    <div class="modal">
      <div style="display:flex; justify-content:space-between; gap:12px; align-items:flex-start; flex-wrap:wrap;">
        <div>
          <h3 style="margin:0 0 6px;">–°–ø–∏—Å–æ–∫ —Ä–µ–º–æ–Ω—Ç–æ–≤ –ø–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –î–ù–°</h3>
          <div class="smalltext" id="repairListSubtitle">‚Äî</div>
        </div>
        <div style="display:flex; gap:8px; flex-wrap:wrap;">
          <button class="pdf-btn" style="margin-top:0;" onclick="refreshRepairList()">–û–±–Ω–æ–≤–∏—Ç—å</button>
          <button class="pdf-btn" style="margin-top:0;" onclick="closeRepairList()">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
      </div>

      <div style="margin-top:10px;">
        <table class="list-table" id="repairListTable"></table>
        <div class="smalltext" style="margin-top:8px;">
          –ü–æ–¥—Å–∫–∞–∑–∫–∞: –∫–ª–∏–∫–Ω–∏ –ø–æ —Å—Ç—Ä–æ–∫–µ ‚Äî –æ—Ç–∫—Ä–æ–µ—Ç—Å—è –Ω—É–∂–Ω—ã–π —Å–µ–ø–∞—Ä–∞—Ç–æ—Ä –∏ –≤–∫–ª–∞–¥–∫–∞ ¬´–ö–∞–ø–∏—Ç–∞–ª—å–Ω—ã–π —Ä–µ–º–æ–Ω—Ç¬ª.
        </div>
      </div>
    </div>
  </div>

  <div class="container">
    <div class="filters">
      <div class="select-container">
        <div>
          <b>–¶–µ—Ö:</b>
          <select id="workshopSelect" onchange="selectWorkshop(this.value)">
            <option value="">‚Äî –≤—ã–±—Ä–∞—Ç—å ‚Äî</option>
            <option value="–¶–î–ù–ì-1">–¶–î–ù–ì-1</option>
            <option value="–¶–î–ù–ì-2">–¶–î–ù–ì-2</option>
            <option value="–¶–î–ù–ì-3">–¶–î–ù–ì-3</option>
            <option value="–¶–î–ù–ì-4">–¶–î–ù–ì-4</option>
            <option value="–¶–î–ù–ì-5">–¶–î–ù–ì-5</option>
            <option value="–¶–î–ù–ì-6">–¶–î–ù–ì-6</option>
            <option value="–¶–î–ù–ì-8">–¶–î–ù–ì-8</option>
            <option value="–¶–î–ù–ì-9">–¶–î–ù–ì-9</option>
            <option value="–¶–î–ù–ì-10">–¶–î–ù–ì-10</option>
            <option value="–¶–î–ù–ì-11">–¶–î–ù–ì-11</option>
          </select>
        </div>

        <div>
          <b>–î–ù–°:</b>
          <select id="dnsSelect" onchange="loadDNS()" disabled>
            <option value="">‚Äî –≤—ã–±—Ä–∞—Ç—å ‚Äî</option>
          </select>
        </div>

        <div>
          <b>–§–∏–ª—å—Ç—Ä:</b>
          <select id="statusFilter" onchange="applyFilter()" disabled>
            <option value="all">–í—Å–µ</option>
            <option value="working">–í —Ä–∞–±–æ—Ç–µ</option>
            <option value="repair">–í —Ä–µ–º–æ–Ω—Ç–µ</option>
          </select>
        </div>

        <div>
          <b>–ü–æ–∏—Å–∫:</b>
          <input id="sepSearch" placeholder="–°-1/1..." oninput="applyFilter()" disabled>
        </div>
      </div>
    </div>

    <h3 id="title"></h3>

    <div id="emptyState" class="empty" style="display:none;">
      <h3>–í—ã–±–µ—Ä–∏ —Ü–µ—Ö –∏ –î–ù–°</h3>
      <p>–ü–æ—Å–ª–µ–¥–Ω–∏–π –≤—ã–±–æ—Ä –∏ –æ—Ç–∫—Ä—ã—Ç—ã–π —Å–µ–ø–∞—Ä–∞—Ç–æ—Ä –±—É–¥—É—Ç –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã.</p>
    </div>

    <div id="dnsSummary" class="summary-row" style="display:none;">
      <div class="left">
        <div id="dnsSummaryText">‚Äî</div>
        <div id="dnsSummaryHint" class="smalltext" style="margin-top:6px;"></div>
        <div id="dnsAlerts" style="margin-top:8px; display:flex; gap:6px; flex-wrap:wrap;"></div>
      </div>

      <div class="right">
        <div class="summary-actions">
          <button class="pdf-btn" id="btnAllWorking" onclick="massSetStatus('working')">–í—Å–µ (–≤–∏–¥–∏–º—ã–µ) –≤ —Ä–∞–±–æ—Ç–µ</button>
          <button class="pdf-btn" id="btnAllRepair" onclick="massSetStatus('repair')">–í—Å–µ (–≤–∏–¥–∏–º—ã–µ) –≤ —Ä–µ–º–æ–Ω—Ç–µ</button>
          <button class="pdf-btn" id="btnRepairList" onclick="openRepairList()">–°–ø–∏—Å–æ–∫ —Ä–µ–º–æ–Ω—Ç–æ–≤</button>
          <button class="pdf-btn" id="btnExpandAll" onclick="toggleAllSeparators(true)">–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å –≤—Å–µ</button>
          <button class="pdf-btn" id="btnCollapseAll" onclick="toggleAllSeparators(false)">–°–≤–µ—Ä–Ω—É—Ç—å –≤—Å–µ</button>
          <button class="pdf-btn" onclick="clearFilter()">–°–±—Ä–æ—Å —Ñ–∏–ª—å—Ç—Ä–∞</button>
        </div>

        <div class="dashboard" id="dashBox">
          <div class="dash-title">–î–∞—à–±–æ—Ä–¥ –î–ù–°</div>
          <div class="dash-grid">
            <div class="kpi">
              <div class="k">–í —Ä–µ–º–æ–Ω—Ç–µ</div>
              <div class="v" id="kpiRepair">‚Äî</div>
              <div class="bar"><div id="barRepair"></div></div>
              <div class="s" id="kpiRepairS">‚Äî</div>
              <svg class="spark" id="sparkRepair" viewBox="0 0 72 26" aria-hidden="true"></svg>
            </div>

            <div class="kpi">
              <div class="k">–ù–í–û –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–æ</div>
              <div class="v" id="kpiNvo">‚Äî</div>
              <div class="s">–ü–æ—Ä–æ–≥: 1 –¥–µ–Ω—å (–∏–ª–∏ –Ω–µ—Ç –∑–∞–ø–∏—Å–µ–π)</div>
              <svg class="spark" id="sparkNvo" viewBox="0 0 72 26" aria-hidden="true"></svg>
            </div>

            <div class="kpi">
              <div class="k">–ì–ò –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–æ</div>
              <div class="v" id="kpiGi">‚Äî</div>
              <div class="s">–ü–æ—Ä–æ–≥: 1 –¥–µ–Ω—å (–∏–ª–∏ –Ω–µ—Ç –∑–∞–ø–∏—Å–µ–π)</div>
              <svg class="spark" id="sparkGi" viewBox="0 0 72 26" aria-hidden="true"></svg>
            </div>

            <div class="kpi">
              <div class="k">–¢–û: –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–æ / —Å–∫–æ—Ä–æ</div>
              <div class="v" id="kpiTo">‚Äî</div>
              <div class="s">–°–∫–æ—Ä–æ: ‚â§ 7 –¥–Ω–µ–π</div>
              <svg class="spark" id="sparkTo" viewBox="0 0 72 26" aria-hidden="true"></svg>
            </div>

            <div class="kpi">
              <div class="k">–°—Ä–µ–¥–Ω—è—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Ä–µ–º–æ–Ω—Ç–∞</div>
              <div class="v" id="kpiRepairAvg">‚Äî</div>
              <div class="s">–ü–æ –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–º —Ä–µ–º–æ–Ω—Ç–∞–º</div>
              <svg class="spark" id="sparkAvg" viewBox="0 0 72 26" aria-hidden="true"></svg>
            </div>

            <div class="kpi">
              <div class="k">–î–Ω–µ–π –±–µ–∑ –ù–í–û (–º–∞–∫—Å)</div>
              <div class="v" id="kpiNvoMax">‚Äî</div>
              <div class="s">–ü–æ —Å–µ–ø–∞—Ä–∞—Ç–æ—Ä–∞–º</div>
              <svg class="spark" id="sparkNvoMax" viewBox="0 0 72 26" aria-hidden="true"></svg>
            </div>

            <div class="kpi">
              <div class="k">–î–Ω–µ–π –±–µ–∑ –ì–ò (–º–∞–∫—Å)</div>
              <div class="v" id="kpiGiMax">‚Äî</div>
              <div class="s">–ü–æ —Å–µ–ø–∞—Ä–∞—Ç–æ—Ä–∞–º</div>
              <svg class="spark" id="sparkGiMax" viewBox="0 0 72 26" aria-hidden="true"></svg>
            </div>

            <div class="kpi">
              <div class="k">–ü—Ä–æ—Å—Ä–æ—á–∫–∏ (–≤—Å–µ–≥–æ)</div>
              <div class="v" id="kpiTotalBad">‚Äî</div>
              <div class="s">–ù–í–û + –ì–ò + –¢–û</div>
              <svg class="spark" id="sparkBad" viewBox="0 0 72 26" aria-hidden="true"></svg>
            </div>
</div>
        </div>
      </div>
    </div>

    <div id="skeletonWrap" style="display:none;">
      <div class="skeleton">
        <div class="sk-line" style="width:40%"></div>
        <div class="sk-line" style="width:65%"></div>
        <div class="sk-line" style="width:55%"></div>
      </div>
      <div class="skeleton">
        <div class="sk-line" style="width:50%"></div>
        <div class="sk-line" style="width:80%"></div>
        <div class="sk-line" style="width:60%"></div>
      </div>
    </div>

    <div id="content"></div>
  </div>

<script>
/* =====================
   UI state persistence
===================== */
const UI = {
  themeKey: "ui_theme",
  wsKey: "ui_workshop",
  dnsKey: "ui_dns",
  openSepKey: "ui_open_sep",
  openTabKey: (ws,dns,sepIdx) => `ui_open_tab_${ws}_${safeIdPart(dns)}_${sepIdx}`,
  filterKey: "ui_filter",
  searchKey: "ui_search",
};

const APP_VERSION = 'v16_prev_plus_13_ui_repairs_chart_json_v2_seps_ok';
function saveUISelection(workshop, dns){
  if (workshop) localStorage.setItem(UI.wsKey, String(workshop));
  if (dns) localStorage.setItem(UI.dnsKey, String(dns));
}
function saveOpenSeparator(index){ localStorage.setItem(UI.openSepKey, String(index)); }
function getSavedOpenSeparator(){
  const v = localStorage.getItem(UI.openSepKey);
  return v === null ? null : parseInt(v, 10);
}
function saveOpenTab(workshop, dns, sepIdx, tabId){
  localStorage.setItem(UI.openTabKey(workshop, dns, sepIdx), tabId);
}
function getSavedTab(workshop, dns, sepIdx){
  return localStorage.getItem(UI.openTabKey(workshop, dns, sepIdx)) || null;
}

/* =====================
   Theme
===================== */
function applyTheme(theme){
  document.body.classList.toggle("theme-dark", theme === "dark");
  localStorage.setItem(UI.themeKey, theme);
  const btn = document.getElementById("themeBtn");
  btn.textContent = "–¢–µ–º–∞";
  btn.title = (theme === "dark") ? "–°–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞" : "–¢—ë–º–Ω–∞—è —Ç–µ–º–∞";
}
function toggleTheme(){
  const cur = localStorage.getItem(UI.themeKey) || "light";
  applyTheme(cur === "dark" ? "light" : "dark");
}

/* =====================
   Safe storage
===================== */
function safeSetItem(key, value){
  try{ localStorage.setItem(key, value); return true; }
  catch(e){
    console.error("localStorage error:", e);
    alert("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ. –í–æ–∑–º–æ–∂–Ω–æ –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∞ –ø–∞–º—è—Ç—å –±—Ä–∞—É–∑–µ—Ä–∞ (localStorage).");
    return false;
  }
}
function safeGetJSON(key, fallback){
  try{
    const raw = localStorage.getItem(key);
    return raw ? JSON.parse(raw) : fallback;
  }catch(e){
    console.error("JSON parse error:", e);
    return fallback;
  }
}

/* =====================
   Auth / roles
===================== */
const AUTH = { viewer:"1111", editor:"2222", admin:"3333" }; // (–ø–æ–¥—Å–∫–∞–∑–∫—É —É–¥–∞–ª–∏–ª–∏, –Ω–æ –ª–æ–≥–∏–∫–∞ –ø–∞—Ä–æ–ª–µ–π –æ—Å—Ç–∞–ª–∞—Å—å)

// –í–∞–∂–Ω–æ: —á—Ç–æ–±—ã ¬´–æ–¥–∏–Ω HTML –±–µ–∑ —Å–µ—Ä–≤–µ—Ä–∞¬ª –Ω–µ –≤—ã–≥–ª—è–¥–µ–ª ¬´–ø—É—Å—Ç—ã–º¬ª –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏,
// —Ä–æ–ª—å —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage (persist) + –¥—É–±–ª–∏—Ä—É–µ–º –≤ sessionStorage (–±—ã—Å—Ç—Ä—ã–π –¥–æ—Å—Ç—É–ø).
function getRole(){
  return localStorage.getItem("role") || sessionStorage.getItem("role") || "";
}
function setRole(role){
  try{ localStorage.setItem("role", role || ""); }catch(e){}
  try{ sessionStorage.setItem("role", role || ""); }catch(e){}
  const lbl = document.getElementById("roleLabel");
  if (lbl) lbl.innerText = role || "‚Äî";
  const pill = document.getElementById("rolePill");
  if (pill) pill.setAttribute("data-role", role || "");
  applyPermissionsToUI();
}
function login(){
  const pwd = (document.getElementById("authPassword").value || "").trim();
  let role = "";
  if (pwd === AUTH.admin) role = "admin";
  else if (pwd === AUTH.editor) role = "editor";
  else if (pwd === AUTH.viewer) role = "viewer";
  else { alert("–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å"); return; }
  document.getElementById("authOverlay").style.display = "none";
  setRole(role);
  restoreLastSelection();
}
function logout(){
  try{ sessionStorage.removeItem("role"); }catch(e){}
  try{ localStorage.removeItem("role"); }catch(e){}
  document.getElementById("authPassword").value = "";
  try{ ensureWorkshopOptions(); }catch(e){}
  document.getElementById("authOverlay").style.display = "flex";

  document.getElementById("workshopSelect").value = "";
  document.getElementById("dnsSelect").innerHTML = "<option value=''>‚Äî –≤—ã–±—Ä–∞—Ç—å ‚Äî</option>";
  document.getElementById("dnsSelect").disabled = true;

  document.getElementById("statusFilter").value = "all";
  document.getElementById("sepSearch").value = "";

  document.getElementById("title").innerText = "";
  document.getElementById("content").innerHTML = "";
  document.getElementById("dnsSummary").style.display = "none";
  document.getElementById("emptyState").style.display = "block";

  closeRepairList();
  document.getElementById("roleLabel").innerText = "‚Äî";
  document.getElementById("rolePill").setAttribute("data-role","");
  applyPermissionsToUI();
}
function applyPermissionsToUI(){
  const role = getRole();
  const enabled = !!role;

  document.getElementById("workshopSelect").disabled = !enabled;
  document.getElementById("dnsSelect").disabled = !enabled || !document.getElementById("workshopSelect").value;
  document.getElementById("statusFilter").disabled = !enabled;
  document.getElementById("sepSearch").disabled = !enabled;

  const canEdit = (role === "editor" || role === "admin");
  const canDelete = (role === "admin");

  document.querySelectorAll(".status-select").forEach(el => el.disabled = !canEdit);
  document.querySelectorAll("[data-action='add-journal']").forEach(el => el.disabled = !canEdit);
  document.querySelectorAll(".journal textarea, .journal input[type='date'], .journal input[type='file'], .journal input[type='text'], .journal input[type='number']")
    .forEach(el => el.disabled = !canEdit);

  document.querySelectorAll("[data-card-field]").forEach(el => el.disabled = !canEdit);
  document.querySelectorAll("[data-action='save-card']").forEach(el => el.disabled = !canEdit);

  document.querySelectorAll("[data-repair-field]").forEach(el => el.disabled = !canEdit);
  document.querySelectorAll("[data-action='save-repair']").forEach(el => el.disabled = !canEdit);
  document.querySelectorAll("[data-action='close-repair']").forEach(el => el.disabled = !canEdit);
  document.querySelectorAll("[data-epb-field]").forEach(el => el.disabled = !canEdit);
  document.querySelectorAll("[data-action='save-epb']").forEach(el => el.disabled = !canEdit);

  document.getElementById("btnAllWorking").disabled = !canEdit;
  document.getElementById("btnAllRepair").disabled = !canEdit;
  document.getElementById("btnRepairList").disabled = !enabled;

  document.querySelectorAll(".delete-btn").forEach(el => {
    if (el.hasAttribute("data-custom-field")) el.disabled = !canEdit;
    else el.disabled = !canDelete;
  });
}

/* =====================
   Data / constants
===================== */
const WORKSHOP_MAP = {
  "–¶–î–ù–ì-1": {
    "–î–ù–°-6": [
      "–°-1/1",
      "–°-1/2",
      "–°-2/1",
      "–°-2/2",
      "–°-2/3",
      "–°-3/1",
      "–°-3/2"
    ],
    "–î–ù–°-8": [
      "–°-1/1",
      "–°-1/2",
      "–°-2/1",
      "–°-2/2",
      "–°-3/1",
      "–°-3/2"
    ],
    "–î–ù–°-20": [
      "–°-1/1",
      "–°-1/2",
      "–°-2/1",
      "–°-2/2",
      "–°-3/1",
      "–°-3/2"
    ]
  },
  "–¶–î–ù–ì-2": {
    "–î–ù–°-2": [
      "–°-1/1",
      "–°-1/2",
      "–°-2/1",
      "–°-2/2",
      "–°-2/3"
    ],
    "–î–ù–°-4": [
      "–°-1/1",
      "–°-1/2",
      "–ì–°-1",
      "–ì–°-2"
    ],
    "–î–ù–°-19": [
      "–°-1/1",
      "–°-1/2",
      "–°-2/1",
      "–°-2/2"
    ]
  },
  "–¶–î–ù–ì-3": {
    "–î–ù–°-7": [
      "–°-1/1",
      "–°-1/2",
      "–°-2/1",
      "–°-2/2",
      "–°-3/1",
      "–°-3/2"
    ],
    "–î–ù–°-9": [
      "–°-1/1",
      "–°-1/2",
      "–°-2/1",
      "–°-2/2",
      "–°-3/1",
      "–°-3/2"
    ],
    "–î–ù–°-12": [
      "–°-1/1",
      "–°-1/2",
      "–°-2/1",
      "–°-2/2",
      "–°-3/1",
      "–°-3/2"
    ]
  },
  "–¶–î–ù–ì-4": {
    "–î–ù–°-3": [
      "–°-1/1",
      "–°-1/2",
      "–°-2/1",
      "–°-2/2"
    ],
    "–î–ù–°-5": [
      "–°-1/1",
      "–°-1/2",
      "–°-2/1",
      "–°-2/2",
      "–°-3/1",
      "–°-3/2"
    ]
  },
  "–¶–î–ù–ì-5": {
    "–î–ù–°-13": [
      "–°-1/1",
      "–°-1/2",
      "–°-2/1",
      "–°-2/2",
      "–°-3/1",
      "–°-3/2"
    ],
    "–î–ù–°-14": [
      "–°-1/1",
      "–°-1/2",
      "–°-2/1",
      "–°-2/2",
      "–°-3/1",
      "–°-3/2"
    ],
    "–î–ù–°-16": [
      "–°-1",
      "–°-2",
      "–°-3"
    ],
    "–î–ù–°-17": [
      "–°-1/1",
      "–°-1/2",
      "–°-2",
      "–°-3"
    ]
  },
  "–¶–î–ù–ì-6": {
    "–î–ù–°-10": [
      "–°-1/1",
      "–°-1/2",
      "–°-2/1",
      "–°-2/2",
      "–°-3/1",
      "–°-3/2"
    ],
    "–î–ù–°-11": [
      "–°-1/1",
      "–°-1/2",
      "–°-2/1",
      "–°-2/2",
      "–°-3/1",
      "–°-3/2"
    ],
    "–î–ù–°-18": [
      "–°-1/1",
      "–°-1/2",
      "–°-2/1",
      "–°-2/2",
      "–°-3"
    ]
  },
  "–¶–î–ù–ì-8": {
    "–î–ù–°-–ú–∞—Å–ª": [
      "–°-1",
      "–°-2/1",
      "–°-2/2"
    ],
    "–î–ù–°-–ù–∞–∑": [
      "–°-1/1",
      "–°-1/2",
      "–°-2/1",
      "–°-2/2"
    ],
    "–î–ù–°-–°–∞–Ω": [
      "–°-1/1",
      "–°-1/2",
      "–°-2/1",
      "–°-2/2"
    ]
  },
  "–¶–î–ù–ì-9": {
    "–î–ù–°-1 –ó–∞–ø.–ö–∞–º": [
      "–°-1/1",
      "–°-1/2",
      "–°-2/1",
      "–°-2/2"
    ],
    "–î–ù–°-2 –ó–∞–ø.–ö–∞–º": [
      "–°-1/1",
      "–°-1/2",
      "–°-2/1",
      "–°-2/2",
      "–°-3/1"
    ],
    "–î–ù–°-3 –ó–∞–ø.–ö–∞–º": [
      "–°-1/1",
      "–°-1/2",
      "–°-2/1",
      "–°-2/2",
      "–°-3/1"
    ]
  },
  "–¶–î–ù–ì-10": {
    "–î–ù–°-–ó–∞–ø.—Å–∞—Ö": [
      "–°-1/1",
      "–°-1/2",
      "–°-2/1",
      "–°-2/2"
    ]
  },
  "–¶–î–ù–ì-11": {
    "–î–ù–°-–°–µ–≤–°–µ–ª": [
      "–°-1/1",
      "–°-1/2",
      "–°-2/1",
      "–°-2/2"
    ]
  }
};

// –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π —Å–ø–∏—Å–æ–∫ —Å–µ–ø–∞—Ä–∞—Ç–æ—Ä–æ–≤ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–π –î–ù–°
let separators = [];

function getDNSListByWorkshop(workshop){
  return Object.keys(WORKSHOP_MAP[workshop] || {});
}
function getSeparatorsByDNS(workshop, dns){
  return (WORKSHOP_MAP[workshop] && WORKSHOP_MAP[workshop][dns]) ? WORKSHOP_MAP[workshop][dns] : [];
}


/* =====================
   Utils
===================== */
function safeIdPart(str){ return String(str).replace(/[^a-zA-Z0-9]/g, "_"); }
function workshopNum(ws){ const mm = String(ws).match(/\d+/); return mm ? parseInt(mm[0],10) : 0; }
function escapeHtml(s){
  return String(s ?? "")
    .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
    .replaceAll('"',"&quot;").replaceAll("'","&#039;");
}
function todayISO(){
  const d = new Date();
  const yyyy = d.getFullYear();
  const mm = String(d.getMonth()+1).padStart(2,"0");
  const dd = String(d.getDate()).padStart(2,"0");
  return `${yyyy}-${mm}-${dd}`;
}
function daysBetween(a, b){
  const ms = 1000*60*60*24;
  return Math.floor((b.getTime() - a.getTime()) / ms);
}

/* =====================
   Status + repair history
===================== */
function statusKey(workshop, dns, sepName){
  return `sepStatus_${workshop}_${safeIdPart(dns)}_${safeIdPart(sepName)}`;
}
function repairStartKey(workshop, dns, sepName){
  return `repairStart_${workshop}_${safeIdPart(dns)}_${safeIdPart(sepName)}`;
}
function repairHistoryKey(workshop, dns, sepName){
  return `repairHist_${workshop}_${safeIdPart(dns)}_${safeIdPart(sepName)}`;
}
function getStatus(workshop, dns, sepName){
  return localStorage.getItem(statusKey(workshop, dns, sepName)) || "working";
}
function setStatus(workshop, dns, sepName, value){
  safeSetItem(statusKey(workshop, dns, sepName), value);
}
function onRepairStart(workshop, dns, sepName){
  if (!localStorage.getItem(repairStartKey(workshop, dns, sepName))){
    safeSetItem(repairStartKey(workshop, dns, sepName), todayISO());
  }
}
function onRepairEnd(workshop, dns, sepName){
  const startISO = localStorage.getItem(repairStartKey(workshop, dns, sepName));
  if (!startISO) return;

  const start = new Date(startISO);
  const end = new Date(todayISO());
  const dur = Math.max(0, daysBetween(start, end));

  const hist = safeGetJSON(repairHistoryKey(workshop, dns, sepName), []);
  hist.push({start: startISO, end: todayISO(), days: dur, id: Date.now()});
  safeSetItem(repairHistoryKey(workshop, dns, sepName), JSON.stringify(hist));

  localStorage.removeItem(repairStartKey(workshop, dns, sepName));
}
function getRepairHist(workshop, dns, sepName){
  return safeGetJSON(repairHistoryKey(workshop, dns, sepName), []);
}
function getRepairStartISO(workshop, dns, sepName){
  return localStorage.getItem(repairStartKey(workshop, dns, sepName)) || "";
}

/* =====================
   Equipment card + TO
===================== */
function cardKey(workshop, dns, sepName){
  return `card_${workshop}_${safeIdPart(dns)}_${safeIdPart(sepName)}`;
}
function getCard(workshop, dns, sepName){
  return safeGetJSON(cardKey(workshop, dns, sepName), {
    inv: "", serial: "", place: "", resp: "",
    // (legacy) –¢–û –æ—Å—Ç–∞–≤–ª–µ–Ω–æ –≤ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏, –Ω–æ –≤ UI –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º
    nextTO: "", toPeriodDays: 180,

    // –ü–ª–∞–Ω–æ–≤—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏
    nextNVO: "", nvoPeriodDays: 1,
    nextGI: "", giPeriodDays: 1,

    // –î–æ–ø. –ø–∞—Ä–∞–º–µ—Ç—Ä—ã (–Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç admin/editor)
    customValues: {}
  });
}


// =====================
// Custom parameters for equipment card (admin/editor)
// =====================
const CUSTOM_CARD_FIELDS_KEY = "custom_card_fields_v1";

function getCustomCardFields(){
  const fields = safeGetJSON(CUSTOM_CARD_FIELDS_KEY, []);
  return Array.isArray(fields) ? fields : [];
}
function saveCustomCardFields(fields){
  safeSetItem(CUSTOM_CARD_FIELDS_KEY, JSON.stringify(fields));
}
function normKey(s){
  return String(s||"")
    .trim()
    .toLowerCase()
    .replace(/\s+/g,"_")
    .replace(/[^a-z0-9_\-]/g,"")
    .slice(0, 32);
}

function renderCustomCardRows(card, workshop, dns, index){
  const dnsSafe = safeIdPart(dns);
  const fields = getCustomCardFields();
  if (!fields.length) return "";
  const values = (card && card.customValues) ? card.customValues : {};

  return fields.map(f => {
    const key = f.key;
    const label = (f.label || key);
    const unit = (f.unit || "").trim();
    const type = (f.type === "number") ? "number" : "text";
    const val = (values && values[key] != null) ? String(values[key]) : "";
    const labelText = unit ? `${label} (${unit})` : label;
    const width = type === "number" ? "160px" : "100%";

    return `
      <tr>
        <td>${escapeHtml(labelText)}</td>
        <td>
          <input data-card-field type="${type}" id="cardCustom_${key}_${workshop}_${dnsSafe}_${index}" style="width:${width}; padding:10px; border-radius:12px; border:1px solid var(--border); background:var(--panel); color:var(--text);" value="${escapeHtml(val)}">
        </td>
      </tr>`;
  }).join("");
}

function renderCustomFieldsSettings(){
  const box = document.getElementById("customFieldsSettingsBox");
  if (!box) return;

  const role = getRole();
  const canEdit = (role === "editor" || role === "admin");
  if (!canEdit){
    box.innerHTML = `<div class="smalltext">–î–æ—Å—Ç—É–ø–Ω–æ –¥–ª—è —Ä–æ–ª–∏ <b>editor</b> –∏–ª–∏ <b>admin</b>.</div>`;
    return;
  }

  const fields = getCustomCardFields();
  const rows = fields.map((f, i) => {
    return `
      <tr>
        <td style="width:36px;">${i+1}</td>
        <td><span class="pill">${escapeHtml(f.key)}</span></td>
        <td>${escapeHtml(f.label || "")}</td>
        <td>${escapeHtml(f.type || "text")}</td>
        <td>${escapeHtml(f.unit || "")}</td>
        <td style="width:120px;">
          <button class="delete-btn" data-custom-field onclick="deleteCustomField('${escapeHtml(f.key)}')">–£–¥–∞–ª–∏—Ç—å</button>
        </td>
      </tr>`;
  }).join("");

  box.innerHTML = `
    <div style="display:grid; gap:8px;">
      <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:end;">
        <div style="flex:1; min-width:200px;">
          <div class="smalltext" style="margin-bottom:4px;"><b>–ù–∞–∑–≤–∞–Ω–∏–µ</b></div>
          <input id="cfLabel" type="text" placeholder="–ù–∞–ø—Ä.: –î–∞–≤–ª–µ–Ω–∏–µ, –ú–ü–∞" style="width:100%; padding:10px; border-radius:12px; border:1px solid var(--border); background:var(--panel); color:var(--text);">
        </div>
        <div style="width:160px;">
          <div class="smalltext" style="margin-bottom:4px;"><b>–ö–æ–¥</b> (–ª–∞—Ç–∏–Ω–∏—Ü–∞)</div>
          <input id="cfKey" type="text" placeholder="pressure" style="width:100%; padding:10px; border-radius:12px; border:1px solid var(--border); background:var(--panel); color:var(--text);">
        </div>
        <div style="width:150px;">
          <div class="smalltext" style="margin-bottom:4px;"><b>–¢–∏–ø</b></div>
          <select id="cfType" style="width:100%; padding:10px; border-radius:12px; border:1px solid var(--border); background:var(--panel); color:var(--text);">
            <option value="text">–¢–µ–∫—Å—Ç</option>
            <option value="number">–ß–∏—Å–ª–æ</option>
          </select>
        </div>
        <div style="width:150px;">
          <div class="smalltext" style="margin-bottom:4px;"><b>–ï–¥.</b></div>
          <input id="cfUnit" type="text" placeholder="–ú–ü–∞" style="width:100%; padding:10px; border-radius:12px; border:1px solid var(--border); background:var(--panel); color:var(--text);">
        </div>
        <button class="pdf-btn" style="margin-top:0;" data-custom-field onclick="addCustomField()">–î–æ–±–∞–≤–∏—Ç—å</button>
      </div>

      <div class="smalltext">–ü–æ–ª—è –¥–æ–±–∞–≤—è—Ç—Å—è –≤ –≤–∫–ª–∞–¥–∫—É ¬´–ü–∞—Å–ø–æ—Ä—Ç¬ª –¥–ª—è –≤—Å–µ—Ö —Å–µ–ø–∞—Ä–∞—Ç–æ—Ä–æ–≤. –ó–Ω–∞—á–µ–Ω–∏—è —Ö—Ä–∞–Ω—è—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å–µ–ø–∞—Ä–∞—Ç–æ—Ä–∞.</div>

      <table>
        <tr><th>#</th><th>–ö–æ–¥</th><th>–ù–∞–∑–≤–∞–Ω–∏–µ</th><th>–¢–∏–ø</th><th>–ï–¥.</th><th>–î–µ–π—Å—Ç–≤–∏–µ</th></tr>
        ${rows || '<tr><td colspan="6" class="smalltext">–ü–æ–∫–∞ –Ω–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π.</td></tr>'}
      </table>
    </div>
  `;

  applyPermissionsToUI();
}

function addCustomField(){
  const role = getRole();
  if (!(role === "editor" || role === "admin")){
    alert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤");
    return;
  }
  const label = (document.getElementById("cfLabel")?.value || "").trim();
  let key = (document.getElementById("cfKey")?.value || "").trim();
  const type = (document.getElementById("cfType")?.value || "text").trim();
  const unit = (document.getElementById("cfUnit")?.value || "").trim();

  if (!label){
    alert("–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞");
    return;
  }
  if (!key) key = normKey(label);
  key = normKey(key);
  if (!key){
    alert("–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –∫–æ–¥ (–ª–∞—Ç–∏–Ω–∏—Ü–∞/—Ü–∏—Ñ—Ä—ã/_)\n–ù–∞–ø—Ä–∏–º–µ—Ä: pressure");
    return;
  }

  const fields = getCustomCardFields();
  if (fields.some(f => f.key === key)){
    alert("–ü–æ–ª–µ —Å —Ç–∞–∫–∏–º –∫–æ–¥–æ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç");
    return;
  }

  fields.push({ key, label, type: (type === "number" ? "number" : "text"), unit });
  saveCustomCardFields(fields);

  // reset inputs
  ["cfLabel","cfKey","cfUnit"].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.value = "";
  });

  renderCustomFieldsSettings();
  // –ø–µ—Ä–µ—Ä–∏—Å—É–µ–º —Ç–µ–∫—É—â—É—é –î–ù–°, —á—Ç–æ–±—ã –ø–æ–ª—è –ø–æ—è–≤–∏–ª–∏—Å—å –≤ –∫–∞—Ä—Ç–æ—á–∫–∞—Ö
  applyFilter();
}

function deleteCustomField(key){
  const role = getRole();
  if (!(role === "editor" || role === "admin")){
    alert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤");
    return;
  }
  if (!confirm(`–£–¥–∞–ª–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä "${key}"?`)) return;
  const fields = getCustomCardFields().filter(f => f.key !== key);
  saveCustomCardFields(fields);
  renderCustomFieldsSettings();
  applyFilter();
}
function saveCard(workshop, dns, sepName, index){
  const role = getRole();
  if (!(role === "editor" || role === "admin")){
    alert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–∞—Ä—Ç–æ—á–∫–∏");
    return;
  }
  const dnsSafe = safeIdPart(dns);

  const inv = document.getElementById(`cardInv_${workshop}_${dnsSafe}_${index}`)?.value || "";
  const serial = document.getElementById(`cardSerial_${workshop}_${dnsSafe}_${index}`)?.value || "";
  const place = document.getElementById(`cardPlace_${workshop}_${dnsSafe}_${index}`)?.value || "";
  const resp = document.getElementById(`cardResp_${workshop}_${dnsSafe}_${index}`)?.value || "";

  // –ü–ª–∞–Ω–æ–≤—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ (–ù–í–û / –ì–ò)
  const nextNVO = document.getElementById(`cardNextNVO_${workshop}_${dnsSafe}_${index}`)?.value || "";
  const nvoPeriodDays = parseInt(document.getElementById(`cardNVOPeriod_${workshop}_${dnsSafe}_${index}`)?.value || "1", 10);
  const nextGI = document.getElementById(`cardNextGI_${workshop}_${dnsSafe}_${index}`)?.value || "";
  const giPeriodDays = parseInt(document.getElementById(`cardGIPeriod_${workshop}_${dnsSafe}_${index}`)?.value || "1", 10);

  // legacy: –ø–æ–ª—è –¢–û –æ—Å—Ç–∞–≤–ª—è–µ–º –≤ –¥–∞–Ω–Ω—ã—Ö (—Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å–æ —Å—Ç–∞—Ä—ã–º–∏ –≤–µ—Ä—Å–∏—è–º–∏)
  const prev = getCard(workshop, dns, sepName);
  const nextTO = prev.nextTO || "";
  const toPeriodDays = parseInt(prev.toPeriodDays || 180, 10);

  // –î–æ–ø. –ø–∞—Ä–∞–º–µ—Ç—Ä—ã (–Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—é—Ç—Å—è admin/editor)
  const customValues = Object.assign({}, prev.customValues || {});
  getCustomCardFields().forEach(f => {
    const el = document.getElementById(`cardCustom_${f.key}_${workshop}_${dnsSafe}_${index}`);
    if (!el) return;
    customValues[f.key] = el.value;
  });

  const ok = safeSetItem(cardKey(workshop, dns, sepName), JSON.stringify({
    inv, serial, place, resp,
    nextTO, toPeriodDays,
    nextNVO, nvoPeriodDays,
    nextGI, giPeriodDays,
    customValues
  }));
  if (!ok) return;

  alert("–ö–∞—Ä—Ç–æ—á–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞");
  renderSummary(workshop, dns);
  applyFilter();
}
function computeTOStatus(card){
  if (!card.nextTO) return {state:"none", daysTo:null};
  const t = new Date(card.nextTO);
  const now = new Date(todayISO());
  const daysTo = daysBetween(now, t);
  if (daysTo < 0) return {state:"overdue", daysTo};
  if (daysTo <= 7) return {state:"soon", daysTo};
  return {state:"ok", daysTo};
}

/* =====================
   Repair card
===================== */
function repairCardKey(workshop, dns, sepName){
  return `repairCard_${workshop}_${safeIdPart(dns)}_${safeIdPart(sepName)}`;
}
function getRepairCard(workshop, dns, sepName){
  return safeGetJSON(repairCardKey(workshop, dns, sepName), {
    start: "", end: "", reason: "", team: "", doc: "", downtime: "", cost: "", savedAt: ""
  });
}
function saveRepairCard(workshop, dns, sepName, index){
  const role = getRole();
  if (!(role === "editor" || role === "admin")){
    alert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤ (–Ω—É–∂–µ–Ω editor/admin)");
    return;
  }
  const dnsSafe = safeIdPart(dns);
  const data = {
    start: document.getElementById(`repairStart_${workshop}_${dnsSafe}_${index}`)?.value || "",
    end: document.getElementById(`repairEnd_${workshop}_${dnsSafe}_${index}`)?.value || "",
    reason: document.getElementById(`repairReason_${workshop}_${dnsSafe}_${index}`)?.value || "",
    team: document.getElementById(`repairTeam_${workshop}_${dnsSafe}_${index}`)?.value || "",
    doc: document.getElementById(`repairDoc_${workshop}_${dnsSafe}_${index}`)?.value || "",
    downtime: document.getElementById(`repairDowntime_${workshop}_${dnsSafe}_${index}`)?.value || "",
    cost: document.getElementById(`repairCost_${workshop}_${dnsSafe}_${index}`)?.value || "",
    savedAt: todayISO()
  };
  const ok = safeSetItem(repairCardKey(workshop, dns, sepName), JSON.stringify(data));
  if (!ok) return;

  updateRepairInfoLine(workshop, dns, sepName, index);
  renderSummary(workshop, dns);
  if (document.getElementById("repairListOverlay").style.display !== "none") refreshRepairList();
  alert("–î–∞–Ω–Ω—ã–µ —Ä–µ–º–æ–Ω—Ç–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã ‚úÖ");
}
function fillRepairCardUI(workshop, dns, sepName, index){
  const dnsSafe = safeIdPart(dns);
  const rc = getRepairCard(workshop, dns, sepName);
  const setVal = (id, v) => { const el = document.getElementById(id); if (el) el.value = v || ""; };
  setVal(`repairStart_${workshop}_${dnsSafe}_${index}`, rc.start);
  setVal(`repairEnd_${workshop}_${dnsSafe}_${index}`, rc.end);
  setVal(`repairReason_${workshop}_${dnsSafe}_${index}`, rc.reason);
  setVal(`repairTeam_${workshop}_${dnsSafe}_${index}`, rc.team);
  setVal(`repairDoc_${workshop}_${dnsSafe}_${index}`, rc.doc);
  setVal(`repairDowntime_${workshop}_${dnsSafe}_${index}`, rc.downtime);
  setVal(`repairCost_${workshop}_${dnsSafe}_${index}`, rc.cost);

  const st = getStatus(workshop, dns, sepName);
  const autoStart = getRepairStartISO(workshop, dns, sepName);
  if (st === "repair" && autoStart && !rc.start){
    rc.start = autoStart;
    safeSetItem(repairCardKey(workshop, dns, sepName), JSON.stringify(rc));
    setVal(`repairStart_${workshop}_${dnsSafe}_${index}`, rc.start);
  }
  updateRepairInfoLine(workshop, dns, sepName, index);
}
function updateRepairInfoLine(workshop, dns, sepName, index){
  const dnsSafe = safeIdPart(dns);
  const el = document.getElementById(`repairInfo_${workshop}_${dnsSafe}_${index}`);
  if (!el) return;

  const st = getStatus(workshop, dns, sepName);
  const startISO = getRepairStartISO(workshop, dns, sepName);

  if (st === "repair"){
    if (startISO){
      const d = daysBetween(new Date(startISO), new Date(todayISO()));
      el.textContent = `–í —Ä–µ–º–æ–Ω—Ç–µ ${Math.max(0,d)} –¥–Ω (—Å ${startISO})`;
    }else{
      el.textContent = "–í —Ä–µ–º–æ–Ω—Ç–µ (–Ω–µ—Ç –¥–∞—Ç—ã –Ω–∞—á–∞–ª–∞)";
    }
  }else{
    el.textContent = "–í —Ä–∞–±–æ—Ç–µ";
  }
}
function closeRepair(workshop, dns, sepName, index){
  const role = getRole();
  if (!(role === "editor" || role === "admin")){
    alert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤");
    return;
  }
  const dnsSafe = safeIdPart(dns);
  const endEl = document.getElementById(`repairEnd_${workshop}_${dnsSafe}_${index}`);
  if (endEl && !endEl.value) endEl.value = todayISO();
  saveRepairCard(workshop, dns, sepName, index);
  onStatusChange(workshop, dns, sepName, index, "working");
}

/* =====================
   EPB (–≠–∫—Å–ø–µ—Ä—Ç–∏–∑–∞ –ø—Ä–æ–º—ã—à–ª–µ–Ω–Ω–æ–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏)
===================== */
function epbKey(workshop, dns, sepName){
  return `epb_${workshop}_${safeIdPart(dns)}_${safeIdPart(sepName)}`;
}
function getEpb(workshop, dns, sepName){
  return safeGetJSON(epbKey(workshop, dns, sepName), {
    date:"", result:"", extendDays:"", pdfData:"", pdfName:"", savedAt:""
  });
}
function updateEpbBadge(workshop, dns, sepName, index){
  const dnsSafe = safeIdPart(dns);
  const res = document.getElementById(`epbResult_${workshop}_${dnsSafe}_${index}`)?.value || "";
  const badge = document.getElementById(`epbBadge_${workshop}_${dnsSafe}_${index}`);
  if (!badge) return;
  if (res === "positive"){
    badge.textContent = "–≠–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏—è —Ä–∞–∑—Ä–µ—à–µ–Ω–∞";
    badge.style.borderColor = "color-mix(in srgb, var(--ok) 55%, var(--border))";
  } else if (res === "negative"){
    badge.textContent = "–≠–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏—è –∑–∞–ø—Ä–µ—â–µ–Ω–∞";
    badge.style.borderColor = "color-mix(in srgb, var(--bad) 55%, var(--border))";
  } else {
    badge.textContent = "‚Äî";
    badge.style.borderColor = "var(--border)";
  }
}
async function saveEpb(workshop, dns, sepName, index){
  const role = getRole();
  if (!(role === "editor" || role === "admin")){
    alert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤ (–Ω—É–∂–µ–Ω editor/admin)");
    return;
  }
  const dnsSafe = safeIdPart(dns);

  const date = document.getElementById(`epbDate_${workshop}_${dnsSafe}_${index}`)?.value || "";
  const result = document.getElementById(`epbResult_${workshop}_${dnsSafe}_${index}`)?.value || "";
  const extendDays = document.getElementById(`epbExtend_${workshop}_${dnsSafe}_${index}`)?.value || "";

  const fileEl = document.getElementById(`epbFile_${workshop}_${dnsSafe}_${index}`);
  const cur = getEpb(workshop, dns, sepName);

  let pdfData = cur.pdfData || "";
  let pdfName = cur.pdfName || "";

  try{
    const f = fileEl?.files?.[0];
    if (f){
      pdfData = await readFileAsDataURL(f);
      pdfName = f.name || "epb.pdf";
    }
  }catch(e){
    alert("–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å PDF");
    return;
  }

  const data = { date, result, extendDays, pdfData, pdfName, savedAt: todayISO() };
  const ok = safeSetItem(epbKey(workshop, dns, sepName), JSON.stringify(data));
  if (!ok) return;

  fillEpbUI(workshop, dns, sepName, index);
  renderSummary(workshop, dns);
  alert("–≠–ü–ë —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ ‚úÖ");
}
function openEpbPdf(workshop, dns, sepName, index){
  const epb = getEpb(workshop, dns, sepName);
  if (!epb.pdfData){
    alert("PDF –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω");
    return;
  }
  const w = window.open();
  if (!w) return;
  w.document.write(`<title>–≠–ü–ë ‚Äî ${escapeHtml(sepName)}</title>
    <iframe src="${epb.pdfData}" style="width:100%;height:100vh;border:0;"></iframe>`);
}
function fillEpbUI(workshop, dns, sepName, index){
  const dnsSafe = safeIdPart(dns);
  const epb = getEpb(workshop, dns, sepName);

  const setVal = (id, v)=>{ const el=document.getElementById(id); if (el) el.value = v || ""; };
  setVal(`epbDate_${workshop}_${dnsSafe}_${index}`, epb.date);
  setVal(`epbResult_${workshop}_${dnsSafe}_${index}`, epb.result);
  setVal(`epbExtend_${workshop}_${dnsSafe}_${index}`, epb.extendDays);

  updateEpbBadge(workshop, dns, sepName, index);

  const nameEl = document.getElementById(`epbFileName_${workshop}_${dnsSafe}_${index}`);
  if (nameEl) nameEl.textContent = `–§–∞–π–ª: ${epb.pdfName || "‚Äî"}`;

  const openBtn = document.getElementById(`epbOpenBtn_${workshop}_${dnsSafe}_${index}`);
  if (openBtn) openBtn.disabled = !epb.pdfData;

  applyPermissionsToUI();
}

/* =====================
   Journals + tab counters
===================== */
function journalKey(workshop, dns, separator, type){
  return `journal_${workshop}_${safeIdPart(dns)}_${safeIdPart(separator)}_${type || "r"}`;
}
function journalCount(workshop, dns, separator, type){
  const j = safeGetJSON(journalKey(workshop, dns, separator, type), []);
  return j.length || 0;
}
function readFileAsDataURL(file){
  return new Promise((resolve, reject) => {
    const r = new FileReader();
    r.onload = () => resolve(r.result);
    r.onerror = reject;
    r.readAsDataURL(file);
  });
}
function lastEntryDate(workshop, dns, separator, type){
  const journal = safeGetJSON(journalKey(workshop, dns, separator, type), []);
  if (!journal.length) return null;
  return new Date(journal[journal.length - 1].date);
}
async function addJournalEntry(workshop, dns, separator, index, type=''){
  const role = getRole();
  if (!(role === "editor" || role === "admin")){
    alert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∑–∞–ø–∏—Å–∏");
    return;
  }
  const dnsSafe = safeIdPart(dns);
  const prefix = type ? `${type}s` : `s`;

  const dateEl = document.getElementById(`journalDate_${prefix}${workshop}${dnsSafe}${index}`);
  const textEl = document.getElementById(`journalText_${prefix}${workshop}${dnsSafe}${index}`);
  const cmtEl  = document.getElementById(`journalComment_${prefix}${workshop}${dnsSafe}${index}`);
  const fileEl = document.getElementById(`journalPhoto_${prefix}${workshop}${dnsSafe}${index}`);

  const zoneEl = (type === "n") ? document.getElementById(`journalZone_${prefix}${workshop}${dnsSafe}${index}`) : null;
  const sevEl  = (type === "n") ? document.getElementById(`journalSev_${prefix}${workshop}${dnsSafe}${index}`)  : null;

  if(!dateEl?.value || !textEl?.value.trim()){
    alert("–í–≤–µ–¥–∏—Ç–µ –¥–∞—Ç—É –∏ –æ–ø–∏—Å–∞–Ω–∏–µ");
    return;
  }

  let photoData = "";
  try{
    const f = fileEl?.files?.[0];
    if (f) photoData = await readFileAsDataURL(f);
  }catch(e){
    alert("–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å —Ñ–æ—Ç–æ");
    return;
  }

  const key = journalKey(workshop, dns, separator, type);
  const journal = safeGetJSON(key, []);
  journal.push({ date: dateEl.value, text: textEl.value.trim(), comment:(cmtEl?.value||"").trim(), photo:photoData, zone:(zoneEl?.value||""), sev: parseInt(sevEl?.value||"2",10), id:Date.now() });

  const ok = safeSetItem(key, JSON.stringify(journal));
  if (!ok) return;

  renderJournal(workshop, dns, separator, index, type);

  textEl.value = "";
  if (cmtEl) cmtEl.value = "";
  if (fileEl) fileEl.value = "";

  const sepEl = document.querySelector(`.separator[data-sep-index="${index}"]`);
  syncSeparatorHeight(sepEl);

  const baseSep = (separator.endsWith("_n") || separator.endsWith("_g")) ? separator.slice(0, -2) : separator;
  markInspectOverdueOutline(workshop, dns, baseSep, index);

  updateTabCounts(workshop, dns, index, baseSep);
  renderSummary(workshop, dns);
  applyPermissionsToUI();
}
function renderJournal(workshop, dns, separator, index, type=''){
  const dnsSafe = safeIdPart(dns);
  const prefix = type ? `${type}s` : `s`;
  const tableEl = document.getElementById(`journalTable_${prefix}${workshop}${dnsSafe}${index}`);
  if (!tableEl) return;

  const journal = safeGetJSON(journalKey(workshop, dns, separator, type), []);
  tableEl.innerHTML = (type==="n")
    ? "<tr><th>–î–∞—Ç–∞</th><th>–û–ø–∏—Å–∞–Ω–∏–µ</th><th>–ó–æ–Ω–∞</th><th>–í–∞–∂–Ω.</th><th>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</th><th>–§–æ—Ç–æ</th><th>–î–µ–π—Å—Ç–≤–∏–µ</th></tr>"
    : "<tr><th>–î–∞—Ç–∞</th><th>–û–ø–∏—Å–∞–Ω–∏–µ</th><th>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</th><th>–§–æ—Ç–æ</th><th>–î–µ–π—Å—Ç–≤–∏–µ</th></tr>";

  journal.forEach((entry, i) => {
    const tr = document.createElement("tr");
    const highlight = i >= journal.length - 3 ? 'style="background:color-mix(in srgb, #38bdf8 12%, transparent);"' : "";
    const photoCell = entry.photo
      ? `<img class="thumb" src="${entry.photo}" alt="photo" onclick="openPhoto('${entry.id}','${escapeHtml(separator)}','${escapeHtml(type)}','${workshop}','${escapeHtml(dns)}')">`
      : `<span class="smalltext">‚Äî</span>`;

    tr.innerHTML = (type==="n") ? `
      <td ${highlight}>${escapeHtml(entry.date)}</td>
      <td ${highlight}>${escapeHtml(entry.text)}</td>
      <td ${highlight}>${escapeHtml(entry.zone || inferZoneFromText((entry.text||"") + " " + (entry.comment||"")))}</td>
      <td ${highlight}>${escapeHtml(String(entry.sev ?? 2))}</td>
      <td ${highlight}>${escapeHtml(entry.comment || "")}</td>
      <td ${highlight}>${photoCell}</td>
      <td><button class="delete-btn" onclick="deleteJournalEntry('${workshop}','${dns}','${separator}',${index},'${type}',${entry.id})">–£–¥–∞–ª–∏—Ç—å</button></td>
    ` : `
      <td ${highlight}>${escapeHtml(entry.date)}</td>
      <td ${highlight}>${escapeHtml(entry.text)}</td>
      <td ${highlight}>${escapeHtml(entry.comment || "")}</td>
      <td ${highlight}>${photoCell}</td>
      <td><button class="delete-btn" onclick="deleteJournalEntry('${workshop}','${dns}','${separator}',${index},'${type}',${entry.id})">–£–¥–∞–ª–∏—Ç—å</button></td>
    `;
    tableEl.appendChild(tr);
  });

  applyPermissionsToUI();
}
function openPhoto(id, separator, type, workshop, dns){
  const journal = safeGetJSON(journalKey(workshop, dns, separator, type), []);
  const entry = journal.find(e => String(e.id) === String(id));
  if (!entry?.photo) return;
  const w = window.open();
  if (!w) return;
  w.document.write(`<title>–§–æ—Ç–æ</title><img src="${entry.photo}" style="max-width:100%;height:auto;">`);
}
function deleteJournalEntry(workshop, dns, separator, index, type, id){
  const role = getRole();
  if (role !== "admin"){
    alert("–£–¥–∞–ª–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É");
    return;
  }
  const key = journalKey(workshop, dns, separator, type);
  let journal = safeGetJSON(key, []);
  journal = journal.filter(e => e.id !== id);

  const ok = safeSetItem(key, JSON.stringify(journal));
  if (!ok) return;

  renderJournal(workshop, dns, separator, index, type);

  const sepEl = document.querySelector(`.separator[data-sep-index="${index}"]`);
  syncSeparatorHeight(sepEl);

  const baseSep = (separator.endsWith("_n") || separator.endsWith("_g")) ? separator.slice(0, -2) : separator;
  markInspectOverdueOutline(workshop, dns, baseSep, index);

  updateTabCounts(workshop, dns, index, baseSep);
  renderSummary(workshop, dns);
}
function updateTabCounts(workshop, dns, index, sepName){
  const dnsSafe = safeIdPart(dns);

  const btnRepair = document.getElementById(`tabBtn_repair_${workshop}_${dnsSafe}_${index}`);
  const btnNvo    = document.getElementById(`tabBtn_nvo_${workshop}_${dnsSafe}_${index}`);
  const btnGi     = document.getElementById(`tabBtn_gi_${workshop}_${dnsSafe}_${index}`);

  const cRepair = journalCount(workshop, dns, sepName, "");
  const cNvo    = journalCount(workshop, dns, sepName + "_n", "n");
  const cGi     = journalCount(workshop, dns, sepName + "_g", "g");

  if (btnRepair) btnRepair.querySelector(".tab-count").textContent = String(cRepair);
  if (btnNvo)    btnNvo.querySelector(".tab-count").textContent = String(cNvo);
  if (btnGi)     btnGi.querySelector(".tab-count").textContent = String(cGi);
}


/* =====================
   Chips helpers
===================== */
function toChipHTML(to){
  if (to.state === "overdue") return `<span class="chip bad" title="–¢–û –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–æ"><strong>–¢–û</strong></span>`;
  if (to.state === "soon")    return `<span class="chip warn" title="–¢–û —Å–∫–æ—Ä–æ"><strong>–¢–û —Å–∫–æ—Ä–æ</strong></span>`;
  if (to.state === "ok")      return `<span class="chip ok" title="–¢–û –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ"><strong>–¢–û</strong></span>`;
  return `<span class="chip" title="–¢–û –Ω–µ –∑–∞–¥–∞–Ω–æ"><strong>–¢–û?</strong></span>`;
}
function nvoChipHTML(days){
  if (days === null) return `<span class="chip bad" title="–ù–í–û: –Ω–µ—Ç –∑–∞–ø–∏—Å–µ–π"><strong>–ù–í–û</strong></span>`;
  if (days > 1)     return `<span class="chip bad" title="–ù–í–û –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–æ"><strong>–ù–í–û ${days}–¥</strong></span>`;
  return `<span class="chip ok" title="–ù–í–û –∞–∫—Ç—É–∞–ª—å–Ω–æ"><strong>–ù–í–û</strong></span>`;
}
function giChipHTML(days){
  if (days === null) return `<span class="chip bad" title="–ì–ò: –Ω–µ—Ç –∑–∞–ø–∏—Å–µ–π"><strong>–ì–ò</strong></span>`;
  if (days > 1)     return `<span class="chip bad" title="–ì–ò –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–æ"><strong>–ì–ò ${days}–¥</strong></span>`;
  return `<span class="chip ok" title="–ì–ò –∞–∫—Ç—É–∞–ª—å–Ω–æ"><strong>–ì–ò</strong></span>`;
}
function epbChipHTML(result){
  if (result === "positive") return `<span class="chip ok" title="–≠–ü–ë: —ç–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏—è —Ä–∞–∑—Ä–µ—à–µ–Ω–∞"><strong>–≠–ü–ë OK</strong></span>`;
  if (result === "negative") return `<span class="chip bad" title="–≠–ü–ë: —ç–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏—è –∑–∞–ø—Ä–µ—â–µ–Ω–∞"><strong>–≠–ü–ë</strong></span>`;
  return `<span class="chip" title="–≠–ü–ë –Ω–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–∞"><strong>–≠–ü–ë?</strong></span>`;
}
function repairChipHTML(workshop, dns, sepName){
  const st = getStatus(workshop, dns, sepName);
  if (st !== "repair") return "";
  const startISO = getRepairStartISO(workshop, dns, sepName);
  if (!startISO) return `<span class="chip warn"><strong>–†–µ–º–æ–Ω—Ç</strong></span>`;
  const d = Math.max(0, daysBetween(new Date(startISO), new Date(todayISO())));
  return `<span class="chip warn"><strong>${d}–¥</strong></span>`;
}

/* =====================
   Tabs + open state
===================== */
function syncSeparatorHeight(separatorEl){
  const body = separatorEl?.querySelector(".separator-body");
  if (!body) return;
  if (!body.style.maxHeight || body.style.maxHeight === "0px") return;
  body.style.maxHeight = body.scrollHeight + "px";
}
function activateTabWithin(separatorEl, tabId, persist=true){
  const body = separatorEl.querySelector(".separator-body");
  body.querySelectorAll(".tab-content").forEach(c => c.classList.remove("active"));
  body.querySelectorAll(".tab-button").forEach(b => b.classList.remove("active"));

  const content = body.querySelector("#" + tabId);
  if (content) content.classList.add("active");

  const btn = Array.from(body.querySelectorAll(".tab-button"))
    .find(b => b.getAttribute("data-tab") === tabId);
  if (btn) btn.classList.add("active");

  if (persist){
    const ws = document.getElementById("workshopSelect").value;
    const dns = document.getElementById("dnsSelect").value;
    const sepIdx = parseInt(separatorEl.getAttribute("data-sep-index"),10);
    saveOpenTab(ws, dns, sepIdx, tabId);
  }
}
function toggleSeparator(headerEl){
  const sepEl = headerEl.closest(".separator");
  const body = sepEl.querySelector(".separator-body");
  const isOpen = body.style.maxHeight && body.style.maxHeight !== "0px";
  if (isOpen){ body.style.maxHeight = "0px"; return; }
  document.querySelectorAll(".separator .separator-body").forEach(b => b.style.maxHeight = "0px");
  openSeparator(sepEl, true);
}
function openSeparator(sepEl, persist){
  const body = sepEl.querySelector(".separator-body");
  const ws = document.getElementById("workshopSelect").value;
  const dns = document.getElementById("dnsSelect").value;
  const sepIdx = parseInt(sepEl.getAttribute("data-sep-index"),10);

  const savedTab = getSavedTab(ws, dns, sepIdx);
  const firstBtn = sepEl.querySelector(".tab-button");
  const tabId = savedTab || (firstBtn ? firstBtn.getAttribute("data-tab") : null);
  if (tabId) activateTabWithin(sepEl, tabId, !!persist);

  body.style.maxHeight = body.scrollHeight + "px";
  if (persist) saveOpenSeparator(sepIdx);
}
function openTab(evt, tabId){
  evt.preventDefault();
  const sepEl = evt.target.closest(".separator");
  activateTabWithin(sepEl, tabId, true);
  syncSeparatorHeight(sepEl);
  saveOpenSeparator(parseInt(sepEl.getAttribute("data-sep-index"),10));
}

/* =====================
   NVO / GI marker
===================== */
function computeNvoDays(workshop, dns, sepName){
  const last = lastEntryDate(workshop, dns, sepName + "_n", "n");
  if (!last) return null;
  const now = new Date(todayISO());
  return Math.max(0, daysBetween(last, now));
}
function computeGiDays(workshop, dns, sepName){
  const last = lastEntryDate(workshop, dns, sepName + "_g", "g");
  if (!last) return null;
  const now = new Date(todayISO());
  return Math.max(0, daysBetween(last, now));
}
// –ø—Ä–æ—Å—Ä–æ—á–∫–∞ = –±–æ–ª—å—à–µ 1 –¥–Ω—è (–Ω–æ—Ä–º–∞ 1 –¥–µ–Ω—å)
function markInspectOverdueOutline(workshop, dns, sepName, index){
  const sepEl = document.querySelector(`.separator[data-sep-index="${index}"]`);
  if (!sepEl) return;
  const nDays = computeNvoDays(workshop, dns, sepName);
  const gDays = computeGiDays(workshop, dns, sepName);
  const bad = (nDays === null || nDays > 1) || (gDays === null || gDays > 1);
  sepEl.setAttribute("data-inspect", bad ? "bad" : "ok");
}

/* =====================
   KPI animations + sparklines
===================== */
function animateNumber(el, to, suffix=""){
  const from = 0;
  const duration = 520;
  const start = performance.now();
  function step(t){
    const p = Math.min(1, (t - start)/duration);
    const eased = 1 - Math.pow(1-p, 3);
    const val = from + (to - from) * eased;
    el.textContent = (Number.isInteger(to) ? Math.round(val) : val.toFixed(1)) + suffix;
    if (p < 1) requestAnimationFrame(step);
  }
  requestAnimationFrame(step);
}
function buildSpark(svgEl, values){
  if (!svgEl) return;
  svgEl.innerHTML = "";
  if (!values || values.length < 2){
    svgEl.innerHTML = `<polyline points="0,20 72,20"></polyline>`;
    return;
  }
  const w=72, h=26, pad=3;
  const min=Math.min(...values), max=Math.max(...values);
  const span=(max-min)||1;

  const pts = values.map((v,i)=>{
    const x = pad + (i*(w-pad*2))/(values.length-1);
    const y = (h-pad) - ((v-min)/span)*(h-pad*2);
    return `${x.toFixed(1)},${y.toFixed(1)}`;
  }).join(" ");

  const pl = document.createElementNS("http://www.w3.org/2000/svg","polyline");
  pl.setAttribute("points", pts);
  svgEl.appendChild(pl);
}


/* =====================
   Forecast helpers (NVO-based)
===================== */
const ZONES = [
  {id:"sh1", title:"–û–±–µ—á–∞–π–∫–∞ 1", keys:["–æ–±–µ—á–∞–π–∫–∞ 1","–æ–±–µ—á 1","1 –æ–±–µ—á","–æ–±–µ—á1","—Å–µ–∫—Ü–∏—è 1","1 —Å–µ–∫—Ü–∏—è"]},
  {id:"sh2", title:"–û–±–µ—á–∞–π–∫–∞ 2", keys:["–æ–±–µ—á–∞–π–∫–∞ 2","–æ–±–µ—á 2","2 –æ–±–µ—á","–æ–±–µ—á2","—Å–µ–∫—Ü–∏—è 2","2 —Å–µ–∫—Ü–∏—è"]},
  {id:"sh3", title:"–û–±–µ—á–∞–π–∫–∞ 3", keys:["–æ–±–µ—á–∞–π–∫–∞ 3","–æ–±–µ—á 3","3 –æ–±–µ—á","–æ–±–µ—á3","—Å–µ–∫—Ü–∏—è 3","3 —Å–µ–∫—Ü–∏—è"]},
  {id:"sh4", title:"–û–±–µ—á–∞–π–∫–∞ 4", keys:["–æ–±–µ—á–∞–π–∫–∞ 4","–æ–±–µ—á 4","4 –æ–±–µ—á","–æ–±–µ—á4","—Å–µ–∫—Ü–∏—è 4","4 —Å–µ–∫—Ü–∏—è"]},
  {id:"sh5", title:"–û–±–µ—á–∞–π–∫–∞ 5", keys:["–æ–±–µ—á–∞–π–∫–∞ 5","–æ–±–µ—á 5","5 –æ–±–µ—á","–æ–±–µ—á5","—Å–µ–∫—Ü–∏—è 5","5 —Å–µ–∫—Ü–∏—è"]},
  {id:"sh6", title:"–û–±–µ—á–∞–π–∫–∞ 6", keys:["–æ–±–µ—á–∞–π–∫–∞ 6","–æ–±–µ—á 6","6 –æ–±–µ—á","–æ–±–µ—á6","—Å–µ–∫—Ü–∏—è 6","6 —Å–µ–∫—Ü–∏—è"]},
  // –µ—Å–ª–∏ –≤ —Ç–µ–∫—Å—Ç–µ –Ω–µ—Ç —è–≤–Ω–æ–≥–æ –Ω–æ–º–µ—Ä–∞ ‚Äî –ø–æ–ø—Ä–æ–±—É–µ–º –æ–±—â–∏–µ —Å–ª–æ–≤–∞
  {id:"shell", title:"–ö–æ—Ä–ø—É—Å (–±–µ–∑ –Ω–æ–º–µ—Ä–∞)", keys:["–∫–æ—Ä–ø—É—Å","–æ–±–µ—á–∞–π","—Å—Ç–µ–Ω–∫–∞"]},
  {id:"weld",  title:"–°–≤–∞—Ä–Ω—ã–µ —à–≤—ã", keys:["—à–æ–≤","—Å–≤–∞—Ä","—Å–≤–∞—Ä–∫–∞","–Ω–∞–ø–ª–∞–≤"]},
  {id:"nozz",  title:"–ü–∞—Ç—Ä—É–±–∫–∏/—à—Ç—É—Ü–µ—Ä–∞", keys:["–ø–∞—Ç—Ä—É–±","—à—Ç—É—Ü","–≤—Ä–µ–∑","—Å–æ–ø–ª–æ"]},
  {id:"flng",  title:"–§–ª–∞–Ω—Ü—ã/—Å—Ç—ã–∫–∏", keys:["—Ñ–ª–∞–Ω—Ü","—Å—Ç—ã–∫","–ø—Ä–æ–∫–ª–∞–¥","–±–æ–ª—Ç"]},
  {id:"supp",  title:"–û–ø–æ—Ä—ã/–∫—Ä–µ–ø–ª–µ–Ω–∏—è", keys:["–æ–ø–æ—Ä–∞","–∫—Ä–µ–ø","–ª–æ–∂–µ–º","—Å–µ–¥–ª–æ"]}
];

function inferZoneFromText(text){
  const t = (text||"").toLowerCase();
  for (const z of ZONES){
    if (z.keys.some(k => t.includes(k))) return z.title;
  }
  return "‚Äî";
}

function zoneIdByTitle(title){
  const z = ZONES.find(x => x.title === title);
  return z ? z.id : null;
}

function scoreForecast(workshop, dns, sepName){
  // Base: NVO entries (zone + severity + recency)
  const journal = safeGetJSON(journalKey(workshop, dns, sepName + "_n", "n"), []);
  const now = new Date(todayISO());

  const zoneScores = {};
  const zoneReasons = {};
  const add = (zoneTitle, pts, reason) => {
    const key = zoneTitle || "‚Äî";
    zoneScores[key] = (zoneScores[key] || 0) + pts;
    if (!zoneReasons[key]) zoneReasons[key] = [];
    if (reason) zoneReasons[key].push(reason);
  };

  journal.slice(-25).forEach((e, idx) => {
    const d = e.date ? new Date(e.date) : null;
    const daysAgo = d ? Math.max(0, daysBetween(d, now)) : 30;
    const recencyW = Math.max(0.25, 1 - (daysAgo/14)); // —Å–∏–ª—å–Ω–µ–µ –≤–µ—Å–∏—Ç –ø–æ—Å–ª–µ–¥–Ω–∏–µ 2 –Ω–µ–¥–µ–ª–∏
    const sev = Math.min(3, Math.max(1, parseInt(e.sev ?? 2, 10)));
    const zoneTitle = e.zone || inferZoneFromText((e.text||"") + " " + (e.comment||""));
    const pts = (sev * 10) * recencyW;
    add(zoneTitle, pts, `–ù–í–û: –≤–∞–∂–Ω. ${sev} (‚âà${daysAgo}–¥ –Ω–∞–∑–∞–¥)`);
  });

  // Repair history: frequent repairs = higher baseline risk
  const hist = getRepairHist(workshop, dns, sepName);
  const repairsLastYear = hist.filter(h => h.end && (daysBetween(new Date(h.end), now) <= 365)).length;
  if (repairsLastYear > 0) add("‚Äî", repairsLastYear*12, `–†–µ–º–æ–Ω—Ç–æ–≤ –∑–∞ –≥–æ–¥: ${repairsLastYear}`);

  // EPB: negative -> critical
  const epb = getEpb(workshop, dns, sepName);
  if (epb?.result === "negative") add("‚Äî", 90, "–≠–ü–ë –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–∞—è");

// NVO / GI overdue adds
  const nDays = computeNvoDays(workshop, dns, sepName);
  const gDays = computeGiDays(workshop, dns, sepName);
  if (nDays !== null && nDays > 1) add("‚Äî", 12, `–ù–í–û –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–æ (${nDays}–¥)`);
  if (gDays !== null && gDays > 1) add("‚Äî", 12, `–ì–ò –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–æ (${gDays}–¥)`);

  // Pick top zones
  const entries = Object.entries(zoneScores)
    .filter(([k]) => k !== "‚Äî")
    .sort((a,b)=>b[1]-a[1]);

  const top = entries.slice(0, 3).map(([zoneTitle, s])=>({
    zoneTitle,
    score: Math.round(s),
    zoneId: zoneIdByTitle(zoneTitle),
    reasons: (zoneReasons[zoneTitle] || []).slice(-4)
  }));

  const totalScore = Math.round(Object.values(zoneScores).reduce((a,b)=>a+b,0));
  const level = totalScore >= 120 ? "high" : (totalScore >= 60 ? "med" : "low");
  return { totalScore, level, top };
}

function renderForecast(workshop, dns, sepName, index){
  const dnsSafe = safeIdPart(dns);
  const box = document.getElementById(`forecastBox_${workshop}_${dnsSafe}_${index}`);
  if (!box) return;

  const fc = scoreForecast(workshop, dns, sepName);

  // —Å–æ–±–µ—Ä—ë–º –æ—Ü–µ–Ω–∫–∏ –ø–æ –æ–±–µ—á–∞–π–∫–∞–º 1..6
  const shells = Array.from({length:6}, (_,k)=>({
    n: k+1,
    title: `–û–±–µ—á–∞–π–∫–∞ ${k+1}`,
    score: 0,
    reasons: []
  }));

  fc.top.forEach(z=>{
    const m = /–û–±–µ—á–∞–π–∫–∞\s+([1-6])/.exec(z.zoneTitle||"");
    if (m){
      const idx = parseInt(m[1],10)-1;
      shells[idx].score += Math.round(z.score);
      shells[idx].reasons.push(...(z.reasons||[]));
    }else if ((z.zoneTitle||"").includes("–ö–æ—Ä–ø—É—Å")){
      // –±–µ–∑ –Ω–æ–º–µ—Ä–∞ ‚Äî —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–∏–º –Ω–µ–±–æ–ª—å—à–æ–π –≤–∫–ª–∞–¥ —Ä–∞–≤–Ω–æ–º–µ—Ä–Ω–æ
      shells.forEach(s=>{ s.score += Math.round(z.score/6); });
    }
  });

  const maxScore = Math.max(1, ...shells.map(s=>s.score));
  const topShells = [...shells].sort((a,b)=>b.score-a.score).slice(0,3);

  const levelText = fc.level === "high" ? "–í—ã—Å–æ–∫–∏–π —Ä–∏—Å–∫" : (fc.level === "med" ? "–°—Ä–µ–¥–Ω–∏–π —Ä–∏—Å–∫" : "–ù–∏–∑–∫–∏–π —Ä–∏—Å–∫");
  const advice = fc.level === "high"
    ? "–ù–∞ –±–ª–∏–∂–∞–π—à–µ–º –ù–í–û —Å–¥–µ–ª–∞–π –∞–∫—Ü–µ–Ω—Ç –Ω–∞ –æ–±–µ—á–∞–π–∫–∞—Ö —Å –≤—ã—Å–æ–∫–∏–º —Ä–∏—Å–∫–æ–º. –ó–∞—Ñ–∏–∫—Å–∏—Ä—É–π –¥–µ—Ñ–µ–∫—Ç—ã (—Ñ–æ—Ç–æ/–æ–ø–∏—Å–∞–Ω–∏–µ) –∏ —É–∫–∞–∂–∏ ¬´–ó–æ–Ω–∞ (–æ–±–µ—á–∞–π–∫–∞)¬ª."
    : "–î–µ—Ä–∂–∏ –ø–æ–¥ –∫–æ–Ω—Ç—Ä–æ–ª–µ–º –æ—Ç–º–µ—á–µ–Ω–Ω—ã–µ –æ–±–µ—á–∞–π–∫–∏. –î–ª—è —Ç–æ—á–Ω–æ—Å—Ç–∏ –ø—Ä–æ–≥–Ω–æ–∑–∞ ‚Äî —É–∫–∞–∑—ã–≤–∞–π –∑–æ–Ω—É –∏ –≤–∞–∂–Ω–æ—Å—Ç—å –≤ –ù–í–û.";

  const list = topShells.length
    ? topShells.map(s => `
        <li>
          <b>${escapeHtml(s.title)}</b> ‚Äî —Ä–∏—Å–∫: <b>${escapeHtml(String(s.score))}</b>
          <div class="zone-note">${escapeHtml((s.reasons||[]).slice(0,3).join("; ") || "‚Äî")}</div>
        </li>
      `).join("")
    : `<li><b>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</b><div class="zone-note">–î–æ–±–∞–≤—å –∑–∞–ø–∏—Å–∏ –ù–í–û (–∂–µ–ª–∞—Ç–µ–ª—å–Ω–æ —Å –≤—ã–±–æ—Ä–æ–º ¬´–ó–æ–Ω–∞ (–æ–±–µ—á–∞–π–∫–∞)¬ª –∏ ¬´–í–∞–∂–Ω–æ—Å—Ç—å¬ª).</div></li>`;

  const scheme = shells.map(s=>{
    const p = Math.round((s.score/maxScore)*100);
    const cls = p >= 70 ? "hi" : (p >= 40 ? "med" : "low");
    return `
      <button class="shell" data-level="${cls}" title="${escapeHtml(s.title)} ‚Äî —Ä–∏—Å–∫ ${p}%"
        onclick="focusNvoZone('${escapeHtml(workshop)}','${escapeHtml(dns)}',${index},'${escapeHtml(s.title)}')">
        <div class="shell-top">${escapeHtml(String(s.n))}</div>
        <div class="shell-bar"><div style="width:${p}%"></div></div>
        <div class="shell-bot">${escapeHtml(String(2800 + (s.n-1)*40))}‚Äì${escapeHtml(String(3000 + (s.n-1)*40))} —Å–º</div>
      </button>
    `;
  }).join("");

  box.innerHTML = `
    <div class="forecast-wrap">
      <div class="forecast-card">
        <p class="forecast-title">–ü—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–º–æ–Ω—Ç–∞</p>
        <div class="forecast-kpi">
          <span class="risk-pill ${fc.level}">${escapeHtml(levelText)} ‚Ä¢ ${escapeHtml(String(Math.round(fc.totalScore)))} –±–∞–ª–ª.</span>
          <span class="smalltext">${escapeHtml(advice)}</span>
        </div>

        <div class="shell-scheme" style="margin-top:10px;">
          ${scheme}
        </div>

        <div style="margin-top:12px;">
          <p class="forecast-sub">–¢–û–ü –∑–æ–Ω—ã –≤–Ω–∏–º–∞–Ω–∏—è (–¥–ª—è –ù–í–û)</p>
          <ul class="forecast-list">${list}</ul>
        </div>

        <div class="smalltext" style="margin-top:10px;">
          –ü–æ–¥—Å–∫–∞–∑–∫–∞: –Ω–∞–∂–º–∏ –Ω–∞ –æ–±–µ—á–∞–π–∫—É ‚Äî –æ—Ç–∫—Ä–æ–µ—Ç—Å—è –≤–∫–ª–∞–¥–∫–∞ ¬´–ù–í–û¬ª –∏ –ø–æ–¥—Å—Ç–∞–≤–∏—Ç—Å—è –∑–æ–Ω–∞.
        </div>
      </div>
    </div>
  `;
}

/* =====================
   Dashboard / summary
===================== */
function computeStats(workshop, dns){
  const total = separators.length;
  let repairCount=0;

  let nvoOverdue=0, giOverdue=0;
  let nvoMaxDays=0, giMaxDays=0;

  let toOverdue=0, toSoon=0;

  let histDaysSum=0, histCount=0;

  separators.forEach(sepName=>{
    const st = getStatus(workshop, dns, sepName);
    if (st==="repair") repairCount++;

    const nDays = computeNvoDays(workshop, dns, sepName);
    if (nDays !== null){
      nvoMaxDays = Math.max(nvoMaxDays, nDays);
      if (nDays > 1) nvoOverdue++;
    }else{
      nvoOverdue++;
      nvoMaxDays = Math.max(nvoMaxDays, 999);
    }

    const gDays = computeGiDays(workshop, dns, sepName);
    if (gDays !== null){
      giMaxDays = Math.max(giMaxDays, gDays);
      if (gDays > 1) giOverdue++;
    }else{
      giOverdue++;
      giMaxDays = Math.max(giMaxDays, 999);
    }

    const card = getCard(workshop, dns, sepName);
    const to = computeTOStatus(card);
    if (to.state==="overdue") toOverdue++;
    if (to.state==="soon") toSoon++;

    const hist = getRepairHist(workshop, dns, sepName);
    hist.forEach(h=>{ histDaysSum += (h.days||0); histCount++; });
  });

  const repairPct = total ? Math.round((repairCount/total)*100) : 0;
  const repairAvg = histCount ? (histDaysSum/histCount) : null;

  const totalBad = nvoOverdue + giOverdue + toOverdue;

  const mk = (base)=> Array.from({length:12}, (_,i)=> base + (Math.sin(i/2)*2));
  return {
    total, repairCount, repairPct,
    nvoOverdue, giOverdue,
    nvoMaxDays, giMaxDays,
    toOverdue, toSoon,
    repairAvg, totalBad,
    sparkRepair: mk(repairPct),
    sparkNvo: mk(nvoOverdue),
    sparkGi: mk(giOverdue),
    sparkTo: mk(toOverdue),
    sparkAvg: mk(repairAvg ?? 0),
    sparkNvoMax: mk(nvoMaxDays>=999? 0 : nvoMaxDays),
    sparkGiMax: mk(giMaxDays>=999? 0 : giMaxDays),
    sparkBad: mk(totalBad)
  };
}
function renderSummary(workshop, dns){
  const sumEl = document.getElementById("dnsSummary");
  sumEl.style.display = "flex";

  const stats = computeStats(workshop, dns);
  const working = stats.total - stats.repairCount;

  document.getElementById("dnsSummaryText").innerText =
    `–°–µ–ø–∞—Ä–∞—Ç–æ—Ä—ã: –≤—Å–µ–≥–æ ${stats.total}, –≤ —Ä–∞–±–æ—Ç–µ ${working}, –≤ —Ä–µ–º–æ–Ω—Ç–µ ${stats.repairCount}`;

  const role = getRole();
  let hint = "";
  if (role === "viewer") hint = "–†–µ–∂–∏–º: –ø—Ä–æ—Å–º–æ—Ç—Ä (–∏–∑–º–µ–Ω–µ–Ω–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã)";
  if (role === "editor") hint = "–†–µ–∂–∏–º: —Ä–µ–¥–∞–∫—Ç–æ—Ä";
  if (role === "admin")  hint = "–†–µ–∂–∏–º: –∞–¥–º–∏–Ω";
  document.getElementById("dnsSummaryHint").innerText = hint;

  const alerts = document.getElementById("dnsAlerts");
  alerts.innerHTML = "";

  const mkChip = (cls, txt, title="")=>{
    const s=document.createElement("span");
    s.className = `chip ${cls||""}`.trim();
    s.innerHTML = txt;
    if (title) s.title = title;
    alerts.appendChild(s);
  };

  if (stats.nvoOverdue > 0) mkChip("bad", `<strong>–ù–í–û –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–æ ${stats.nvoOverdue}</strong>`);
  else mkChip("ok", `<strong>–ù–í–û OK</strong>`);

  if (stats.giOverdue > 0) mkChip("bad", `<strong>–ì–ò –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–æ ${stats.giOverdue}</strong>`);
  else mkChip("ok", `<strong>–ì–ò OK</strong>`);

  if (stats.toOverdue > 0) mkChip("bad", `<strong>–¢–û –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–æ ${stats.toOverdue}</strong>`);
  if (stats.toSoon > 0) mkChip("warn", `<strong>–¢–û —Å–∫–æ—Ä–æ ${stats.toSoon}</strong>`);
  if (stats.toOverdue === 0 && stats.toSoon === 0) mkChip("ok", `<strong>–¢–û OK</strong>`);

  // KPI animations
  animateNumber(document.getElementById("kpiRepair"), stats.repairCount, `/${stats.total}`);
  document.getElementById("kpiRepairS").innerText = `${stats.repairPct}% –æ—Ç –ø–∞—Ä–∫–∞`;
  document.getElementById("barRepair").style.width = `${stats.repairPct}%`;

  animateNumber(document.getElementById("kpiNvo"), stats.nvoOverdue);
  animateNumber(document.getElementById("kpiGi"), stats.giOverdue);
  animateNumber(document.getElementById("kpiTo"), stats.toOverdue, ` / ${stats.toSoon}`);
  animateNumber(document.getElementById("kpiTotalBad"), stats.totalBad);

  if (stats.nvoMaxDays >= 999) document.getElementById("kpiNvoMax").textContent = "–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö";
  else animateNumber(document.getElementById("kpiNvoMax"), stats.nvoMaxDays, " –¥–Ω");

  if (stats.giMaxDays >= 999) document.getElementById("kpiGiMax").textContent = "–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö";
  else animateNumber(document.getElementById("kpiGiMax"), stats.giMaxDays, " –¥–Ω");

  if (stats.repairAvg === null) document.getElementById("kpiRepairAvg").textContent = "‚Äî";
  else animateNumber(document.getElementById("kpiRepairAvg"), stats.repairAvg, " –¥–Ω");

  // sparklines
  buildSpark(document.getElementById("sparkRepair"), stats.sparkRepair);
  buildSpark(document.getElementById("sparkNvo"), stats.sparkNvo);
  buildSpark(document.getElementById("sparkGi"), stats.sparkGi);
  buildSpark(document.getElementById("sparkTo"), stats.sparkTo);
  buildSpark(document.getElementById("sparkAvg"), stats.sparkAvg);
  buildSpark(document.getElementById("sparkNvoMax"), stats.sparkNvoMax);
  buildSpark(document.getElementById("sparkGiMax"), stats.sparkGiMax);
  buildSpark(document.getElementById("sparkBad"), stats.sparkBad);
}

/* =====================
   Repair list modal
===================== */
function openRepairList(){
  const workshop = document.getElementById("workshopSelect").value;
  const dns = document.getElementById("dnsSelect").value;
  if (!workshop || !dns){ alert("–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –¶–µ—Ö –∏ –î–ù–°"); return; }
  document.getElementById("repairListOverlay").style.display = "flex";
  document.getElementById("repairListSubtitle").innerText = `${workshop} ¬∑ ${dns}`;
  refreshRepairList();
}
function closeRepairList(){ document.getElementById("repairListOverlay").style.display = "none"; }
function refreshRepairList(){
  const workshop = document.getElementById("workshopSelect").value;
  const dns = document.getElementById("dnsSelect").value;
  const table = document.getElementById("repairListTable");
  if (!workshop || !dns || !table) return;

  const rows = [];
  getSeparatorsByDNS(workshop, dns).forEach((sepName, idx)=>{
    const st = getStatus(workshop, dns, sepName);
    if (st !== "repair") return;
    const rc = getRepairCard(workshop, dns, sepName);
    const startISO = getRepairStartISO(workshop, dns, sepName) || rc.start || "";
    const days = startISO ? Math.max(0, daysBetween(new Date(startISO), new Date(todayISO()))) : null;
    rows.push({ sepName, idx, start:startISO, days, reason:rc.reason||"", team:rc.team||"", doc:rc.doc||"", downtime:rc.downtime||"", cost:rc.cost||"" });
  });

  table.innerHTML = `
    <tr>
      <th>–°–µ–ø–∞—Ä–∞—Ç–æ—Ä</th><th>–°–∫–æ–ª—å–∫–æ –¥–Ω–µ–π</th><th>–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞</th><th>–ü—Ä–∏—á–∏–Ω–∞</th>
      <th>–ü–æ–¥—Ä—è–¥—á–∏–∫/–±—Ä–∏–≥–∞–¥–∞</th><th>–î–æ–∫—É–º–µ–Ω—Ç</th><th>–ü—Ä–æ—Å—Ç–æ–π (—á)</th><th>–ó–∞—Ç—Ä–∞—Ç—ã (‚ÇΩ)</th>
    </tr>
  `;

  if (!rows.length){
    const tr = document.createElement("tr");
    tr.innerHTML = `<td colspan="8" style="padding:14px;">
      <span class="pill">–ù–µ—Ç —Å–µ–ø–∞—Ä–∞—Ç–æ—Ä–æ–≤ –≤ —Ä–µ–º–æ–Ω—Ç–µ</span>
      <span class="smalltext" style="margin-left:10px;">(–ø–æ —Ç–µ–∫—É—â–∏–º —Å—Ç–∞—Ç—É—Å–∞–º)</span>
    </td>`;
    table.appendChild(tr);
    return;
  }

  rows.sort((a,b)=>(b.days ?? -1)-(a.days ?? -1));
  rows.forEach(r=>{
    const tr=document.createElement("tr");
    const daysText = (r.days===null) ? "‚Äî" : `${r.days} –¥–Ω`;
    tr.innerHTML = `
      <td><b>${escapeHtml(r.sepName)}</b> <span class="pill">–≤ —Ä–µ–º–æ–Ω—Ç–µ</span></td>
      <td>${escapeHtml(daysText)}</td>
      <td>${escapeHtml(r.start || "‚Äî")}</td>
      <td>${escapeHtml(r.reason || "‚Äî")}</td>
      <td>${escapeHtml(r.team || "‚Äî")}</td>
      <td>${escapeHtml(r.doc || "‚Äî")}</td>
      <td>${escapeHtml(String(r.downtime || "‚Äî"))}</td>
      <td>${escapeHtml(String(r.cost || "‚Äî"))}</td>
    `;
    tr.onclick = () => focusRepair(r.idx);
    table.appendChild(tr);
  });
}
function focusRepair(index){
  closeRepairList();
  const sepEl = document.querySelector(`.separator[data-sep-index="${index}"]`);
  if (!sepEl) return;
  openSeparator(sepEl, true);

  const btn = sepEl.querySelectorAll(".tab-button")[1];
  if (btn){
    const tabId = btn.getAttribute("data-tab");
    activateTabWithin(sepEl, tabId, true);
    syncSeparatorHeight(sepEl);
  }
  sepEl.scrollIntoView({behavior:"smooth", block:"start"});


}

/* =====================
   Forecast helper: jump to NVO and set zone
===================== */
function focusNvoZone(workshop, dns, index, zoneTitle){
  const sepEl = document.querySelector(`.separator[data-sep-index="${index}"]`);
  if (!sepEl) return;

  openSeparator(sepEl, true);

  const dnsSafe = safeIdPart(dns);
  const tabN = `n_${workshop}_${dnsSafe}_${index}`;
  activateTabWithin(sepEl, tabN, true);
  syncSeparatorHeight(sepEl);

  const zoneSel = document.getElementById(`journalZone_ns${workshop}${dnsSafe}${index}`);
  if (zoneSel){
    zoneSel.value = zoneTitle || "";
    zoneSel.focus();
  }
  sepEl.scrollIntoView({behavior:"smooth", block:"start"});
}

/* =====================
   Filters
===================== */
function applyFilter(){
  const workshop = document.getElementById("workshopSelect").value;
  const dns = document.getElementById("dnsSelect").value;
  if (!workshop || !dns) return;

  const f = document.getElementById("statusFilter")?.value || "all";
  const q = (document.getElementById("sepSearch")?.value || "").toLowerCase().trim();

  localStorage.setItem(UI.filterKey, f);
  localStorage.setItem(UI.searchKey, q);

  let visibleCount = 0;
  document.querySelectorAll(".separator").forEach(sepEl=>{
    const sepName = sepEl.getAttribute("data-sep-name") || "";
    const status = getStatus(workshop, dns, sepName);

    const okStatus = (f === "all") ? true : status === f;
    const okQuery = !q || sepName.toLowerCase().includes(q);

    const show = (okStatus && okQuery);
    sepEl.style.display = show ? "" : "none";
    if (show) visibleCount++;
  });

  // –ï—Å–ª–∏ —Ñ–∏–ª—å—Ç—Ä/–ø–æ–∏—Å–∫ —Å–∫—Ä—ã–ª–∏ –≤—Å—ë ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–Ω—è—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤–º–µ—Å—Ç–æ ¬´–ø—É—Å—Ç–æ–≥–æ —ç–∫—Ä–∞–Ω–∞¬ª
  const empty = document.getElementById("emptyState");
  const content = document.getElementById("content");
  if (visibleCount === 0){
    if (content) content.style.display = "none";
    if (empty){
      empty.style.display = "block";
      const h = empty.querySelector("h3");
      const p = empty.querySelector("p");
      if (h) h.innerText = "–ù–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤";
      if (p) p.innerText = "–§–∏–ª—å—Ç—Ä/–ø–æ–∏—Å–∫ —Å–∫—Ä—ã–ª–∏ –≤—Å–µ —Å–µ–ø–∞—Ä–∞—Ç–æ—Ä—ã. –ù–∞–∂–º–∏—Ç–µ ¬´–°–±—Ä–æ—Å —Ñ–∏–ª—å—Ç—Ä–∞¬ª —Å–ø—Ä–∞–≤–∞ –∏–ª–∏ –æ—á–∏—Å—Ç–∏—Ç–µ –ø–æ–∏—Å–∫.";
    }
  } else {
    if (content) content.style.display = "";
    if (empty) empty.style.display = "none";
  }
}
function clearFilter(){
  document.getElementById("statusFilter").value = "all";
  document.getElementById("sepSearch").value = "";
  applyFilter();
}

/* =====================
   Mass actions
===================== */
function getVisibleSeparators(){
  const list = [];
  document.querySelectorAll(".separator").forEach(sepEl=>{
    if (sepEl.style.display === "none") return;
    const name = sepEl.getAttribute("data-sep-name");
    const idx = parseInt(sepEl.getAttribute("data-sep-index"), 10);
    list.push({name, idx});
  });
  return list;
}
function massSetStatus(value){
  const role = getRole();
  if (!(role === "editor" || role === "admin")){
    alert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤");
    return;
  }
  const workshop = document.getElementById("workshopSelect").value;
  const dns = document.getElementById("dnsSelect").value;
  if (!workshop || !dns) return;

  const items = getVisibleSeparators();
  items.forEach(({name, idx})=>{
    const prev = getStatus(workshop, dns, name);
    if (prev !== value){
      if (prev !== "repair" && value === "repair") onRepairStart(workshop, dns, name);
      if (prev === "repair" && value === "working") onRepairEnd(workshop, dns, name);
    }
    setStatus(workshop, dns, name, value);
    const sepEl = document.querySelector(`.separator[data-sep-index="${idx}"]`);
    if (sepEl) sepEl.setAttribute("data-status", value);
    updateRepairInfoLine(workshop, dns, name, idx);
  });
  loadDNS();
}
function toggleAllSeparators(open){
  document.querySelectorAll(".separator").forEach(sepEl=>{
    if (sepEl.style.display === "none") return;
    const body = sepEl.querySelector(".separator-body");
    if (!body) return;
    if (open) openSeparator(sepEl, true);
    else body.style.maxHeight = "0px";
  });
}

/* =====================
   Selects
===================== */
// –ó–∞–ø–æ–ª–Ω—è–µ–º —Å–ø–∏—Å–æ–∫ –¶–î–ù–ì –∏–∑ –ø–∞—Å–ø–æ—Ä—Ç–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã (WORKSHOP_MAP).
// –≠—Ç–æ —Å—Ç—Ä–∞—Ö–æ–≤–∫–∞ –Ω–∞ —Å–ª—É—á–∞–π, –µ—Å–ª–∏ select –±—ã–ª –æ—á–∏—â–µ–Ω –ø–æ—Å–ª–µ –∏–º–ø–æ—Ä—Ç–∞/—Å–±–æ—è –∏–ª–∏ —Å—Ç–∞—Ä–æ–π –≤–µ—Ä—Å–∏–∏ —Ñ–∞–π–ª–∞.
function ensureWorkshopOptions(){
  const wsSel = document.getElementById('workshopSelect');
  if (!wsSel) return;
  const current = wsSel.value || '';
  wsSel.innerHTML = "<option value=''>‚Äî –≤—ã–±—Ä–∞—Ç—å ‚Äî</option>";
  Object.keys(WORKSHOP_MAP || {}).forEach(ws=>{
    const opt = document.createElement('option');
    opt.value = ws;
    opt.textContent = ws;
    wsSel.appendChild(opt);
  });
  // –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π, –µ—Å–ª–∏ –æ–Ω —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ —Å–ø–∏—Å–∫–µ
  if (current && (WORKSHOP_MAP && WORKSHOP_MAP[current])) wsSel.value = current;
}


function selectWorkshop(num){
  const dnsSelect = document.getElementById("dnsSelect");
  dnsSelect.innerHTML = "<option value=''>‚Äî –≤—ã–±—Ä–∞—Ç—å ‚Äî</option>";
  document.getElementById("content").innerHTML = "";
  document.getElementById("title").innerText = "";
  document.getElementById("dnsSummary").style.display = "none";
  document.getElementById("emptyState").style.display = "block";
  document.getElementById("skeletonWrap").style.display = "none";
  closeRepairList();

  if(!num){
    dnsSelect.disabled = true;
    localStorage.removeItem(UI.wsKey);
    localStorage.removeItem(UI.dnsKey);
    return;
  }

  dnsSelect.disabled = false;
  getDNSListByWorkshop(num).forEach(d => { dnsSelect.innerHTML += `<option value="${d}">${d}</option>`; });

  saveUISelection(num, "");
  applyPermissionsToUI();
}

/* =====================
   Skeleton + Render DNS
===================== */
function showSkeleton(on){ document.getElementById("skeletonWrap").style.display = on ? "block" : "none"; }

function loadDNS(){
  const workshop = document.getElementById("workshopSelect").value;
  const dns = document.getElementById("dnsSelect").value;
  const content = document.getElementById("content");

  // –æ–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ —Å–µ–ø–∞—Ä–∞—Ç–æ—Ä–æ–≤ –ø–æ–¥ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –¶–î–ù–ì/–î–ù–°
  separators = (WORKSHOP_MAP[workshop] && WORKSHOP_MAP[workshop][dns]) ? [...WORKSHOP_MAP[workshop][dns]] : [];

  if(!dns){
    content.innerHTML = "";
    document.getElementById("dnsSummary").style.display = "none";
    document.getElementById("emptyState").style.display = "block";
    showSkeleton(false);
    localStorage.removeItem(UI.dnsKey);
    return;
  }

  
  if (!separators.length){
    document.getElementById("title").innerText = `${workshop} ¬∑ ${dns}`;
    content.innerHTML = "";
    showSkeleton(false);
    document.getElementById("dnsSummary").style.display = "none";
    document.getElementById("emptyState").style.display = "block";
    document.getElementById("emptyState").querySelector("h3").innerText = "–ù–µ—Ç —Å–µ–ø–∞—Ä–∞—Ç–æ—Ä–æ–≤ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–π –î–ù–°";
    document.getElementById("emptyState").querySelector("p").innerText = "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫ —Å–µ–ø–∞—Ä–∞—Ç–æ—Ä–æ–≤ –¥–ª—è —ç—Ç–æ–π –î–ù–°.";
    return;
  }
saveUISelection(workshop, dns);

  document.getElementById("emptyState").style.display = "none";
  document.getElementById("title").innerText = `${workshop} ¬∑ ${dns}`;
  content.innerHTML = "";
  showSkeleton(true);

  setTimeout(()=>{
    renderSummary(workshop, dns);
    renderSeparators(workshop, dns);
    showSkeleton(false);

    const f = localStorage.getItem(UI.filterKey) || "all";
    const q = localStorage.getItem(UI.searchKey) || "";
    document.getElementById("statusFilter").value = f;
    document.getElementById("sepSearch").value = q;
    applyFilter();
    applyPermissionsToUI();

    const openIdx = getSavedOpenSeparator();
    if (openIdx !== null){
      const sepEl = document.querySelector(`.separator[data-sep-index="${openIdx}"]`);
      if (sepEl && sepEl.style.display !== "none") openSeparator(sepEl, false);
    }
  }, 80);
}

/* =====================
   ‚úÖ –†–ï–ù–î–ï–† –°–ï–ü–ê–†–ê–¢–û–†–û–í + –ù–û–í–´–ô PDF "–ß–µ—Ä—Ç–µ–∂" (–ø—É–Ω–∫—Ç 1)
===================== */
function renderSeparators(workshop, dns){
  const content = document.getElementById("content");
  const dnsSafe = safeIdPart(dns);

  separators.forEach((sepName, i)=>{
    const wn = workshopNum(workshop);
    const pressure = (2 + i*0.5 + wn*0.2).toFixed(1);
    const temp = 40 + i*5;
    const prod = 1500 + wn*100 + i*50;
    const year = 2015 + i + wn;

    const passportPath = `–ü–∞—Å–ø–æ—Ä—Ç–∞/${workshop}/${dns}/passport_s${i+1}.pdf`;
    const drawingPath  = `Chertyozh/${workshop}/${dns}/drawing_s${i+1}.jpg`;
    const repairPath   = `Akt/${workshop}/${dns}/akt_s${i+1}.pdf`;

    // –µ—Å–ª–∏ –ø–æ–∑–∂–µ –ø–æ—è–≤—è—Ç—Å—è —Ä–∞–∑–Ω—ã–µ —Ñ–∞–π–ª—ã ‚Äî –ø–æ–º–µ–Ω—è–µ–º –ø—É—Ç–∏ –æ—Ç–¥–µ–ª—å–Ω–æ
    const nvoPath      = `NVO/${workshop}/${dns}/NVO_s${i+1}.pdf`;
    const giPath       = `GI/${workshop}/${dns}/GI_s${i+1}.pdf`;

    const tabP = `p_${workshop}_${dnsSafe}_${i}`;
    const tabR = `r_${workshop}_${dnsSafe}_${i}`;
    const tabN = `n_${workshop}_${dnsSafe}_${i}`;
    const tabG = `g_${workshop}_${dnsSafe}_${i}`;
    const tabE = `e_${workshop}_${dnsSafe}_${i}`;
    const tabD = `d_${workshop}_${dnsSafe}_${i}`;

    const st = getStatus(workshop, dns, sepName);
    const card = getCard(workshop, dns, sepName);
    const to = computeTOStatus(card);

    const nDays = computeNvoDays(workshop, dns, sepName);
    const gDays = computeGiDays(workshop, dns, sepName);

    const cRepair = journalCount(workshop, dns, sepName, "");
    const cNvo    = journalCount(workshop, dns, sepName + "_n", "n");
    const cGi     = journalCount(workshop, dns, sepName + "_g", "g");

    const toChip = toChipHTML(to);
    const nChip  = nvoChipHTML(nDays);
    const gChip  = giChipHTML(gDays);

    const epb = getEpb(workshop, dns, sepName);
    const epbChip = epbChipHTML(epb.result);
    const rChip  = repairChipHTML(workshop, dns, sepName);

    const toAttr = (to.state === "overdue") ? "overdue" : (to.state === "soon" ? "soon" : "ok");
    const inspectAttr = ((nDays === null || nDays > 1) || (gDays === null || gDays > 1)) ? "bad" : "ok";

    content.innerHTML += `
      <div class="separator"
           data-sep-index="${i}"
           data-sep-name="${sepName}"
           data-status="${st}"
           data-to="${toAttr}"
           data-inspect="${inspectAttr}">
        <div class="separator-header" onclick="toggleSeparator(this)">
          <div class="sep-left">
            <span class="status-dot" aria-hidden="true"></span>
            <span style="font-size:15px;">${sepName}</span>
            <div class="chips">
              ${rChip}
              ${toChip}
              ${nChip}
              ${gChip}
              ${epbChip}
            </div>
          </div>
          <div class="sep-right" onclick="event.stopPropagation()">
            <select
              id="statusSelect_${workshop}_${dnsSafe}_${i}"
              class="status-select"
              onchange="onStatusChange('${workshop}', '${dns}', '${sepName}', ${i}, this.value)"
              title="–°—Ç–∞—Ç—É—Å —Å–µ–ø–∞—Ä–∞—Ç–æ—Ä–∞"
            >
              <option value="working">–í —Ä–∞–±–æ—Ç–µ</option>
              <option value="repair">–í —Ä–µ–º–æ–Ω—Ç–µ</option>
            </select>
          </div>
        </div>

        <div class="separator-body">
          <div class="tabs">
            <button class="tab-button" data-tab="${tabP}" onclick="openTab(event,'${tabP}')">–ü–∞—Å–ø–æ—Ä—Ç</button>

            <button class="tab-button" id="tabBtn_repair_${workshop}_${dnsSafe}_${i}" data-tab="${tabR}" onclick="openTab(event,'${tabR}')">
              –ö–∞–ø–∏—Ç–∞–ª—å–Ω—ã–π —Ä–µ–º–æ–Ω—Ç <span class="tab-count">${cRepair}</span>
            </button>

            <button class="tab-button" id="tabBtn_nvo_${workshop}_${dnsSafe}_${i}" data-tab="${tabN}" onclick="openTab(event,'${tabN}')">
              –ù–í–û <span class="tab-count">${cNvo}</span>
            </button>

            <button class="tab-button" id="tabBtn_gi_${workshop}_${dnsSafe}_${i}" data-tab="${tabG}" onclick="openTab(event,'${tabG}')">
              –ì–ò <span class="tab-count">${cGi}</span>
            </button>

            <button class="tab-button" id="tabBtn_epb_${workshop}_${dnsSafe}_${i}" data-tab="${tabE}" onclick="openTab(event,'${tabE}')">
              –≠–∫—Å–ø–µ—Ä—Ç–∏–∑–∞
            </button>

            
          

            <button class="tab-button" id="tabBtn_pd_${workshop}_${dnsSafe}_${i}" data-tab="${tabD}" onclick="openTab(event,'${tabD}')">
              –ü—Ä–æ–≥–Ω–æ–∑–∏—Ä—É–µ–º—ã–µ –¥–µ—Ñ–µ–∫—Ç—ã
            </button>
</div>

          <div id="${tabP}" class="tab-content">
            <table>
              <tr><th>–ü–∞—Ä–∞–º–µ—Ç—Ä</th><th>–ó–Ω–∞—á–µ–Ω–∏–µ</th></tr>
              <tr><td>–ò–Ω–≤–µ–Ω—Ç–∞—Ä–Ω—ã–π ‚Ññ</td>
                <td><input data-card-field id="cardInv_${workshop}_${dnsSafe}_${i}" style="width:100%; padding:10px; border-radius:12px; border:1px solid var(--border); background:var(--panel); color:var(--text);" value="${escapeHtml(card.inv)}"></td></tr>
              <tr><td>–ó–∞–≤–æ–¥—Å–∫–æ–π ‚Ññ</td>
                <td><input data-card-field id="cardSerial_${workshop}_${dnsSafe}_${i}" style="width:100%; padding:10px; border-radius:12px; border:1px solid var(--border); background:var(--panel); color:var(--text);" value="${escapeHtml(card.serial)}"></td></tr>
              <tr><td>–ú–µ—Å—Ç–æ —É—Å—Ç–∞–Ω–æ–≤–∫–∏</td>
                <td><input data-card-field id="cardPlace_${workshop}_${dnsSafe}_${i}" style="width:100%; padding:10px; border-radius:12px; border:1px solid var(--border); background:var(--panel); color:var(--text);" value="${escapeHtml(card.place)}"></td></tr>
              <tr><td>–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π</td>
                <td><input data-card-field id="cardResp_${workshop}_${dnsSafe}_${i}" style="width:100%; padding:10px; border-radius:12px; border:1px solid var(--border); background:var(--panel); color:var(--text);" value="${escapeHtml(card.resp)}"></td></tr>
              <tr><td>–ù–í–û: —Å–ª–µ–¥—É—é—â–µ–µ (–¥–∞—Ç–∞)</td>
                <td>
                  <input data-card-field type="date" id="cardNextNVO_${workshop}_${dnsSafe}_${i}" style="padding:10px; border-radius:12px; border:1px solid var(--border); background:var(--panel); color:var(--text);" value="${escapeHtml(card.nextNVO || '')}">
                </td>
              </tr>
              <tr><td>–ù–í–û: –ø–µ—Ä–∏–æ–¥ (–¥–Ω–µ–π)</td>
                <td><input data-card-field type="number" min="1" id="cardNVOPeriod_${workshop}_${dnsSafe}_${i}" style="width:160px; padding:10px; border-radius:12px; border:1px solid var(--border); background:var(--panel); color:var(--text);" value="${escapeHtml(card.nvoPeriodDays ?? 1)}"></td></tr>
              <tr><td>–ì–ò: —Å–ª–µ–¥—É—é—â–µ–µ (–¥–∞—Ç–∞)</td>
                <td>
                  <input data-card-field type="date" id="cardNextGI_${workshop}_${dnsSafe}_${i}" style="padding:10px; border-radius:12px; border:1px solid var(--border); background:var(--panel); color:var(--text);" value="${escapeHtml(card.nextGI || '')}">
                </td>
              </tr>
              <tr><td>–ì–ò: –ø–µ—Ä–∏–æ–¥ (–¥–Ω–µ–π)</td>
                <td><input data-card-field type="number" min="1" id="cardGIPeriod_${workshop}_${dnsSafe}_${i}" style="width:160px; padding:10px; border-radius:12px; border:1px solid var(--border); background:var(--panel); color:var(--text);" value="${escapeHtml(card.giPeriodDays ?? 1)}"></td></tr>

              ${renderCustomCardRows(card, workshop, dns, i)}
              <tr><td>–¢–∏–ø</td><td>–°–µ–ø–∞—Ä–∞—Ç–æ—Ä –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–π</td></tr>
              <tr><td>–î–∞–≤–ª–µ–Ω–∏–µ, –ú–ü–∞</td><td>${pressure}</td></tr>
              <tr><td>–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞, ¬∞C</td><td>${temp}</td></tr>
              <tr><td>–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å, –º¬≥/—Å—É—Ç</td><td>${prod}</td></tr>
              <tr><td>–ì–æ–¥ –≤–≤–æ–¥–∞</td><td>${year}</td></tr>
              <tr><td>–°–æ—Å—Ç–æ—è–Ω–∏–µ</td><td>${st === "repair" ? "–í —Ä–µ–º–æ–Ω—Ç–µ" : "–í —Ä–∞–±–æ—Ç–µ"}</td></tr>
            </table>

            <button class="pdf-btn" data-action="save-card" onclick="saveCard('${workshop}','${dns}','${sepName}',${i})">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É</button>
            <button class="pdf-btn" onclick="window.open('${passportPath}')">–ü–∞—Å–ø–æ—Ä—Ç (PDF)</button>
            <button class="pdf-btn" onclick="window.open('${drawingPath}')">–ß–µ—Ä—Ç–µ–∂</button>
          </div>

          <div id="${tabR}" class="tab-content">
            <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
              <button class="pdf-btn" onclick="window.open('${repairPath}')">–î–æ–∫—É–º–µ–Ω—Ç—ã —Ä–µ–º–æ–Ω—Ç–∞</button>
              <span class="smalltext" id="repairInfo_${workshop}_${dnsSafe}_${i}"></span>
            </div>

            <table>
              <tr><th>–ö–∞–ø–∏—Ç–∞–ª—å–Ω—ã–π —Ä–µ–º–æ–Ω—Ç</th><th>–î–∞–Ω–Ω—ã–µ</th></tr>
              <tr><td>–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞</td>
                  <td><input data-repair-field type="date" style="padding:10px; border-radius:12px; border:1px solid var(--border); background:var(--panel); color:var(--text);" id="repairStart_${workshop}_${dnsSafe}_${i}"></td></tr>
              <tr><td>–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è</td>
                  <td><input data-repair-field type="date" style="padding:10px; border-radius:12px; border:1px solid var(--border); background:var(--panel); color:var(--text);" id="repairEnd_${workshop}_${dnsSafe}_${i}"></td></tr>
              <tr><td>–ü—Ä–∏—á–∏–Ω–∞</td>
                  <td><input data-repair-field type="text" style="width:100%; padding:10px; border-radius:12px; border:1px solid var(--border); background:var(--panel); color:var(--text);" id="repairReason_${workshop}_${dnsSafe}_${i}"></td></tr>
              <tr><td>–ü–æ–¥—Ä—è–¥—á–∏–∫ / –±—Ä–∏–≥–∞–¥–∞</td>
                  <td><input data-repair-field type="text" style="width:100%; padding:10px; border-radius:12px; border:1px solid var(--border); background:var(--panel); color:var(--text);" id="repairTeam_${workshop}_${dnsSafe}_${i}"></td></tr>
              <tr><td>–ù–æ–º–µ—Ä –∞–∫—Ç–∞ / –Ω–∞—Ä—è–¥–∞</td>
                  <td><input data-repair-field type="text" style="width:260px; padding:10px; border-radius:12px; border:1px solid var(--border); background:var(--panel); color:var(--text);" id="repairDoc_${workshop}_${dnsSafe}_${i}"></td></tr>
              <tr><td>–ü—Ä–æ—Å—Ç–æ–π (—á–∞—Å–æ–≤)</td>
                  <td><input data-repair-field type="number" min="0" style="width:160px; padding:10px; border-radius:12px; border:1px solid var(--border); background:var(--panel); color:var(--text);" id="repairDowntime_${workshop}_${dnsSafe}_${i}"></td></tr>
              <tr><td>–û—Ü–µ–Ω–∫–∞ –∑–∞—Ç—Ä–∞—Ç (‚ÇΩ)</td>
                  <td><input data-repair-field type="number" min="0" style="width:220px; padding:10px; border-radius:12px; border:1px solid var(--border); background:var(--panel); color:var(--text);" id="repairCost_${workshop}_${dnsSafe}_${i}"></td></tr>
            </table>

            <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:8px;">
              <button class="pdf-btn" data-action="save-repair" onclick="saveRepairCard('${workshop}','${dns}','${sepName}',${i})">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–µ–º–æ–Ω—Ç</button>
              <button class="pdf-btn" data-action="close-repair" onclick="closeRepair('${workshop}','${dns}','${sepName}',${i})">–ó–∞–∫—Ä—ã—Ç—å —Ä–µ–º–æ–Ω—Ç (–≤ —Ä–∞–±–æ—Ç—É)</button>
            </div>

            <div class="journal">
              <h4>–ñ—É—Ä–Ω–∞–ª —Ä–∞–±–æ—Ç (–ö–∞–ø—Ä–µ–º–æ–Ω—Ç)</h4>
              <div class="grid">
                <label>–î–∞—Ç–∞</label>
                <input type="date" id="journalDate_s${workshop}${dnsSafe}${i}">
                <label>–ö—Ä–∞—Ç–∫–æ</label>
                <textarea id="journalText_s${workshop}${dnsSafe}${i}"></textarea>
                <label>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
                <input type="text" id="journalComment_s${workshop}${dnsSafe}${i}">
                <div class="full photo-row">
                  <input type="file" id="journalPhoto_s${workshop}${dnsSafe}${i}" accept="image/*">
                  <span class="smalltext">–§–æ—Ç–æ/–¥–µ—Ñ–µ–∫—Ç (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</span>
                </div>
                <div class="full">
                  <button class="pdf-btn" data-action="add-journal" onclick="addJournalEntry('${workshop}','${dns}','${sepName}',${i})">–î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å</button>
                </div>
              </div>
              <table id="journalTable_s${workshop}${dnsSafe}${i}" style="margin-top:10px;"></table>
            </div>
          </div>

          <div id="${tabN}" class="tab-content">
            <button class="pdf-btn" onclick="window.open('${nvoPath}')">–ù–í–û (PDF)</button>
            <div class="journal">
              <h4>–ñ—É—Ä–Ω–∞–ª (–ù–í–û ‚Äî –Ω–∞—Ä—É–∂–Ω—ã–π/–≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –æ—Å–º–æ—Ç—Ä)</h4>
              <div class="grid">
                <label>–î–∞—Ç–∞</label>
                <input type="date" id="journalDate_ns${workshop}${dnsSafe}${i}">
                <label>–ö—Ä–∞—Ç–∫–æ</label>
                <textarea id="journalText_ns${workshop}${dnsSafe}${i}"></textarea>
                <label>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
                <input type="text" id="journalComment_ns${workshop}${dnsSafe}${i}">
                <label>–ó–æ–Ω–∞ (–æ–±–µ—á–∞–π–∫–∞)</label>
                <select id="journalZone_ns${workshop}${dnsSafe}${i}" style="padding:10px; border-radius:12px; border:1px solid var(--border); background:var(--panel); color:var(--text);">
                  <option value="">–ê–≤—Ç–æ (–ø–æ —Ç–µ–∫—Å—Ç—É)</option>
                  <option value="–û–±–µ—á–∞–π–∫–∞ 1">–û–±–µ—á–∞–π–∫–∞ 1</option>
                  <option value="–û–±–µ—á–∞–π–∫–∞ 2">–û–±–µ—á–∞–π–∫–∞ 2</option>
                  <option value="–û–±–µ—á–∞–π–∫–∞ 3">–û–±–µ—á–∞–π–∫–∞ 3</option>
                  <option value="–û–±–µ—á–∞–π–∫–∞ 4">–û–±–µ—á–∞–π–∫–∞ 4</option>
                  <option value="–û–±–µ—á–∞–π–∫–∞ 5">–û–±–µ—á–∞–π–∫–∞ 5</option>
                  <option value="–û–±–µ—á–∞–π–∫–∞ 6">–û–±–µ—á–∞–π–∫–∞ 6</option>
                </select>
                <label>–í–∞–∂–Ω–æ—Å—Ç—å</label>
                <select id="journalSev_ns${workshop}${dnsSafe}${i}" style="padding:10px; border-radius:12px; border:1px solid var(--border); background:var(--panel); color:var(--text); width:160px;">
                  <option value="1">1</option>
                  <option value="2" selected>2</option>
                  <option value="3">3</option>
                </select>
                <div class="full photo-row">
                  <input type="file" id="journalPhoto_ns${workshop}${dnsSafe}${i}" accept="image/*">
                  <span class="smalltext">–§–æ—Ç–æ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</span>
                </div>
                <div class="full">
                  <button class="pdf-btn" data-action="add-journal" onclick="addJournalEntry('${workshop}','${dns}','${sepName}_n',${i},'n')">–î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å</button>
                </div>
              </div>
              <table id="journalTable_ns${workshop}${dnsSafe}${i}" style="margin-top:10px;"></table>
            </div>
          </div>

          <div id="${tabG}" class="tab-content">
            <button class="pdf-btn" onclick="window.open('${giPath}')">–ì–ò (PDF)</button>
            <div class="journal">
              <h4>–ñ—É—Ä–Ω–∞–ª (–ì–ò ‚Äî –≥–∏–¥—Ä–∞–≤–ª–∏—á–µ—Å–∫–æ–µ –∏—Å–ø—ã—Ç–∞–Ω–∏–µ)</h4>
              <div class="grid">
                <label>–î–∞—Ç–∞</label>
                <input type="date" id="journalDate_gs${workshop}${dnsSafe}${i}">
                <label>–ö—Ä–∞—Ç–∫–æ</label>
                <textarea id="journalText_gs${workshop}${dnsSafe}${i}"></textarea>
                <label>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
                <input type="text" id="journalComment_gs${workshop}${dnsSafe}${i}">
                <div class="full photo-row">
                  <input type="file" id="journalPhoto_gs${workshop}${dnsSafe}${i}" accept="image/*">
                  <span class="smalltext">–§–æ—Ç–æ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</span>
                </div>
                <div class="full">
                  <button class="pdf-btn" data-action="add-journal" onclick="addJournalEntry('${workshop}','${dns}','${sepName}_g',${i},'g')">–î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å</button>
                </div>
              </div>
              <table id="journalTable_gs${workshop}${dnsSafe}${i}" style="margin-top:10px;"></table>
            </div>
          </div>

          <div id="${tabE}" class="tab-content">
            <table>
              <tr><th>–≠–∫—Å–ø–µ—Ä—Ç–∏–∑–∞ –ø—Ä–æ–º—ã—à–ª–µ–Ω–Ω–æ–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ (–≠–ü–ë)</th><th>–î–∞–Ω–Ω—ã–µ</th></tr>
              <tr>
                <td>–ö–æ–≥–¥–∞ –ø—Ä–æ–≤–µ–¥–µ–Ω–∞ –≠–ü–ë (–¥–∞—Ç–∞)</td>
                <td>
                  <input data-epb-field type="date"
                         style="padding:10px; border-radius:12px; border:1px solid var(--border); background:var(--panel); color:var(--text);"
                         id="epbDate_${workshop}_${dnsSafe}_${i}">
                </td>
              </tr>
              <tr>
                <td>–†–µ–∑—É–ª—å—Ç–∞—Ç –≠–ü–ë</td>
                <td>
                  <select data-epb-field
                          style="padding:10px; border-radius:12px; border:1px solid var(--border); background:var(--panel); color:var(--text); font-weight:800;"
                          id="epbResult_${workshop}_${dnsSafe}_${i}"
                          onchange="updateEpbBadge('${workshop}','${dns}','${sepName}',${i})">
                    <option value="">‚Äî –Ω–µ —É–∫–∞–∑–∞–Ω–æ ‚Äî</option>
                    <option value="positive">–ü–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–µ</option>
                    <option value="negative">–û—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ–µ</option>
                  </select>
                  <div style="margin-top:8px;">
                    <span class="pill" id="epbBadge_${workshop}_${dnsSafe}_${i}">‚Äî</span>
                  </div>
</div>
</div>


</div>



</td>
              </tr>
              <tr>
                <td>–ü—Ä–æ–¥–ª–µ–Ω–∏–µ (–Ω–∞ —Å–∫–æ–ª—å–∫–æ)</td>
                <td style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
                  <input data-epb-field type="number" min="0"
                         style="width:220px; padding:10px; border-radius:12px; border:1px solid var(--border); background:var(--panel); color:var(--text);"
                         id="epbExtend_${workshop}_${dnsSafe}_${i}" placeholder="–¥–Ω–µ–π (–Ω–∞–ø—Ä–∏–º–µ—Ä 365)">
                  <span class="smalltext">–ú–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å –ø—É—Å—Ç—ã–º</span>
                </td>
              </tr>
              <tr>
                <td>–§–∞–π–ª –≠–ü–ë (PDF)</td>
                <td>
                  <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
                    <input data-epb-field type="file" accept="application/pdf"
                           id="epbFile_${workshop}_${dnsSafe}_${i}">
                    <button class="pdf-btn" data-action="save-epb" onclick="saveEpb('${workshop}','${dns}','${sepName}',${i})">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≠–ü–ë</button>
                    <button class="pdf-btn" id="epbOpenBtn_${workshop}_${dnsSafe}_${i}" onclick="openEpbPdf('${workshop}','${dns}','${sepName}',${i})" disabled>–û—Ç–∫—Ä—ã—Ç—å PDF</button>
                  </div>
                  <div class="smalltext" id="epbFileName_${workshop}_${dnsSafe}_${i}" style="margin-top:6px;">–§–∞–π–ª: ‚Äî</div>
                </td>
              </tr>
            </table>
          </div>
<div id="${tabD}" class="tab-content">
            <div id="pdBox_${workshop}_${dnsSafe}_${i}"></div>
          </div>



        </div>
      </div>
    `;

    const sel = document.getElementById(`statusSelect_${workshop}_${dnsSafe}_${i}`);
    if (sel) sel.value = st;

    fillRepairCardUI(workshop, dns, sepName, i);
    renderJournal(workshop, dns, sepName, i);
    renderJournal(workshop, dns, sepName + "_n", i, "n");
    renderJournal(workshop, dns, sepName + "_g", i, "g");
    markInspectOverdueOutline(workshop, dns, sepName, i);
    fillEpbUI(workshop, dns, sepName, i);
    updateTabCounts(workshop, dns, i, sepName);
    renderPredictedDefects(workshop, dns, sepName, i);
  });
}


/* =====================
   Status change
===================== */
function onStatusChange(workshop, dns, sepName, index, value){
  const role = getRole();
  if (!(role === "editor" || role === "admin")){
    alert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤");
    applyPermissionsToUI();
    return;
  }
  const prev = getStatus(workshop, dns, sepName);
  if (prev !== value){
    if (prev !== "repair" && value === "repair") onRepairStart(workshop, dns, sepName);
    if (prev === "repair" && value === "working") onRepairEnd(workshop, dns, sepName);
  }
  setStatus(workshop, dns, sepName, value);
  const sepEl = document.querySelector(`.separator[data-sep-index="${index}"]`);
  if (sepEl) sepEl.setAttribute("data-status", value);
  updateRepairInfoLine(workshop, dns, sepName, index);
  saveOpenSeparator(index);
  renderSummary(workshop, dns);
  applyFilter();
  if (document.getElementById("repairListOverlay").style.display !== "none") refreshRepairList();
}

/* =====================
   Restore last selection
===================== */
function restoreLastSelection(){
  const role = getRole();
  if (!role) return;

  const ws = localStorage.getItem(UI.wsKey) || "";
  const dns = localStorage.getItem(UI.dnsKey) || "";

  if (!ws){
    document.getElementById("emptyState").style.display = "block";
    return;
  }
  const wsSel = document.getElementById("workshopSelect");
  wsSel.value = ws;
  selectWorkshop(ws);

  if (dns){
    const dnsSel = document.getElementById("dnsSelect");
    dnsSel.value = dns;
    loadDNS();
  }
}


/* =====================
   Top nav + Settings + Data tools
===================== */
function setTopNav(btn){
  document.querySelectorAll(".top-link").forEach(b=>b.classList.remove("active"));
  btn.classList.add("active");
}
function focusNav(where){
  // where: home | analytics | docs | work
  if (where === "home"){
    window.scrollTo({top:0, behavior:"smooth"});
    return;
  }
  if (where === "analytics"){
    const el = document.getElementById("dashBox") || document.getElementById("dnsSummary");
    if (el) el.scrollIntoView({behavior:"smooth", block:"start"});
    return;
  }
  if (where === "docs"){
    const firstSep = document.querySelector(".separator");
    if (firstSep) firstSep.scrollIntoView({behavior:"smooth", block:"start"});
    return;
  }
  if (where === "work"){
    const el = document.querySelector(".filters") || document.getElementById("workshopSelect");
    if (el) el.scrollIntoView({behavior:"smooth", block:"start"});
    return;
  }
}
function openSettings(){ document.getElementById("settingsOverlay").style.display = "flex"; renderCustomFieldsSettings(); }
function closeSettings(){ document.getElementById("settingsOverlay").style.display = "none"; }

function updateHeroBadges(workshop, dns, stats){
  const set = (id, val)=>{ const el=document.getElementById(id); if(el) el.textContent = String(val ?? "‚Äî"); };
  set("hbWs", workshop || "‚Äî");
  set("hbDns", dns || "‚Äî");
  set("hbRepair", stats?.repairCount ?? "‚Äî");
  set("hbBad", stats?.totalBad ?? "‚Äî");
}

function exportData(){
  try{
    const data = {};
    for (let i=0; i<localStorage.length; i++){
      const k = localStorage.key(i);
      data[k] = localStorage.getItem(k);
    }
    const payload = {
      meta: {
        app: "SNG DNS Separators (offline)",
        version: APP_VERSION,
        exportedAt: new Date().toISOString(),
        timezone: "Europe/Berlin",
        schema: 1
      },
      data
    };

    const blob = new Blob([JSON.stringify(payload, null, 2)], {type:"application/json"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `sng_dns_backup_${todayISO()}_${Date.now()}.json`;
    a.click();
    URL.revokeObjectURL(a.href);
  }catch(e){
    alert("–≠–∫—Å–ø–æ—Ä—Ç –Ω–µ —É–¥–∞–ª—Å—è: " + (e?.message || e));
  }
}

function _normalizeImportedObject(raw){
  // support legacy flat export {key:value} and new {meta, data}
  if (!raw || typeof raw !== "object") throw new Error("–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞");
  const data = (raw.data && typeof raw.data === "object") ? raw.data : raw;
  if (!data || typeof data !== "object") throw new Error("–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö");

  // Basic sanity check: keys must be strings
  const out = {};
  let count = 0;
  for (const k of Object.keys(data)){
    if (typeof k !== "string") continue;
    // values in localStorage are strings; convert anything else to string safely
    const v = data[k];
    out[k] = (v === null || v === undefined) ? "" : String(v);
    count++;
  }
  if (count === 0) throw new Error("–í —Ñ–∞–π–ª–µ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞");
  return out;
}

function _isKeyInScope(ws, dnsSafe, key){
  // Scope by current workshop + DNS for keys that embed ws + dns
  if (!ws || !dnsSafe) return false;
  const needle = `_${ws}_${dnsSafe}_`;
  if (!key.includes(needle)) return false;

  // Only keys related to equipment records (avoid nuking global UI prefs)
  const prefixes = [
    "sepStatus_","repairStart_","repairHist_",
    "card_","repairCard_","epb_","journal_",
    "pd_","ui_open_tab_"
  ];
  return prefixes.some(p => key.startsWith(p));
}

function _clearScope(ws, dns){
  const dnsSafe = safeIdPart(dns);
  const toRemove = [];
  for (let i=0; i<localStorage.length; i++){
    const k = localStorage.key(i);
    if (_isKeyInScope(ws, dnsSafe, k)) toRemove.push(k);
  }
  toRemove.forEach(k=>localStorage.removeItem(k));
}

function importData(file){
  if (!file) return;
  const r = new FileReader();
  r.onload = () => {
    try{
      const raw = JSON.parse(String(r.result || "{}"));
      const obj = _normalizeImportedObject(raw);

      const ws = localStorage.getItem(UI.wsKey) || "";
      const dns = localStorage.getItem(UI.dnsKey) || "";

      const scopeAns = prompt(
        `–ò–º–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö:
1 ‚Äî –í—Å—è –±–∞–∑–∞ (–≤—Å–µ —Ü–µ—Ö–∞/–î–ù–°)
2 ‚Äî –¢–æ–ª—å–∫–æ —Ç–µ–∫—É—â–∏–π —Ü–µ—Ö –∏ –î–ù–°

–í–≤–µ–¥–∏—Ç–µ 1 –∏–ª–∏ 2:`,
        "1"
      );
      const scope = (String(scopeAns || "1").trim() === "2") ? "current" : "all";

      const replace = confirm(
        `–†–µ–∂–∏–º –∏–º–ø–æ—Ä—Ç–∞:
–û–ö ‚Äî –ó–ê–ú–ï–ù–ò–¢–¨ –¥–∞–Ω–Ω—ã–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –æ–±–ª–∞—Å—Ç–∏
–û—Ç–º–µ–Ω–∞ ‚Äî –û–ë–™–ï–î–ò–ù–ò–¢–¨ (–¥–æ–±–∞–≤–∏—Ç—å/–æ–±–Ω–æ–≤–∏—Ç—å, –Ω–µ —É–¥–∞–ª—è—è –ª–∏—à–Ω–µ–µ)`
      );

      if (replace){
        if (scope === "all"){
          // keep theme maybe? user asked replace all; we truly replace all
          localStorage.clear();
        }else{
          if (!ws || !dns){
            alert("–ù–µ –≤—ã–±—Ä–∞–Ω —Ç–µ–∫—É—â–∏–π —Ü–µ—Ö/–î–ù–° ‚Äî –∏–º–ø–æ—Ä—Ç –ø–æ –æ–±–ª–∞—Å—Ç–∏ –Ω–µ–≤–æ–∑–º–æ–∂–µ–Ω. –í—ã–±–µ—Ä–∏ —Ü–µ—Ö –∏ –î–ù–° –∏ –ø–æ–≤—Ç–æ—Ä–∏.");
            return;
          }
          _clearScope(ws, dns);
        }
      }

      let written = 0;
      if (scope === "all"){
        for (const k of Object.keys(obj)){
          try{ localStorage.setItem(k, obj[k]); written++; }catch(e){}
        }
      }else{
        const dnsSafe = safeIdPart(dns);
        for (const k of Object.keys(obj)){
          if (_isKeyInScope(ws, dnsSafe, k)){
            try{ localStorage.setItem(k, obj[k]); written++; }catch(e){}
          }
        }
      }

      alert(`–ò–º–ø–æ—Ä—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω ‚úÖ –ó–∞–ø–∏—Å–∞–Ω–æ –∫–ª—é—á–µ–π: ${written}.
–ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—É (F5).`);
    }catch(e){
      alert("–ò–º–ø–æ—Ä—Ç –Ω–µ —É–¥–∞–ª—Å—è: " + (e?.message || e));
    }finally{
      const el = document.getElementById('importFile');
      if (el) el.value = '';
    }
  };
  r.readAsText(file);
}

function resetData(){
  const role = getRole();
  if (role !== "admin"){
    alert("–°–±—Ä–æ—Å –¥–æ—Å—Ç—É–ø–µ–Ω —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É");
    return;
  }
  if (!confirm("–°–±—Ä–æ—Å–∏—Ç—å localStorage –¥–ª—è —ç—Ç–æ–≥–æ —Å–∞–π—Ç–∞? –≠—Ç–æ —É–¥–∞–ª–∏—Ç —Å—Ç–∞—Ç—É—Å—ã/–∂—É—Ä–Ω–∞–ª—ã/–∫–∞—Ä—Ç–æ—á–∫–∏.")) return;
  localStorage.clear();
  sessionStorage.clear();
  alert("–ì–æ—Ç–æ–≤–æ. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—É.");
}



/* =====================
   Predicted defects (—É—Ç–æ–Ω—á–µ–Ω–∏–µ –º–µ—Ç–∞–ª–ª–∞) ‚Äî UI + model + scheme
===================== */
function pdKey(workshop, dns, sepName){
  return `pd_${workshop}_${safeIdPart(dns)}_${safeIdPart(sepName)}`;
}
function getPd(workshop, dns, sepName){
  return safeGetJSON(pdKey(workshop, dns, sepName), {
    t0: 16,
    tmin: 12,
    years: 3,
    tempC: 40,
    water: "med",     // low|med|high (–æ–±–≤–æ–¥–Ω–µ–Ω–Ω–æ—Å—Ç—å)
    co2: "no",        // no|yes
    h2s: "no",        // no|yes
    inhibitor: "no",  // no|yes
    flowRegime: "norm", // low|norm|high (—Ç—É—Ä–±—É–ª–µ–Ω—Ç–Ω–æ—Å—Ç—å/—Ä–µ–∂–∏–º)
    salts: "med",     // low|med|high
    solids: "no",     // no|yes
    flow: "norm",     // low|norm|high
    coat: "yes",      // yes|no
    shellCount: 6,    // 6 or 7 (user can set)
    objects: [],      // {id, type, shell, pos, note}
    selShell: 1,
    lnk: [] // {id,date,shell,t}
  });
}
function savePd(workshop, dns, sepName, data){
  safeSetItem(pdKey(workshop, dns, sepName), JSON.stringify(data));
}
function pdTypeLabel(t){
  if (t==="nozzle") return "–ü–∞—Ç—Ä—É–±–æ–∫";
  if (t==="flange") return "–§–ª–∞–Ω–µ—Ü";
  if (t==="hatch")  return "–õ—é–∫";
  if (t==="zone")   return "–ó–æ–Ω–∞";
  return t || "–û–±—ä–µ–∫—Ç";
}
function pdPosLabel(p){
  if (p==="inlet") return "–í—Ö–æ–¥";
  if (p==="outlet") return "–í—ã—Ö–æ–¥";
  if (p==="top") return "–í–µ—Ä—Ö";
  if (p==="bottom") return "–ù–∏–∑";
  return "–°–µ—Ä–µ–¥–∏–Ω–∞";
}

function pdCompute(workshop, dns, sepName, pd){
  const N = Math.max(5, Math.min(9, parseInt(pd.shellCount||6,10)));
  const base = Array.from({length:N}, ()=>0);

  // Repairs / replacements per shell (year-based). If a shell was replaced,
  // LNK points before the replacement year are ignored for that shell.
  const repairs = Array.isArray(pd.repairs) ? pd.repairs : [];
  const repByShell = {};
  repairs.forEach(r=>{
    const s = Math.max(1, Math.min(N, parseInt(r.shell||1,10)));
    const y = parseInt(r.year||0,10);
    const t = parseFloat(r.t);
    if (!Number.isFinite(y) || y<1900 || y>2100 || !Number.isFinite(t)) return;
    const d = new Date(y,0,1);
    // Keep latest repair per shell
    const prev = repByShell[s];
    if (!prev || d > prev.d) repByShell[s] = {d, y, t:+t.toFixed(2)};
  });

  // Empirical corrosion rates from LNK (if at least 2 points per shell)
  const lnk = Array.isArray(pd.lnk) ? pd.lnk : [];
  const lnkByShell = {};
  lnk.forEach(p=>{
    const s = Math.max(1, Math.min(N, parseInt(p.shell||1,10)));
    const d = new Date(p.date);
    const t = parseFloat(p.t);
    if (!Number.isFinite(t) || isNaN(d.getTime())) return;
    (lnkByShell[s] ||= []).push({d, t});
  });
  const empRates = Array.from({length:N}, ()=>null);
  for (let s=1; s<=N; s++){
    const minD = repByShell[s]?.d;
    const arr = (lnkByShell[s]||[]).filter(p=> !minD || p.d >= minD ).sort((a,b)=>a.d-b.d);
    if (arr.length >= 2){
      const a = arr[0], b = arr[arr.length-1];
      const years = (b.d - a.d) / (1000*60*60*24*365.25);
      if (years > 0.05){
        const r = (a.t - b.t) / years;
        if (Number.isFinite(r)) empRates[s-1] = Math.max(0, Math.min(3.0, r));
      }
    }
  }

  // Conditions: explainable scoring (not "magic")
  // Flow + solids -> erosion at inlet shells (1-2)
  if (pd.flow === "high" && pd.solids === "yes"){
    base[0] += 35; if (N>1) base[1] += 22;
  } else if (pd.flow === "high"){
    base[0] += 18; if (N>1) base[1] += 10;
  } else if (pd.solids === "yes"){
    base[0] += 16; if (N>1) base[1] += 9;
  }

  // Salts + no coating -> general corrosion; emphasize bottom zones slightly (we map to all shells)
  if (pd.salts === "high" && pd.coat === "no"){
    for (let i=0;i<N;i++) base[i] += 18;
  } else if (pd.salts === "high"){
    for (let i=0;i<N;i++) base[i] += 10;
  } else if (pd.salts === "med"){
    for (let i=0;i<N;i++) base[i] += 6;
  }

  // Coating reduces risk
  if (pd.coat === "yes"){
    for (let i=0;i<N;i++) base[i] -= 6;
  }

  // Objects add local contributions

  // Temperature accelerates corrosion (rough engineering proxy)
  const temp = Math.max(0, parseFloat(pd.tempC ?? 40));
  if (temp >= 70) { for (let i=0;i<N;i++) base[i] += 8; }
  else if (temp >= 50) { for (let i=0;i<N;i++) base[i] += 4; }

  // Water cut (–æ–±–≤–æ–¥–Ω–µ–Ω–Ω–æ—Å—Ç—å) increases corrosion likelihood
  if (pd.water === "high") { for (let i=0;i<N;i++) base[i] += 10; }
  else if (pd.water === "med") { for (let i=0;i<N;i++) base[i] += 5; }

  // CO2 / H2S presence increases corrosion (simplified)
  if (pd.co2 === "yes") { for (let i=0;i<N;i++) base[i] += 8; }
  if (pd.h2s === "yes") { for (let i=0;i<N;i++) base[i] += 6; }

  // Inhibitor reduces risk if present
  if (pd.inhibitor === "yes") { for (let i=0;i<N;i++) base[i] -= 6; }

  // Flow regime / turbulence (besides flow speed) can add erosion/corrosion
  if (pd.flowRegime === "high") { base[0] += 6; if (N>1) base[1] += 3; }

  const objWeights = { nozzle: 10, flange: 6, hatch: 4, zone: 12 };
  (pd.objects||[]).forEach(o=>{
    const s = Math.max(1, Math.min(N, parseInt(o.shell||1,10)));
    base[s-1] += (objWeights[o.type] ?? 5);
    // inlet/outlet positions slightly boost effect
    if (o.pos === "inlet" || o.pos === "outlet") base[s-1] += 3;
    if (o.pos === "bottom" && pd.salts !== "low") base[s-1] += 2;
  });

  // Convert score -> corrosion rate estimate (mm/year)
  // Simplified engineering proxy; later calibrated per object/site.
  const modelRates = base.map(sc=>{
    const r = 0.10 + Math.max(0, sc) * 0.006; // 0.10.. ~1.5
    return Math.min(1.50, Math.max(0.02, r));
  });

  // If LNK provides empirical rates, blend (empirical has priority)
  const rates = modelRates.map((r,i)=>{
    const er = empRates[i];
    if (Number.isFinite(er)) return Math.min(3.0, Math.max(r, er));
    return r;
  });

  const t0 = Math.max(0, parseFloat(pd.t0||16));
  const tmin = Math.max(0, parseFloat(pd.tmin||12));
  const years = Math.max(0.5, Math.min(20, parseFloat(pd.years||3)));

  // Current thickness per shell: if LNK exists for shell, use the latest measurement,
  // otherwise fall back to t0.
  const today = new Date();
  const curT = Array.from({length:N}, ()=>t0);
  const curD = Array.from({length:N}, ()=>today);

  for (let s=1; s<=N; s++){
    const minD = repByShell[s]?.d;
    const arr = (lnkByShell[s]||[]).slice().filter(p=> !minD || p.d >= minD ).sort((a,b)=>a.d-b.d);
    if (arr.length){
      const last = arr[arr.length-1];
      curT[s-1] = Math.max(0, +(+last.t).toFixed(2));
      curD[s-1] = last.d;
    } else if (repByShell[s]){
      curT[s-1] = Math.max(0, +(+repByShell[s].t).toFixed(2));
      curD[s-1] = repByShell[s].d;
    }
  }

  // Forecast: thickness at horizon and remaining life (years to reach tmin)
  const predicted = rates.map((r,i) => Math.max(0, +(curT[i] - r*years).toFixed(2)));
  const margin = predicted.map(t => +(t - tmin).toFixed(2));

  const lifeYears = rates.map((r,i)=>{
    const tcur = curT[i];
    if (!Number.isFinite(r) || r <= 0) return 99;
    const ly = (tcur - tmin) / r;
    if (!Number.isFinite(ly)) return 99;
    return Math.max(0, Math.min(99, +ly.toFixed(2)));
  });

  const crossDate = lifeYears.map((ly,i)=>{
    const baseD = curD[i] instanceof Date ? curD[i] : today;
    if (!Number.isFinite(ly) || ly >= 99) return null;
    const ms = baseD.getTime() + ly*365.25*24*60*60*1000;
    const d = new Date(ms);
    if (isNaN(d.getTime())) return null;
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth()+1).padStart(2,"0");
    const dd = String(d.getDate()).padStart(2,"0");
    return `${yyyy}-${mm}-${dd}`;
  });

  const levelOf = (m, r, ly)=>{
    if (m <= 0 || ly <= 0.5) return "bad";
    if (m <= 1.0 || r >= 1.0 || ly <= 2.0) return "warn";
    return "ok";
  };

  const shells = Array.from({length:N}, (_,i)=>({
    shell: i+1,
    score: Math.round(base[i]),
    rate: +rates[i].toFixed(3),
    tcur: +curT[i].toFixed(2),
    t: predicted[i],
    m: margin[i],
    life: lifeYears[i],
    cross: crossDate[i],
    level: levelOf(margin[i], rates[i], lifeYears[i])
  }));

  // Overall: worst shell drives (by smallest remaining life, then margin)
  const worst = [...shells].sort((a,b)=> (a.life-b.life) || (a.m-b.m) )[0];
  const overall = worst.level;

  return {N, shells, overall, t0, tmin, years, worst};
}


function pdColor(level){
  if (level==="bad") return "color-mix(in srgb, var(--bad) 35%, transparent)";
  if (level==="warn") return "color-mix(in srgb, var(--warn) 30%, transparent)";
  return "color-mix(in srgb, var(--ok) 26%, transparent)";
}
function pdStroke(level){
  if (level==="bad") return "color-mix(in srgb, var(--bad) 70%, var(--border))";
  if (level==="warn") return "color-mix(in srgb, var(--warn) 70%, var(--border))";
  return "color-mix(in srgb, var(--ok) 65%, var(--border))";
}

/* ===== Simple canvas chart (no external libs) =====
   Visualizes thickness vs years for selected shell, plus tmin line.
*/
function pdGetShellBaseDate(pd, shell){
  const s = parseInt(shell||1,10);
  const repairs = Array.isArray(pd?.repairs) ? pd.repairs : [];
  const lnk = Array.isArray(pd?.lnk) ? pd.lnk : [];

  // Latest repair for this shell
  let repD = null;
  let repY = null;
  repairs.forEach(r=>{
    const rs = parseInt(r.shell||0,10);
    const y = parseInt(r.year||0,10);
    if (rs !== s) return;
    if (!Number.isFinite(y) || y < 1900 || y > 2100) return;
    const d = new Date(y,0,1);
    if (!repD || d > repD){ repD = d; repY = y; }
  });

  // Latest LNK after repair (if any)
  let last = null;
  lnk.forEach(p=>{
    const ps = parseInt(p.shell||0,10);
    if (ps !== s) return;
    const d = new Date(p.date);
    if (isNaN(d.getTime())) return;
    if (repD && d < repD) return;
    if (!last || d > last) last = d;
  });

  return { base: (last || repD || new Date()), repYear: repY };
}

function pdDrawThicknessChart(canvas, points, tmin){
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  if (!ctx) return;

  const cssW = canvas.clientWidth || 640;
  const cssH = canvas.clientHeight || 220;
  const dpr = Math.max(1, Math.floor(window.devicePixelRatio || 1));
  canvas.width = Math.floor(cssW * dpr);
  canvas.height = Math.floor(cssH * dpr);
  ctx.setTransform(dpr,0,0,dpr,0,0);

  ctx.clearRect(0,0,cssW,cssH);

  const padL = 44, padR = 14, padT = 14, padB = 34;
  const w = cssW - padL - padR;
  const h = cssH - padT - padB;

  const xs = points.map(p=>p.x);
  const ys = points.map(p=>p.y);
  const minX = Math.min(...xs), maxX = Math.max(...xs);
  const minY = Math.min(Math.min(...ys), tmin);
  const maxY = Math.max(...ys, tmin);

  const yPad = Math.max(0.5, (maxY-minY)*0.1);
  const y0 = Math.max(0, minY - yPad);
  const y1 = maxY + yPad;

  const toX = (x)=> padL + (maxX===minX ? 0 : (x-minX)/(maxX-minX))*w;
  const toY = (y)=> padT + (y1===y0 ? h/2 : (y1-y)/(y1-y0))*h;

  // Grid + axes
  ctx.lineWidth = 1;
  ctx.strokeStyle = 'rgba(255,255,255,0.12)';
  ctx.fillStyle = 'rgba(255,255,255,0.72)';
  ctx.font = '12px Roboto, system-ui, -apple-system, Segoe UI, Arial';

  // Y ticks
  const ticks = 4;
  for (let i=0;i<=ticks;i++){
    const yv = y0 + (y1-y0)*(i/ticks);
    const yy = toY(yv);
    ctx.beginPath();
    ctx.moveTo(padL, yy);
    ctx.lineTo(padL+w, yy);
    ctx.stroke();
    ctx.fillText(String(yv.toFixed(1)), 6, yy+4);
  }

  // X ticks (years)
  const xCount = Math.min(6, points.length-1);
  for (let i=0;i<=xCount;i++){
    const xi = minX + (maxX-minX)*(i/xCount);
    const xx = toX(xi);
    ctx.beginPath();
    ctx.moveTo(xx, padT);
    ctx.lineTo(xx, padT+h);
    ctx.stroke();
    ctx.fillText(String(Math.round(xi)), xx-10, padT+h+22);
  }

  // Axis line
  ctx.strokeStyle = 'rgba(255,255,255,0.22)';
  ctx.beginPath();
  ctx.moveTo(padL, padT);
  ctx.lineTo(padL, padT+h);
  ctx.lineTo(padL+w, padT+h);
  ctx.stroke();

  // tmin line
  const yTmin = toY(tmin);
  ctx.strokeStyle = 'rgba(255,160,80,0.75)';
  ctx.setLineDash([6,4]);
  ctx.beginPath();
  ctx.moveTo(padL, yTmin);
  ctx.lineTo(padL+w, yTmin);
  ctx.stroke();
  ctx.setLineDash([]);
  ctx.fillStyle = 'rgba(255,160,80,0.85)';
  ctx.fillText('tmin', padL+w-34, yTmin-6);

  // Series
  ctx.strokeStyle = 'rgba(150,210,255,0.95)';
  ctx.lineWidth = 2;
  ctx.beginPath();
  points.forEach((p,idx)=>{
    const xx = toX(p.x);
    const yy = toY(p.y);
    if (idx===0) ctx.moveTo(xx,yy); else ctx.lineTo(xx,yy);
  });
  ctx.stroke();

  // Points
  ctx.fillStyle = 'rgba(150,210,255,0.95)';
  points.forEach(p=>{
    const xx = toX(p.x), yy = toY(p.y);
    ctx.beginPath();
    ctx.arc(xx,yy,3.2,0,Math.PI*2);
    ctx.fill();
  });
}

function pdBuildSeries(pd, calc, shell){
  const s = Math.max(1, Math.min(calc.N, parseInt(shell||1,10)));
  const row = calc.shells.find(x=>x.shell===s);
  if (!row) return [];

  const {base} = pdGetShellBaseDate(pd, s);
  const startYear = base.getFullYear();

  const horizon = Math.max(0.5, Math.min(20, parseFloat(calc.years||3)));
  const step = 1; // years

  const pts = [];
  for (let dy=0; dy<=Math.floor(horizon+1e-9); dy+=step){
    const y = startYear + dy;
    const t = Math.max(0, +(row.tcur - row.rate*dy).toFixed(2));
    pts.push({x:y, y:t});
  }
  // ensure last point at horizon (even if non-integer)
  if (Math.abs(horizon - Math.floor(horizon)) > 1e-9){
    const y = startYear + horizon;
    const t = Math.max(0, +(row.tcur - row.rate*horizon).toFixed(2));
    pts.push({x:y, y:t});
  }
  // unique by x
  const seen = new Set();
  return pts.filter(p=>{ const k=String(p.x); if(seen.has(k)) return false; seen.add(k); return true; });
}

function pdRenderChart(workshop, dns, sepName, index, pd, calc){
  const dnsSafe = safeIdPart(dns);
  const shell = Math.max(1, Math.min(calc.N, parseInt(pd.selShell||1,10)));
  const canvas = document.getElementById(`pd_chart_${workshop}_${dnsSafe}_${index}`);
  if (!canvas) return;
  const pts = pdBuildSeries(pd, calc, shell);
  if (!pts.length) return;
  pdDrawThicknessChart(canvas, pts, calc.tmin);
}

/* ===== Export / Print report for Predicted Defects ===== */
function pdBuildReportData(workshop, dns, sepName){
  const pd = getPd(workshop, dns, sepName);
  const calc = pdCompute(workshop, dns, sepName, pd);
  const meta = {workshop, dns, sepName, generated: todayISO(), t0: calc.t0, tmin: calc.tmin, years: calc.years, commYear: (pd.commYear||"")};
  const shells = [...calc.shells].sort((a,b)=> (a.life-b.life) || (a.m-b.m));
  return {meta, pd, calc, shells};
}

function pdExportCsv(workshop, dns, sepName, index){
  try{
    const {meta, shells} = pdBuildReportData(workshop, dns, sepName);
    const lines = [];
    lines.push(["–¶–î–ù–ì", "–î–ù–°", "–°–µ–ø–∞—Ä–∞—Ç–æ—Ä", "–î–∞—Ç–∞", "t0", "tmin", "–ì–æ—Ä–∏–∑–æ–Ω—Ç(–ª–µ—Ç)", "–í–≤–æ–¥ –≤ —ç–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏—é"].join(";"));
    lines.push([meta.workshop, meta.dns, meta.sepName, meta.generated, meta.t0, meta.tmin, meta.years, (meta.commYear||"")].map(v=>String(v).replaceAll(";"," ")).join(";"));
    lines.push("");
    lines.push(["–û–±–µ—á–∞–π–∫–∞","t_—Ç–µ–∫(–º–º)","v(–º–º/–≥–æ–¥)","t_–ø—Ä–æ–≥–Ω–æ–∑(–º–º)","–ó–∞–ø–∞—Å(–º–º)","–†–µ—Å—É—Ä—Å(–ª–µ—Ç)","–î–∞—Ç–∞ tmin","–°—Ç–∞—Ç—É—Å"].join(";"));
    shells.forEach(s=>{
      const status = (s.level==="bad") ? "–ö—Ä–∏—Ç–∏—á–Ω–æ" : (s.level==="warn" ? "–í–Ω–∏–º–∞–Ω–∏–µ" : "–ù–æ—Ä–º–∞");
      lines.push([`–û${s.shell}`, s.tcur, s.rate, s.t, s.m, s.life, (s.cross||""), status].join(";"));
    });
    const blob = new Blob(["\ufeff"+lines.join("\n")], {type:"text/csv;charset=utf-8"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `pd_report_${safeIdPart(meta.workshop)}_${safeIdPart(meta.dns)}_${safeIdPart(meta.sepName)}_${meta.generated}.csv`;
    a.click();
    URL.revokeObjectURL(a.href);
  }catch(e){
    alert("–≠–∫—Å–ø–æ—Ä—Ç CSV –Ω–µ —É–¥–∞–ª—Å—è: " + (e?.message || e));
  }
}

function pdPrintReport(workshop, dns, sepName, index){
  try{
    const {meta, pd, shells, calc} = pdBuildReportData(workshop, dns, sepName);

    const objects = (pd.objects||[]).map(o=>{
      return `<tr><td>${escapeHtml(pdTypeLabel(o.type))}</td><td>–û${escapeHtml(String(o.shell))}</td><td>${escapeHtml(pdPosLabel(o.pos))}</td><td>${escapeHtml(o.note||"")}</td></tr>`;
    }).join("") || `<tr><td colspan="4">‚Äî</td></tr>`;

    const lnk = (pd.lnk||[]).slice().sort((a,b)=>(a.date||"").localeCompare(b.date||"") || (a.shell-b.shell)).map(p=>{
      return `<tr><td>${escapeHtml(String(p.date||""))}</td><td>–û${escapeHtml(String(p.shell))}</td><td>${escapeHtml(String(p.t))}</td></tr>`;
    }).join("") || `<tr><td colspan="3">‚Äî</td></tr>`;

    const rows = shells.map(s=>{
      const status = (s.level==="bad") ? "–ö—Ä–∏—Ç–∏—á–Ω–æ" : (s.level==="warn" ? "–í–Ω–∏–º–∞–Ω–∏–µ" : "–ù–æ—Ä–º–∞");
      return `<tr>
        <td><b>–û${s.shell}</b></td>
        <td>${s.tcur}</td>
        <td>${s.rate}</td>
        <td>${s.t}</td>
        <td>${s.m}</td>
        <td>${s.life}</td>
        <td>${s.cross ? escapeHtml(String(s.cross)) : "‚Äî"}</td>
        <td>${status}</td>
      </tr>`;
    }).join("");

    const htmlDoc = `<!doctype html><html><head><meta charset="utf-8">
      <title>–û—Ç—á—ë—Ç: –ü—Ä–æ–≥–Ω–æ–∑–∏—Ä—É–µ–º—ã–µ –¥–µ—Ñ–µ–∫—Ç—ã</title>
      <style>
        body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; margin:24px; color:#111;}
        h1{font-size:18px; margin:0 0 10px;}
        h2{font-size:14px; margin:18px 0 8px;}
        .meta{display:grid; grid-template-columns: 220px 1fr; gap:6px 14px; font-size:12px; margin-bottom:10px;}
        .meta div{padding:2px 0;}
        table{border-collapse:collapse; width:100%; font-size:12px;}
        th,td{border:1px solid #cfcfcf; padding:6px 8px; vertical-align:top;}
        th{background:#f2f4f7; text-align:left;}
        .small{font-size:11px; color:#444;}
        .kpi{display:flex; gap:10px; flex-wrap:wrap; margin:10px 0 0;}
        .kpi span{border:1px solid #cfcfcf; border-radius:10px; padding:6px 10px; font-size:12px;}
        @media print{
          body{margin:12mm;}
          button{display:none !important;}
        }
      </style>
    </head><body>
      <h1>–û—Ç—á—ë—Ç: –ü—Ä–æ–≥–Ω–æ–∑–∏—Ä—É–µ–º—ã–µ –¥–µ—Ñ–µ–∫—Ç—ã (—É—Ç–æ–Ω—á–µ–Ω–∏–µ –º–µ—Ç–∞–ª–ª–∞)</h1>
      <div class="meta">
        <div><b>–¶–î–ù–ì</b></div><div>${escapeHtml(String(meta.workshop||""))}</div>
        <div><b>–î–ù–°</b></div><div>${escapeHtml(String(meta.dns||""))}</div>
        <div><b>–°–µ–ø–∞—Ä–∞—Ç–æ—Ä</b></div><div>${escapeHtml(String(meta.sepName||""))}</div>
        <div><b>–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–æ</b></div><div>${escapeHtml(String(meta.generated))}</div>
        <div><b>t0 (–¥–ª—è —Ä–∞—Å—á—ë—Ç–∞)</b></div><div>${escapeHtml(String(meta.t0))} –º–º</div>
        <div><b>tmin</b></div><div>${escapeHtml(String(meta.tmin))} –º–º</div>
        <div><b>–ì–æ—Ä–∏–∑–æ–Ω—Ç –ø—Ä–æ–≥–Ω–æ–∑–∞</b></div><div>${escapeHtml(String(meta.years))} –ª–µ—Ç</div>
      </div>

      <div class="kpi">
        <span><b>–ò—Ç–æ–≥:</b> ${escapeHtml((calc.overall==="bad") ? "–ö—Ä–∏—Ç–∏—á–Ω–æ" : (calc.overall==="warn" ? "–¢—Ä–µ–±—É–µ—Ç –≤–Ω–∏–º–∞–Ω–∏—è" : "–ù–æ—Ä–º–∞"))}</span>
        <span><b>–•—É–¥—à–∞—è:</b> –û${escapeHtml(String(calc.worst.shell))}</span>
        <span><b>–†–µ—Å—É—Ä—Å —Ö—É–¥—à–µ–π:</b> ${escapeHtml(String(calc.worst.life))} –ª–µ—Ç</span>
        <span><b>–î–æ tmin:</b> ${calc.worst.cross ? escapeHtml(String(calc.worst.cross)) : "‚Äî"}</span>
      </div>

      <h2>–†–µ–π—Ç–∏–Ω–≥ –æ–±–µ—á–∞–µ–∫</h2>
      <table>
        <tr><th>–û–±–µ—á–∞–π–∫–∞</th><th>t_—Ç–µ–∫, –º–º</th><th>v, –º–º/–≥–æ–¥</th><th>t —á–µ—Ä–µ–∑ ${escapeHtml(String(meta.years))} –ª–µ—Ç, –º–º</th><th>–ó–∞–ø–∞—Å, –º–º</th><th>–†–µ—Å—É—Ä—Å, –ª–µ—Ç</th><th>–î–∞—Ç–∞ tmin</th><th>–°—Ç–∞—Ç—É—Å</th></tr>
        ${rows}
      </table>

      <h2>–£—Å–ª–æ–≤–∏—è (–≤–≤–æ–¥)</h2>
      <div class="small">–°–æ–ª–∏: ${escapeHtml(String(pd.salts||""))} ¬∑ –ú–µ—Ö–ø—Ä–∏–º–µ—Å–∏: ${escapeHtml(String(pd.solids||""))} ¬∑ –°–∫–æ—Ä–æ—Å—Ç—å –ø–æ—Ç–æ–∫–∞: ${escapeHtml(String(pd.flow||""))} ¬∑ –ü–æ–∫—Ä—ã—Ç–∏–µ: ${escapeHtml(String(pd.coat||""))} ¬∑ –¢–µ–º–ø.: ${escapeHtml(String(pd.tempC||""))}¬∞C ¬∑ –û–±–≤–æ–¥–Ω.: ${escapeHtml(String(pd.water||""))} ¬∑ CO‚ÇÇ: ${escapeHtml(String(pd.co2||""))} ¬∑ H‚ÇÇS: ${escapeHtml(String(pd.h2s||""))} ¬∑ –ò–Ω–≥–∏–±–∏—Ç–æ—Ä: ${escapeHtml(String(pd.inhibitor||""))} ¬∑ –†–µ–∂–∏–º: ${escapeHtml(String(pd.flowRegime||""))}</div>

      <h2>–û–±—ä–µ–∫—Ç—ã –Ω–∞ —Å—Ö–µ–º–µ</h2>
      <table>
        <tr><th>–¢–∏–ø</th><th>–û–±–µ—á–∞–π–∫–∞</th><th>–ü–æ–ª–æ–∂–µ–Ω–∏–µ</th><th>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</th></tr>
        ${objects}
      </table>

      <h2>–õ–ù–ö / —Ç–æ–ª—â–∏–Ω–æ–º–µ—Ç—Ä–∏—è</h2>
      <table>
        <tr><th>–î–∞—Ç–∞</th><th>–û–±–µ—á–∞–π–∫–∞</th><th>–¢–æ–ª—â–∏–Ω–∞, –º–º</th></tr>
        ${lnk}
      </table>

      <div class="small" style="margin-top:10px;">
        –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: –æ—Ç—á—ë—Ç —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è –∏–∑ –¥–∞–Ω–Ω—ã—Ö –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ (localStorage) —ç—Ç–æ–≥–æ HTML-—Ñ–∞–π–ª–∞. –ü–µ—á–∞—Ç—å –º–æ–∂–Ω–æ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–∞–∫ PDF —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–º –¥–∏–∞–ª–æ–≥–æ–º –±—Ä–∞—É–∑–µ—Ä–∞.
      </div>

      <button onclick="window.print()" style="margin-top:14px; padding:8px 12px; border:1px solid #cfcfcf; border-radius:10px; background:#fff; cursor:pointer;">–ü–µ—á–∞—Ç—å</button>
    </body></html>`;

    const w = window.open("", "_blank");
    if (!w){ alert("–ë—Ä–∞—É–∑–µ—Ä –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª –æ—Ç–∫—Ä—ã—Ç–∏–µ –æ–∫–Ω–∞. –†–∞–∑—Ä–µ—à–∏ –≤—Å–ø–ª—ã–≤–∞—é—â–∏–µ –æ–∫–Ω–∞ –¥–ª—è –ø–µ—á–∞—Ç–∏."); return; }
    w.document.open();
    w.document.write(htmlDoc);
    w.document.close();
    w.focus();
  }catch(e){
    alert("–ü–µ—á–∞—Ç—å/–æ—Ç—á—ë—Ç –Ω–µ —É–¥–∞–ª–∏—Å—å: " + (e?.message || e));
  }
}


function renderPredictedDefects(workshop, dns, sepName, index){
  const dnsSafe = safeIdPart(dns);
  const box = document.getElementById(`pdBox_${workshop}_${dnsSafe}_${index}`);
  if (!box) return;

  const pd = getPd(workshop, dns, sepName);
  const calc = pdCompute(workshop, dns, sepName, pd);

  // Build shell options
  const shellOpts = Array.from({length:calc.N}, (_,i)=>`<option value="${i+1}">–û–±–µ—á–∞–π–∫–∞ ${i+1}</option>`).join("");

  // LNK batch inputs (–û1..–ûN)
  const lnkAllInputs = Array.from({length:calc.N}, (_,k)=>
    `<input id="pd_lnk_all_t_${workshop}_${dnsSafe}_${index}_${k+1}" type="number" step="0.01" min="0" placeholder="–û${k+1}" style="text-align:center;">`
  ).join("");


  // Repair batch inputs (–û1..–ûN)
  const repAllInputs = Array.from({length:calc.N}, (_,k)=>
    `<input id="pd_rep_all_t_${workshop}_${dnsSafe}_${index}_${k+1}" type="number" step="0.01" min="0" placeholder="–û${k+1}" style="text-align:center;">`
  ).join("");


  // Objects list
  const objs = (pd.objects||[]);
  const objList = objs.length ? objs.map(o=>`
    <li>
      <div>
        <b>${escapeHtml(pdTypeLabel(o.type))}</b> ¬∑ –û–±–µ—á–∞–π–∫–∞ ${escapeHtml(String(o.shell))} ¬∑ ${escapeHtml(pdPosLabel(o.pos))}
        <div class="pd-objmeta">${escapeHtml(o.note || "‚Äî")}</div>
      </div>
      <button class="delete-btn" onclick="pdDeleteObject('${escapeHtml(workshop)}','${escapeHtml(dns)}','${escapeHtml(sepName)}',${index},${o.id})">–£–¥–∞–ª–∏—Ç—å</button>
    </li>
  `).join("") : `<div class="smalltext">–û–±—ä–µ–∫—Ç—ã –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã. –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø–∞—Ç—Ä—É–±–æ–∫/—Ñ–ª–∞–Ω–µ—Ü, —á—Ç–æ–±—ã —É—Ç–æ—á–Ω–∏—Ç—å –ª–æ–∫–∞–ª—å–Ω—ã–µ —Ä–∏—Å–∫–∏.</div>`;

  // KPI pills
  const worst = calc.worst;
  const overallTxt = (calc.overall==="bad") ? "–ö—Ä–∏—Ç–∏—á–Ω–æ" : (calc.overall==="warn" ? "–¢—Ä–µ–±—É–µ—Ç –≤–Ω–∏–º–∞–Ω–∏—è" : "–ù–æ—Ä–º–∞");
  const pillCls = (calc.overall==="bad") ? "bad" : (calc.overall==="warn" ? "warn" : "ok");

  const critShells = calc.shells.filter(s=>s.level==="bad").map(s=>`–û${s.shell}`);
  const warnShells = calc.shells.filter(s=>s.level==="warn").map(s=>`–û${s.shell}`);
  const focusTxt = critShells.length ? `–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ: ${critShells.join(", ")}` : (warnShells.length ? `–í–Ω–∏–º–∞–Ω–∏–µ: ${warnShells.join(", ")}` : "–í—Å–µ –æ–±–µ—á–∞–π–∫–∏ –≤ –Ω–æ—Ä–º–µ");

// SVG scheme: body + N shells
  const W = 980, H = 340
  const pad = 40
  const bodyX = 60
  const bodyY = 95
  const bodyW = W - 120
  const bodyH = 150
  const shellW = bodyW / calc.N
  const sel = Math.max(1, Math.min(calc.N, parseInt(pd.selShell||1,10)))

  const shellsSvg = calc.shells.map(s=>{
    const x = bodyX + (s.shell-1)*shellW
    const y = bodyY
    const level = s.level
    const isSel = (s.shell===sel)
    return `
      <g>
        <rect class="pd-shell ${isSel?'sel':''}"
          x="${x.toFixed(2)}" y="${y}" width="${shellW.toFixed(2)}" height="${bodyH}"
          fill="${pdColor(level)}" stroke="${pdStroke(level)}"
          onclick="pdSelectShell('${escapeHtml(workshop)}','${escapeHtml(dns)}','${escapeHtml(sepName)}',${index},${s.shell})"></rect>
        <text x="${(x+shellW/2).toFixed(2)}" y="${y+26}" text-anchor="middle" font-size="16" font-weight="900" fill="currentColor">–û${s.shell}</text>
        <text x="${(x+shellW/2).toFixed(2)}" y="${y+54}" text-anchor="middle" font-size="12" font-weight="800" fill="currentColor">v‚âà${s.rate} –º–º/–≥–æ–¥</text>
        <text x="${(x+shellW/2).toFixed(2)}" y="${y+74}" text-anchor="middle" font-size="12" fill="currentColor">t‚âà${s.t} –º–º</text>
        <text x="${(x+shellW/2).toFixed(2)}" y="${y+94}" text-anchor="middle" font-size="12" fill="currentColor">–∑–∞–ø–∞—Å ${s.m} –º–º</text>
      </g>
    `;
  }).join("");

  // Render
  box.innerHTML = `
    <div class="pd-wrap">
      <div class="pd-card">
        <div class="pd-title">–î–∞–Ω–Ω—ã–µ –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞</div>
        <div class="pd-sub">–ü—Ä–æ–≥–Ω–æ–∑ —É—Ç–æ–Ω—á–µ–Ω–∏—è –º–µ—Ç–∞–ª–ª–∞ –ø–æ –æ–±–µ—á–∞–π–∫–∞–º ‚Ä¢ –õ–ù–ö (—Ç–æ–ª—â–∏–Ω–æ–º–µ—Ç—Ä–∏—è) ‚Ä¢ –æ—Å—Ç–∞—Ç–æ—á–Ω—ã–π —Ä–µ—Å—É—Ä—Å</div>

        <div class="pd-grid">
          <div>
            <label>–ù–∞—á–∞–ª—å–Ω–∞—è —Ç–æ–ª—â–∏–Ω–∞, –º–º</label>
            <input id="pd_t0_${workshop}_${dnsSafe}_${index}" type="number" step="0.1" min="0" value="${escapeHtml(String(pd.t0 ?? 16))}">
          </div>
          <div>
            <label>–ú–∏–Ω–∏–º–∞–ª—å–Ω–æ –¥–æ–ø—É—Å—Ç–∏–º–∞—è, –º–º</label>
            <input id="pd_tmin_${workshop}_${dnsSafe}_${index}" type="number" step="0.1" min="0" value="${escapeHtml(String(pd.tmin ?? 12))}">
          </div>

          <div>
            <label>–ì–æ—Ä–∏–∑–æ–Ω—Ç –ø—Ä–æ–≥–Ω–æ–∑–∞, –ª–µ—Ç</label>
            <input id="pd_years_${workshop}_${dnsSafe}_${index}" type="number" step="0.5" min="0.5" max="20" value="${escapeHtml(String(pd.years ?? 3))}">
          </div>
          <div>
            <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–±–µ—á–∞–µ–∫</label>
            <select id="pd_shells_${workshop}_${dnsSafe}_${index}">
              <option value="6">6</option>
              <option value="7">7</option>
            </select>
          </div>

          <div>
            <label>–°–æ–ª–∏</label>
            <select id="pd_salts_${workshop}_${dnsSafe}_${index}">
              <option value="low">–ù–∏–∑–∫–∏–µ</option>
              <option value="med">–°—Ä–µ–¥–Ω–∏–µ</option>
              <option value="high">–í—ã—Å–æ–∫–∏–µ</option>
            </select>
          </div>
          <div>
            <label>–ú–µ—Ö–ø—Ä–∏–º–µ—Å–∏</label>
            <select id="pd_solids_${workshop}_${dnsSafe}_${index}">
              <option value="no">–ù–µ—Ç</option>
              <option value="yes">–ï—Å—Ç—å</option>
            </select>
          </div>

          <div>
            <label>–°–∫–æ—Ä–æ—Å—Ç—å –ø–æ—Ç–æ–∫–∞</label>
            <select id="pd_flow_${workshop}_${dnsSafe}_${index}">
              <option value="low">–ù–∏–∑–∫–∞—è</option>
              <option value="norm">–ù–æ—Ä–º–∞–ª—å–Ω–∞—è</option>
              <option value="high">–í—ã—Å–æ–∫–∞—è</option>
            </select>
          </div>
          <div>
            <label>–í–Ω—É—Ç—Ä–µ–Ω–Ω–µ–µ –ø–æ–∫—Ä—ã—Ç–∏–µ</label>
            <select id="pd_coat_${workshop}_${dnsSafe}_${index}">
              <option value="yes">–ï—Å—Ç—å</option>
              <option value="no">–ù–µ—Ç</option>
            </select>
          </div>

          <div>
            <label>–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞, ¬∞C</label>
            <input id="pd_temp_${workshop}_${dnsSafe}_${index}" type="number" step="1" min="0" max="200" value="${escapeHtml(String(pd.tempC ?? 40))}">
          </div>
          <div>
            <label>–û–±–≤–æ–¥–Ω—ë–Ω–Ω–æ—Å—Ç—å</label>
            <select id="pd_water_${workshop}_${dnsSafe}_${index}">
              <option value="low">–ù–∏–∑–∫–∞—è</option>
              <option value="med">–°—Ä–µ–¥–Ω—è—è</option>
              <option value="high">–í—ã—Å–æ–∫–∞—è</option>
            </select>
          </div>

          <div>
            <label>CO‚ÇÇ</label>
            <select id="pd_co2_${workshop}_${dnsSafe}_${index}">
              <option value="no">–ù–µ—Ç</option>
              <option value="yes">–ï—Å—Ç—å</option>
            </select>
          </div>
          <div>
            <label>H‚ÇÇS</label>
            <select id="pd_h2s_${workshop}_${dnsSafe}_${index}">
              <option value="no">–ù–µ—Ç</option>
              <option value="yes">–ï—Å—Ç—å</option>
            </select>
          </div>

          <div>
            <label>–ò–Ω–≥–∏–±–∏—Ç–æ—Ä</label>
            <select id="pd_inhib_${workshop}_${dnsSafe}_${index}">
              <option value="no">–ù–µ—Ç</option>
              <option value="yes">–ï—Å—Ç—å</option>
            </select>
          </div>
          
          <div>
            <label>–í–≤–æ–¥ –≤ —ç–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏—é (–≥–æ–¥)</label>
            <input id="pd_comm_${workshop}_${dnsSafe}_${index}" type="number" step="1" min="1950" max="2100" value="${escapeHtml(String(pd.commYear ?? ""))}" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: 2014">
          </div>
          <div>
            <label>–ö–∞–ø—Ä–µ–º–æ–Ω—Ç / –∑–∞–º–µ–Ω–∞ –æ–±–µ—á–∞–π–∫–∏ (–≥–æ–¥)</label>
            <input id="pd_rep_year_${workshop}_${dnsSafe}_${index}" type="number" step="1" min="1950" max="2100" value="" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: 2020">
          </div>

          <div class="full" style="margin-top:2px;">
            <div style="font-weight:1000; margin:6px 0;">–ö–∞–ø—Ä–µ–º–æ–Ω—Ç: –æ–±–Ω–æ–≤–∏—Ç—å —Ç–æ–ª—â–∏–Ω—É –æ–±–µ—á–∞–µ–∫</div>
            <div class="smalltext">–ï—Å–ª–∏ –æ–±–µ—á–∞–π–∫—É –∑–∞–º–µ–Ω–∏–ª–∏, –¥–æ–±–∞–≤—å –≥–æ–¥ –∏ –Ω–æ–≤—É—é —Ç–æ–ª—â–∏–Ω—É. –ó–∞–º–µ—Ä—ã –õ–ù–ö –¥–æ –≥–æ–¥–∞ –∑–∞–º–µ–Ω—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–≥–Ω–æ—Ä–∏—Ä—É—é—Ç—Å—è –¥–ª—è —ç—Ç–æ–π –æ–±–µ—á–∞–π–∫–∏.</div>
          </div>

          <div>
            <label>–†–µ–∂–∏–º</label>
            <select id="pd_rep_mode_${workshop}_${dnsSafe}_${index}" onchange="pdToggleRepMode('${escapeHtml(workshop)}','${escapeHtml(dns)}','${escapeHtml(sepName)}',${index})">
              <option value="all" selected>–í—Å–µ –æ–±–µ—á–∞–π–∫–∏</option>
              <option value="one">–û–¥–Ω–∞ –æ–±–µ—á–∞–π–∫–∞</option>
            </select>
          </div>
          <div>
            <label>–ü–æ–¥—Å–∫–∞–∑–∫–∞</label>
            <input type="text" value="–ó–∞–ø–æ–ª–Ω–∏ —Ç–æ–ª—å–∫–æ –∑–∞–º–µ–Ω—ë–Ω–Ω—ã–µ" disabled>
          </div>

          <div class="full" id="pd_rep_all_wrap_${workshop}_${dnsSafe}_${index}">
            <label>–ù–æ–≤–∞—è —Ç–æ–ª—â–∏–Ω–∞ –ø–æ—Å–ª–µ –∫–∞–ø—Ä–µ–º–æ–Ω—Ç–∞, –º–º</label>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(90px,1fr)); gap:8px;">
              ${repAllInputs}
            </div>
            <div class="smalltext" style="margin-top:6px;">–ü—É—Å—Ç—ã–µ –ø–æ–ª—è –±—É–¥—É—Ç –ø—Ä–æ–ø—É—â–µ–Ω—ã ‚Äî –¥–æ–±–∞–≤—è—Ç—Å—è —Ç–æ–ª—å–∫–æ —Ç–µ –æ–±–µ—á–∞–π–∫–∏, –≥–¥–µ –≤–≤–µ–¥–µ–Ω–∞ —Ç–æ–ª—â–∏–Ω–∞.</div>
          </div>

          <div class="full" id="pd_rep_one_wrap_${workshop}_${dnsSafe}_${index}" style="display:none;">
            <div class="pd-grid">
              <div>
                <label>–û–±–µ—á–∞–π–∫–∞</label>
                <select id="pd_rep_shell_${workshop}_${dnsSafe}_${index}">${shellOpts}</select>
              </div>
              <div>
                <label>–ù–æ–≤–∞—è —Ç–æ–ª—â–∏–Ω–∞, –º–º</label>
                <input id="pd_rep_t_${workshop}_${dnsSafe}_${index}" type="number" step="0.01" min="0" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: 16">
              </div>
            </div>
          </div>

          <div class="full" style="display:flex; gap:8px; flex-wrap:wrap; margin-top:2px;">
            <button class="pdf-btn" onclick="pdAddRepairSmart('${escapeHtml(workshop)}','${escapeHtml(dns)}','${escapeHtml(sepName)}',${index})">–î–æ–±–∞–≤–∏—Ç—å –∫–∞–ø—Ä–µ–º–æ–Ω—Ç</button>
            <button class="delete-btn" onclick="pdClearRepairs('${escapeHtml(workshop)}','${escapeHtml(dns)}','${escapeHtml(sepName)}',${index})">–û—á–∏—Å—Ç–∏—Ç—å –∫–∞–ø—Ä–µ–º–æ–Ω—Ç—ã</button>
          </div>

          <div class="full" style="margin-top:6px;">
            <div style="font-weight:1000; margin-bottom:6px;">–ò—Å—Ç–æ—Ä–∏—è –∫–∞–ø—Ä–µ–º–æ–Ω—Ç–æ–≤</div>
            <ul class="pd-objlist">
              ${
                (pd.repairs||[]).length ? (function(){
                  const byYear = {};
                  (pd.repairs||[]).forEach(r=>{ const y = String(r.year||"‚Äî"); (byYear[y] ||= []).push(r); });
                  return Object.keys(byYear).sort().map(y=>{
                    const items = byYear[y].slice().sort((a,b)=>a.shell-b.shell).map(r=>`–û${r.shell}: ${r.t} –º–º`).join(" ‚Ä¢ ");
                    return `
                      <li>
                        <div>
                          <b>${escapeHtml(y)}</b>
                          <div class="pd-objmeta">${escapeHtml(items)}</div>
                        </div>
                        <button class="delete-btn" onclick="pdDeleteRepairByYear('${escapeHtml(workshop)}','${escapeHtml(dns)}','${escapeHtml(sepName)}',${index},'${escapeHtml(y)}')">–£–¥–∞–ª–∏—Ç—å –≥–æ–¥</button>
                      </li>
                    `;
                  }).join("");
                })() : `<div class="smalltext">–ö–∞–ø—Ä–µ–º–æ–Ω—Ç–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç.</div>`
              }
            </ul>
          </div>

<div>
            <label>–†–µ–∂–∏–º –ø–æ—Ç–æ–∫–∞</label>
            <select id="pd_flowreg_${workshop}_${dnsSafe}_${index}">
              <option value="low">–°–ø–æ–∫–æ–π–Ω—ã–π</option>
              <option value="norm">–ù–æ—Ä–º–∞–ª—å–Ω—ã–π</option>
              <option value="high">–¢—É—Ä–±—É–ª–µ–Ω—Ç–Ω—ã–π</option>
            </select>
          </div>


          <div class="full" style="margin-top:4px;">
            <div style="font-weight:1000; margin:6px 0;">–î–æ–±–∞–≤–∏—Ç—å –æ–±—ä–µ–∫—Ç –Ω–∞ —Å—Ö–µ–º—É</div>
          </div>

          <div>
            <label>–¢–∏–ø –æ–±—ä–µ–∫—Ç–∞</label>
            <select id="pd_obj_type_${workshop}_${dnsSafe}_${index}">
              <option value="nozzle">–ü–∞—Ç—Ä—É–±–æ–∫</option>
              <option value="flange">–§–ª–∞–Ω–µ—Ü</option>
              <option value="hatch">–õ—é–∫</option>
              <option value="zone">–ó–æ–Ω–∞</option>
            </select>
          </div>
          <div>
            <label>–û–±–µ—á–∞–π–∫–∞</label>
            <select id="pd_obj_shell_${workshop}_${dnsSafe}_${index}">${shellOpts}</select>
          </div>

          <div>
            <label>–ü–æ–ª–æ–∂–µ–Ω–∏–µ</label>
            <select id="pd_obj_pos_${workshop}_${dnsSafe}_${index}">
              <option value="inlet">–í—Ö–æ–¥</option>
              <option value="mid">–°–µ—Ä–µ–¥–∏–Ω–∞</option>
              <option value="outlet">–í—ã—Ö–æ–¥</option>
              <option value="top">–í–µ—Ä—Ö</option>
              <option value="bottom">–ù–∏–∑</option>
            </select>
          </div>
          <div>
            <label>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
            <input id="pd_obj_note_${workshop}_${dnsSafe}_${index}" type="text" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: –î—É150, —Ñ–ª–∞–Ω–µ—Ü 1-50">
          </div>

          <div class="full pd-actions">
            <button class="pdf-btn" onclick="pdSaveAndRerender('${escapeHtml(workshop)}','${escapeHtml(dns)}','${escapeHtml(sepName)}',${index})">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –ø–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å</button>
            <button class="pdf-btn" onclick="pdAddObject('${escapeHtml(workshop)}','${escapeHtml(dns)}','${escapeHtml(sepName)}',${index})">–î–æ–±–∞–≤–∏—Ç—å –æ–±—ä–µ–∫—Ç</button>
            <button class="delete-btn" onclick="pdReset('${escapeHtml(workshop)}','${escapeHtml(dns)}','${escapeHtml(sepName)}',${index})">–°–±—Ä–æ—Å</button>
          </div>

          <div class="full pd-mini">
            –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: —Ä–∞—Å—á—ë—Ç ‚Äî –∏–Ω–∂–µ–Ω–µ—Ä–Ω–∞—è –æ—Ü–µ–Ω–∫–∞ –ø–æ —É—Å–ª–æ–≤–∏—è–º –∏ –≥–µ–æ–º–µ—Ç—Ä–∏–∏. –¢–æ—á–Ω–æ—Å—Ç—å –ø–æ–≤—ã—à–∞–µ—Ç—Å—è –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ –∞–∫—Ç–æ–≤ –õ–ù–ö (—Ç–æ–ª—â–∏–Ω–æ–º–µ—Ç—Ä–∏—è –ø–æ –≥–æ–¥–∞–º).
          </div>

          <div class="full" style="margin-top:8px;">
            <div style="font-weight:1000; margin-bottom:6px;">–û–±—ä–µ–∫—Ç—ã –Ω–∞ —Å—Ö–µ–º–µ</div>
            <ul class="pd-objlist">${objList}</ul>
          </div>

                    <div class="full" style="margin-top:10px;">
            <div style="font-weight:1000; margin-bottom:6px;">–î–∞–Ω–Ω—ã–µ –õ–ù–ö / —Ç–æ–ª—â–∏–Ω–æ–º–µ—Ç—Ä–∏—è</div>
            <div class="smalltext">–ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –∑–∞–º–µ—Ä –æ–¥–Ω–æ–π –¥–∞—Ç–æ–π —Å—Ä–∞–∑—É –ø–æ –≤—Å–µ–º –æ–±–µ—á–∞–π–∫–∞–º ‚Äî –±—ã—Å—Ç—Ä–µ–µ, —á–µ–º –ø–æ –æ–¥–Ω–æ–π.</div>

            <div class="pd-grid" style="margin-top:8px;">
              <div>
                <label>–î–∞—Ç–∞ –∑–∞–º–µ—Ä–∞</label>
                <input id="pd_lnk_date_${workshop}_${dnsSafe}_${index}" type="date">
              </div>

              <div>
                <label>–†–µ–∂–∏–º</label>
                <select id="pd_lnk_mode_${workshop}_${dnsSafe}_${index}" onchange="pdToggleLnkMode('${escapeHtml(workshop)}','${escapeHtml(dns)}','${escapeHtml(sepName)}',${index})">
                  <option value="all" selected>–í—Å–µ –æ–±–µ—á–∞–π–∫–∏</option>
                  <option value="one">–û–¥–Ω–∞ –æ–±–µ—á–∞–π–∫–∞</option>
                </select>
              </div>

              <div class="full" id="pd_lnk_all_wrap_${workshop}_${dnsSafe}_${index}">
                <label>–¢–æ–ª—â–∏–Ω–∞ –ø–æ –æ–±–µ—á–∞–π–∫–∞–º, –º–º</label>
                <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(90px,1fr)); gap:8px;">
                  ${lnkAllInputs}
                </div>
                <div class="smalltext" style="margin-top:6px;">–ó–∞–ø–æ–ª–Ω–∏ —Ç–æ–ª—å–∫–æ —Ç–µ –æ–±–µ—á–∞–π–∫–∏, –≥–¥–µ –µ—Å—Ç—å –∑–∞–º–µ—Ä. –ü—É—Å—Ç—ã–µ –ø–æ–ª—è –±—É–¥—É—Ç –ø—Ä–æ–ø—É—â–µ–Ω—ã.</div>
              </div>

              <div class="full" id="pd_lnk_one_wrap_${workshop}_${dnsSafe}_${index}" style="display:none;">
                <div class="pd-grid">
                  <div>
                    <label>–û–±–µ—á–∞–π–∫–∞</label>
                    <select id="pd_lnk_shell_${workshop}_${dnsSafe}_${index}">${shellOpts}</select>
                  </div>
                  <div>
                    <label>–¢–æ–ª—â–∏–Ω–∞, –º–º</label>
                    <input id="pd_lnk_t_${workshop}_${dnsSafe}_${index}" type="number" step="0.01" min="0">
                  </div>
                </div>
              </div>

              <div class="full" style="display:flex; gap:8px; flex-wrap:wrap; margin-top:2px;">
                <button class="pdf-btn" onclick="pdAddLnkSmart('${escapeHtml(workshop)}','${escapeHtml(dns)}','${escapeHtml(sepName)}',${index})">–î–æ–±–∞–≤–∏—Ç—å –∑–∞–º–µ—Ä</button>
                <button class="delete-btn" onclick="pdClearLnk('${escapeHtml(workshop)}','${escapeHtml(dns)}','${escapeHtml(sepName)}',${index})">–û—á–∏—Å—Ç–∏—Ç—å</button>
              </div>
            </div>

            <ul class="pd-objlist" style="margin-top:10px;">
              ${
                (pd.lnk||[]).length ? (function(){
                  const byDate = {};
                  (pd.lnk||[]).forEach(p=>{
                    const d = p.date || "‚Äî";
                    (byDate[d] ||= []).push(p);
                  });
                  return Object.keys(byDate).sort().map(d=>{
                    const items = byDate[d].slice().sort((a,b)=>a.shell-b.shell).map(p=>`–û${p.shell}: ${p.t} –º–º`).join(" ‚Ä¢ ");
                    return `
                      <li>
                        <div>
                          <b>${escapeHtml(d)}</b>
                          <div class="pd-objmeta">${escapeHtml(items)}</div>
                          <div class="pd-objmeta">–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–æ–π —Å–∫–æ—Ä–æ—Å—Ç–∏ (–º–º/–≥–æ–¥), –µ—Å–ª–∏ –ø–æ –æ–±–µ—á–∞–π–∫–µ –µ—Å—Ç—å 2+ –∑–∞–º–µ—Ä–∞.</div>
                        </div>
                        <button class="delete-btn" onclick="pdDeleteLnkByDate('${escapeHtml(workshop)}','${escapeHtml(dns)}','${escapeHtml(sepName)}',${index},'${escapeHtml(d)}')">–£–¥–∞–ª–∏—Ç—å –¥–∞—Ç—É</button>
                      </li>
                    `;
                  }).join("");
                })() : `<div class="smalltext">–ó–∞–º–µ—Ä–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç.</div>`
              }
            </ul>
          </div>

        </div>
      </div>

      <div class="pd-scheme-card">
        <div class="pd-scheme-head">
          <div>
            <div style="font-weight:1000; font-size:16px;">–°—Ö–µ–º–∞ —É—Ç–æ–Ω—á–µ–Ω–∏—è –º–µ—Ç–∞–ª–ª–∞</div>
            <div class="pd-sub">–ö–ª–∏–∫ –ø–æ –æ–±–µ—á–∞–π–∫–µ ‚Äî –≤—ã–±—Ä–∞—Ç—å. –¶–≤–µ—Ç –æ—Ç—Ä–∞–∂–∞–µ—Ç –ø—Ä–æ–≥–Ω–æ–∑ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ t<sub>min</sub> –Ω–∞ –≥–æ—Ä–∏–∑–æ–Ω—Ç–µ ${escapeHtml(String(calc.years))} –ª–µ—Ç.</div>
          </div>
          <div class="pd-kpis">
            <span class="pd-pill ${pillCls}">${escapeHtml(overallTxt)}</span>
            <span class="pd-pill">${escapeHtml(focusTxt)}</span>
            <span class="pd-pill">–•—É–¥—à–∞—è: –û${escapeHtml(String(worst.shell))}</span>
            <span class="pd-pill">t<sub>—Ç–µ–∫</sub>‚âà${escapeHtml(String(worst.tcur))} –º–º</span>
            <span class="pd-pill">t‚Üí${escapeHtml(String(worst.t))} –º–º</span>
            <span class="pd-pill">—Ä–µ—Å—É—Ä—Å ‚âà${escapeHtml(String(worst.life))} –ª–µ—Ç</span>
            ${worst.cross ? `<span class="pd-pill">–¥–æ tmin: ${escapeHtml(String(worst.cross))}</span>` : ``}
            <button class="pdf-btn" style="padding:7px 10px;" onclick="pdExportCsv('${escapeHtml(workshop)}','${escapeHtml(dns)}','${escapeHtml(sepName)}',${index})">–û—Ç—á—ë—Ç CSV</button>
            <button class="pdf-btn" style="padding:7px 10px;" onclick="pdPrintReport('${escapeHtml(workshop)}','${escapeHtml(dns)}','${escapeHtml(sepName)}',${index})">–ü–µ—á–∞—Ç—å / PDF</button>
          </div>
        </div>

        <svg class="pd-svg" viewBox="0 0 ${W} ${H}" role="img" aria-label="–°—Ö–µ–º–∞ –∞–ø–ø–∞—Ä–∞—Ç–∞">
          <!-- end caps -->
          <circle cx="60" cy="${bodyY + bodyH/2}" r="42" fill="color-mix(in srgb, var(--panel) 90%, var(--chip))" stroke="color-mix(in srgb, var(--border) 70%, transparent)" stroke-width="2"></circle>
          <circle cx="${W-60}" cy="${bodyY + bodyH/2}" r="42" fill="color-mix(in srgb, var(--panel) 90%, var(--chip))" stroke="color-mix(in srgb, var(--border) 70%, transparent)" stroke-width="2"></circle>

          <!-- body outline -->
          <rect x="${bodyX}" y="${bodyY}" width="${bodyW}" height="${bodyH}"
                fill="transparent" stroke="color-mix(in srgb, var(--border) 70%, transparent)" stroke-width="2"></rect>

          ${shellsSvg}

          <!-- selected shell label -->
          <text x="${W/2}" y="${H-22}" text-anchor="middle" font-size="13" fill="currentColor" opacity=".85">
            –í—ã–±—Ä–∞–Ω–æ: –û–±–µ—á–∞–π–∫–∞ ${sel} –∏–∑ ${calc.N}
          </text>
        </svg>

        <div class="pd-legend">
          <span><i class="pd-dot ok"></i> –ù–æ—Ä–º–∞</span>
          <span><i class="pd-dot warn"></i> –¢—Ä–µ–±—É–µ—Ç –≤–Ω–∏–º–∞–Ω–∏—è</span>
          <span><i class="pd-dot bad"></i> –ö—Ä–∏—Ç–∏—á–Ω–æ (–Ω–∏–∂–µ tmin)</span>
        </div>

        <div class="pd-chart">
          <div class="pd-chart-head">
            <div style="font-weight:1000;">–ì—Ä–∞—Ñ–∏–∫ —É—Ç–æ–Ω—á–µ–Ω–∏—è –ø–æ –≥–æ–¥–∞–º</div>
            <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
              <span class="smalltext">–û–±–µ—á–∞–π–∫–∞</span>
              <select id="pd_chart_shell_${workshop}_${dnsSafe}_${index}" style="padding:7px 10px; border-radius:10px; border:1px solid var(--border); background:var(--panel); color:var(--text); font-weight:800;" onchange="pdSelectShell('${escapeHtml(workshop)}','${escapeHtml(dns)}','${escapeHtml(sepName)}',${index}, this.value)">
                ${shellOpts}
              </select>
            </div>
          </div>
          <canvas id="pd_chart_${workshop}_${dnsSafe}_${index}" class="pd-canvas" height="220"></canvas>
          <div class="smalltext" style="margin-top:6px;">–ü—É–Ω–∫—Ç–∏—Ä ‚Äî t<sub>min</sub>. –õ–∏–Ω–∏—è ‚Äî –ø—Ä–æ–≥–Ω–æ–∑ –ø–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –æ–±–µ—á–∞–π–∫–µ –Ω–∞ –∑–∞–¥–∞–Ω–Ω–æ–º –≥–æ—Ä–∏–∑–æ–Ω—Ç–µ.</div>
        </div>

        <div style="margin-top:10px; font-weight:1000;">–†–µ–π—Ç–∏–Ω–≥ –æ–±–µ—á–∞–µ–∫</div>
        <table class="pd-table">
          <tr><th>–û–±–µ—á–∞–π–∫–∞</th><th>t<sub>—Ç–µ–∫</sub>, –º–º</th><th>v (–º–º/–≥–æ–¥)</th><th>t —á–µ—Ä–µ–∑ ${escapeHtml(String(calc.years))} –ª–µ—Ç</th><th>–ó–∞–ø–∞—Å –¥–æ tmin</th><th>–†–µ—Å—É—Ä—Å –¥–æ tmin, –ª–µ—Ç</th><th>–û—Ü–µ–Ω–∫–∞</th><th>–°—Ç–∞—Ç—É—Å</th></tr>
          ${
            [...calc.shells].sort((a,b)=>a.m-b.m).map(s=>`
              <tr>
                <td><b>–û${s.shell}</b></td>
                <td>${s.tcur} –º–º</td>
                <td>${s.rate}</td>
                <td>${s.t} –º–º</td>
                <td>${s.m} –º–º</td>
                <td>${s.life}</td>
                <td>${s.cross ? escapeHtml(String(s.cross)) : "‚Äî"}</td>
                <td>${s.level==="bad" ? "<span class='pill' style='border-color:color-mix(in srgb,var(--bad) 55%, var(--border));'>–ö—Ä–∏—Ç–∏—á–Ω–æ</span>" :
                     (s.level==="warn" ? "<span class='pill' style='border-color:color-mix(in srgb,var(--warn) 55%, var(--border));'>–í–Ω–∏–º–∞–Ω–∏–µ</span>" :
                     "<span class='pill' style='border-color:color-mix(in srgb,var(--ok) 55%, var(--border));'>–ù–æ—Ä–º–∞</span>")}
                </td>
              </tr>
            `).join("")
          }
        </table>
      </div>
    </div>
  `;

  // Set select values after render
  const setVal = (id, v)=>{ const el=document.getElementById(id); if(el) el.value = String(v); };
  setVal(`pd_shells_${workshop}_${dnsSafe}_${index}`, pd.shellCount ?? 6);
  setVal(`pd_salts_${workshop}_${dnsSafe}_${index}`, pd.salts ?? "med");
  setVal(`pd_solids_${workshop}_${dnsSafe}_${index}`, pd.solids ?? "no");
  setVal(`pd_flow_${workshop}_${dnsSafe}_${index}`, pd.flow ?? "norm");
  setVal(`pd_coat_${workshop}_${dnsSafe}_${index}`, pd.coat ?? "yes");
  setVal(`pd_water_${workshop}_${dnsSafe}_${index}`, pd.water ?? "med");
  setVal(`pd_co2_${workshop}_${dnsSafe}_${index}`, pd.co2 ?? "no");
  setVal(`pd_h2s_${workshop}_${dnsSafe}_${index}`, pd.h2s ?? "no");
  setVal(`pd_inhib_${workshop}_${dnsSafe}_${index}`, pd.inhibitor ?? "no");
  setVal(`pd_flowreg_${workshop}_${dnsSafe}_${index}`, pd.flowRegime ?? "norm");
  setVal(`pd_obj_shell_${workshop}_${dnsSafe}_${index}`, Math.max(1, Math.min(calc.N, parseInt(pd.selShell||1,10))));
  setVal(`pd_chart_shell_${workshop}_${dnsSafe}_${index}`, Math.max(1, Math.min(calc.N, parseInt(pd.selShell||1,10))));

  // Extra fields
  const commEl = document.getElementById(`pd_comm_${workshop}_${dnsSafe}_${index}`);
  if (commEl) commEl.value = pd.commYear ? String(pd.commYear) : "";
  setVal(`pd_rep_mode_${workshop}_${dnsSafe}_${index}`, "all");
  pdToggleRepMode(workshop, dns, sepName, index);

  pdToggleLnkMode(workshop, dns, sepName, index);

  // Draw chart (after DOM is ready)
  pdRenderChart(workshop, dns, sepName, index, pd, calc);
}

function pdReadInputs(workshop, dns, sepName, index){
  const dnsSafe = safeIdPart(dns);
  const pd = getPd(workshop, dns, sepName);

  const readNum = (id, def)=> {
    const v = parseFloat(document.getElementById(id)?.value);
    return Number.isFinite(v) ? v : def;
  };
  const readStr = (id, def)=> (document.getElementById(id)?.value || def);

  pd.t0 = readNum(`pd_t0_${workshop}_${dnsSafe}_${index}`, pd.t0 ?? 16);
  pd.tmin = readNum(`pd_tmin_${workshop}_${dnsSafe}_${index}`, pd.tmin ?? 12);
  pd.years = readNum(`pd_years_${workshop}_${dnsSafe}_${index}`, pd.years ?? 3);
  pd.shellCount = parseInt(readStr(`pd_shells_${workshop}_${dnsSafe}_${index}`, pd.shellCount ?? 6), 10) || 6;

  pd.salts = readStr(`pd_salts_${workshop}_${dnsSafe}_${index}`, pd.salts ?? "med");
  pd.solids = readStr(`pd_solids_${workshop}_${dnsSafe}_${index}`, pd.solids ?? "no");
  pd.flow = readStr(`pd_flow_${workshop}_${dnsSafe}_${index}`, pd.flow ?? "norm");
  pd.coat = readStr(`pd_coat_${workshop}_${dnsSafe}_${index}`, pd.coat ?? "yes");
  pd.tempC = readNum(`pd_temp_${workshop}_${dnsSafe}_${index}`, pd.tempC ?? 40);
  pd.water = readStr(`pd_water_${workshop}_${dnsSafe}_${index}`, pd.water ?? "med");
  pd.co2 = readStr(`pd_co2_${workshop}_${dnsSafe}_${index}`, pd.co2 ?? "no");
  pd.h2s = readStr(`pd_h2s_${workshop}_${dnsSafe}_${index}`, pd.h2s ?? "no");
  pd.inhibitor = readStr(`pd_inhib_${workshop}_${dnsSafe}_${index}`, pd.inhibitor ?? "no");
  pd.flowRegime = readStr(`pd_flowreg_${workshop}_${dnsSafe}_${index}`, pd.flowRegime ?? "norm");

  // commissioning year (optional)
  const cy = parseInt((document.getElementById(`pd_comm_${workshop}_${dnsSafe}_${index}`)?.value || "").trim(), 10);
  if (Number.isFinite(cy) && cy >= 1950 && cy <= 2100) pd.commYear = cy; else delete pd.commYear;

  // keep sel shell within bounds
  pd.selShell = Math.max(1, Math.min(pd.shellCount, parseInt(pd.selShell||1,10)));
  return pd;
}

function pdSaveAndRerender(workshop, dns, sepName, index){
  const role = getRole();
  if (!(role === "editor" || role === "admin")){
    alert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤ (–Ω—É–∂–µ–Ω editor/admin)");
    return;
  }
  const pd = pdReadInputs(workshop, dns, sepName, index);
  savePd(workshop, dns, sepName, pd);
  renderPredictedDefects(workshop, dns, sepName, index);
  const sepEl = document.querySelector(`.separator[data-sep-index="${index}"]`);
  syncSeparatorHeight(sepEl);
}

function pdAddObject(workshop, dns, sepName, index){
  const role = getRole();
  if (!(role === "editor" || role === "admin")){
    alert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤ (–Ω—É–∂–µ–Ω editor/admin)");
    return;
  }
  const dnsSafe = safeIdPart(dns);
  const pd = pdReadInputs(workshop, dns, sepName, index);

  const type = document.getElementById(`pd_obj_type_${workshop}_${dnsSafe}_${index}`)?.value || "nozzle";
  const shell = parseInt(document.getElementById(`pd_obj_shell_${workshop}_${dnsSafe}_${index}`)?.value || "1",10);
  const pos = document.getElementById(`pd_obj_pos_${workshop}_${dnsSafe}_${index}`)?.value || "mid";
  const note = (document.getElementById(`pd_obj_note_${workshop}_${dnsSafe}_${index}`)?.value || "").trim();

  pd.objects = pd.objects || [];
  pd.objects.push({ id: Date.now(), type, shell: Math.max(1, Math.min(pd.shellCount, shell)), pos, note });

  savePd(workshop, dns, sepName, pd);
  renderPredictedDefects(workshop, dns, sepName, index);
  const sepEl = document.querySelector(`.separator[data-sep-index="${index}"]`);
  syncSeparatorHeight(sepEl);
}

function pdToggleLnkMode(workshop, dns, sepName, index){
  const dnsSafe = safeIdPart(dns);
  const modeEl = document.getElementById(`pd_lnk_mode_${workshop}_${dnsSafe}_${index}`);
  const allWrap = document.getElementById(`pd_lnk_all_wrap_${workshop}_${dnsSafe}_${index}`);
  const oneWrap = document.getElementById(`pd_lnk_one_wrap_${workshop}_${dnsSafe}_${index}`);
  if (!modeEl || !allWrap || !oneWrap) return;
  const mode = modeEl.value || "all";
  allWrap.style.display = (mode === "all") ? "" : "none";
  oneWrap.style.display = (mode === "one") ? "" : "none";
}

function pdAddLnkSmart(workshop, dns, sepName, index){
  const dnsSafe = safeIdPart(dns);
  const mode = document.getElementById(`pd_lnk_mode_${workshop}_${dnsSafe}_${index}`)?.value || "all";
  if (mode === "one") return pdAddLnk(workshop, dns, sepName, index);
  return pdAddLnkAll(workshop, dns, sepName, index);
}

function pdAddLnkAll(workshop, dns, sepName, index){
  const role = getRole();
  if (!(role === "editor" || role === "admin")){
    alert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤");
    return;
  }
  const dnsSafe = safeIdPart(dns);
  const pd = pdReadInputs(workshop, dns, sepName, index);

  const date = document.getElementById(`pd_lnk_date_${workshop}_${dnsSafe}_${index}`)?.value;
  if (!date){
    alert("–ó–∞–ø–æ–ª–Ω–∏ –¥–∞—Ç—É –∑–∞–º–µ—Ä–∞");
    return;
  }

  let added = 0;
  pd.lnk = pd.lnk || [];

  for (let s=1; s<=pd.shellCount; s++){
    const el = document.getElementById(`pd_lnk_all_t_${workshop}_${dnsSafe}_${index}_${s}`);
    const v = parseFloat(el?.value || "");
    if (Number.isFinite(v)){
      pd.lnk.push({ id: Date.now()+s, date, shell: s, t: +v.toFixed(2) });
      added++;
    }
  }

  if (!added){
    alert("–ó–∞–ø–æ–ª–Ω–∏ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É —Ç–æ–ª—â–∏–Ω—É (–û1‚Ä¶–ûN)");
    return;
  }

  savePd(workshop, dns, sepName, pd);
  renderPredictedDefects(workshop, dns, sepName, index);
  const sepEl = document.querySelector(`.separator[data-sep-index="${index}"]`);
  syncSeparatorHeight(sepEl);
}

function pdDeleteLnkByDate(workshop, dns, sepName, index, date){
  const role = getRole();
  if (!(role === "editor" || role === "admin")){
    alert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤");
    return;
  }
  const pd = getPd(workshop, dns, sepName);
  pd.lnk = (pd.lnk || []).filter(p => String(p.date) !== String(date));
  savePd(workshop, dns, sepName, pd);
  renderPredictedDefects(workshop, dns, sepName, index);
  const sepEl = document.querySelector(`.separator[data-sep-index="${index}"]`);
  syncSeparatorHeight(sepEl);
}

function pdClearLnk(workshop, dns, sepName, index){
  const role = getRole();
  if (!(role === "editor" || role === "admin")){
    alert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤");
    return;
  }
  const pd = getPd(workshop, dns, sepName);
  pd.lnk = [];
  savePd(workshop, dns, sepName, pd);
  renderPredictedDefects(workshop, dns, sepName, index);
  const sepEl = document.querySelector(`.separator[data-sep-index="${index}"]`);
  syncSeparatorHeight(sepEl);
}


function pdToggleRepMode(workshop, dns, sepName, index){
  const dnsSafe = safeIdPart(dns);
  const modeEl = document.getElementById(`pd_rep_mode_${workshop}_${dnsSafe}_${index}`);
  const allWrap = document.getElementById(`pd_rep_all_wrap_${workshop}_${dnsSafe}_${index}`);
  const oneWrap = document.getElementById(`pd_rep_one_wrap_${workshop}_${dnsSafe}_${index}`);
  if (!modeEl || !allWrap || !oneWrap) return;
  const mode = modeEl.value || "all";
  allWrap.style.display = (mode === "all") ? "" : "none";
  oneWrap.style.display = (mode === "one") ? "" : "none";
}

function pdAddRepairSmart(workshop, dns, sepName, index){
  const dnsSafe = safeIdPart(dns);
  const mode = document.getElementById(`pd_rep_mode_${workshop}_${dnsSafe}_${index}`)?.value || "all";
  if (mode === "one") return pdAddRepairOne(workshop, dns, sepName, index);
  return pdAddRepairAll(workshop, dns, sepName, index);
}

function pdAddRepairAll(workshop, dns, sepName, index){
  const role = getRole();
  if (!(role === "editor" || role === "admin")){
    alert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤");
    return;
  }
  const dnsSafe = safeIdPart(dns);
  const pd = pdReadInputs(workshop, dns, sepName, index);

  const year = parseInt(document.getElementById(`pd_rep_year_${workshop}_${dnsSafe}_${index}`)?.value || "", 10);
  if (!Number.isFinite(year) || year < 1950 || year > 2100){
    alert("–£–∫–∞–∂–∏ –≥–æ–¥ –∫–∞–ø—Ä–µ–º–æ–Ω—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä: 2020)");
    return;
  }

  let added = 0;
  pd.repairs = pd.repairs || [];

  for (let s=1; s<=pd.shellCount; s++){
    const el = document.getElementById(`pd_rep_all_t_${workshop}_${dnsSafe}_${index}_${s}`);
    const v = parseFloat(el?.value || "");
    if (Number.isFinite(v)){
      pd.repairs.push({ id: Date.now()+s, year, shell: s, t: +v.toFixed(2) });
      added++;
    }
  }

  if (!added){
    alert("–ó–∞–ø–æ–ª–Ω–∏ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É —Ç–æ–ª—â–∏–Ω—É (–û1‚Ä¶–ûN) ‚Äî —Ç–æ–ª—å–∫–æ –∑–∞–º–µ–Ω—ë–Ω–Ω—ã–µ –æ–±–µ—á–∞–π–∫–∏");
    return;
  }

  savePd(workshop, dns, sepName, pd);
  renderPredictedDefects(workshop, dns, sepName, index);
  const sepEl = document.querySelector(`.separator[data-sep-index="${index}"]`);
  syncSeparatorHeight(sepEl);
}

function pdAddRepairOne(workshop, dns, sepName, index){
  const role = getRole();
  if (!(role === "editor" || role === "admin")){
    alert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤");
    return;
  }
  const dnsSafe = safeIdPart(dns);
  const pd = pdReadInputs(workshop, dns, sepName, index);

  const year = parseInt(document.getElementById(`pd_rep_year_${workshop}_${dnsSafe}_${index}`)?.value || "", 10);
  if (!Number.isFinite(year) || year < 1950 || year > 2100){
    alert("–£–∫–∞–∂–∏ –≥–æ–¥ –∫–∞–ø—Ä–µ–º–æ–Ω—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä: 2020)");
    return;
  }

  const shell = parseInt(document.getElementById(`pd_rep_shell_${workshop}_${dnsSafe}_${index}`)?.value || "1", 10);
  const t = parseFloat(document.getElementById(`pd_rep_t_${workshop}_${dnsSafe}_${index}`)?.value || "");
  if (!Number.isFinite(t)){
    alert("–£–∫–∞–∂–∏ –Ω–æ–≤—É—é —Ç–æ–ª—â–∏–Ω—É –ø–æ—Å–ª–µ –∑–∞–º–µ–Ω—ã (–º–º)");
    return;
  }

  pd.repairs = pd.repairs || [];
  pd.repairs.push({ id: Date.now(), year, shell: Math.max(1, Math.min(pd.shellCount, shell)), t: +t.toFixed(2) });

  savePd(workshop, dns, sepName, pd);
  renderPredictedDefects(workshop, dns, sepName, index);
  const sepEl = document.querySelector(`.separator[data-sep-index="${index}"]`);
  syncSeparatorHeight(sepEl);
}

function pdDeleteRepairByYear(workshop, dns, sepName, index, yearStr){
  const role = getRole();
  if (!(role === "editor" || role === "admin")){
    alert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤");
    return;
  }
  const pd = getPd(workshop, dns, sepName);
  const y = String(yearStr||"");
  pd.repairs = (pd.repairs||[]).filter(r=> String(r.year||"") !== y);
  savePd(workshop, dns, sepName, pd);
  renderPredictedDefects(workshop, dns, sepName, index);
  const sepEl = document.querySelector(`.separator[data-sep-index="${index}"]`);
  syncSeparatorHeight(sepEl);
}

function pdClearRepairs(workshop, dns, sepName, index){
  const role = getRole();
  if (!(role === "editor" || role === "admin")){
    alert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤");
    return;
  }
  if (!confirm("–û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –∫–∞–ø—Ä–µ–º–æ–Ω—Ç–æ–≤?") ) return;
  const pd = getPd(workshop, dns, sepName);
  pd.repairs = [];
  savePd(workshop, dns, sepName, pd);
  renderPredictedDefects(workshop, dns, sepName, index);
  const sepEl = document.querySelector(`.separator[data-sep-index="${index}"]`);
  syncSeparatorHeight(sepEl);
}

function pdAddLnk(workshop, dns, sepName, index){
  const role = getRole();
  if (!(role === "editor" || role === "admin")){
    alert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤");
    return;
  }
  const dnsSafe = safeIdPart(dns);
  const pd = pdReadInputs(workshop, dns, sepName, index);

  const date = document.getElementById(`pd_lnk_date_${workshop}_${dnsSafe}_${index}`)?.value;
  const shell = parseInt(document.getElementById(`pd_lnk_shell_${workshop}_${dnsSafe}_${index}`)?.value || "1",10);
  const t = parseFloat(document.getElementById(`pd_lnk_t_${workshop}_${dnsSafe}_${index}`)?.value || "");
  if (!date || !Number.isFinite(t)){
    alert("–ó–∞–ø–æ–ª–Ω–∏ –¥–∞—Ç—É –∏ —Ç–æ–ª—â–∏–Ω—É");
    return;
  }
  pd.lnk = pd.lnk || [];
  pd.lnk.push({ id: Date.now(), date, shell: Math.max(1, Math.min(pd.shellCount, shell)), t: +t.toFixed(2) });
  savePd(workshop, dns, sepName, pd);
  renderPredictedDefects(workshop, dns, sepName, index);
  const sepEl = document.querySelector(`.separator[data-sep-index="${index}"]`);
  syncSeparatorHeight(sepEl);
}

function pdDeleteLnk(workshop, dns, sepName, index, id){
  const role = getRole();
  if (!(role === "editor" || role === "admin")){
    alert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤");
    return;
  }
  const pd = getPd(workshop, dns, sepName);
  pd.lnk = (pd.lnk || []).filter(p => String(p.id) !== String(id));
  savePd(workshop, dns, sepName, pd);
  renderPredictedDefects(workshop, dns, sepName, index);
  const sepEl = document.querySelector(`.separator[data-sep-index="${index}"]`);
  syncSeparatorHeight(sepEl);
}

function pdDeleteObject(workshop, dns, sepName, index, objId){
  const role = getRole();
  if (role !== "admin" && role !== "editor"){
    alert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤");
    return;
  }
  const pd = getPd(workshop, dns, sepName);
  pd.objects = (pd.objects || []).filter(o => String(o.id) !== String(objId));
  savePd(workshop, dns, sepName, pd);
  renderPredictedDefects(workshop, dns, sepName, index);
  const sepEl = document.querySelector(`.separator[data-sep-index="${index}"]`);
  syncSeparatorHeight(sepEl);
}

function pdSelectShell(workshop, dns, sepName, index, shellNum){
  const pd = getPd(workshop, dns, sepName);
  pd.selShell = Math.max(1, Math.min(parseInt(pd.shellCount||6,10), parseInt(shellNum||1,10)));
  savePd(workshop, dns, sepName, pd);
  renderPredictedDefects(workshop, dns, sepName, index);
  const sepEl = document.querySelector(`.separator[data-sep-index="${index}"]`);
  syncSeparatorHeight(sepEl);
}

function pdReset(workshop, dns, sepName, index){
  const role = getRole();
  if (!(role === "editor" || role === "admin")){
    alert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤");
    return;
  }
  localStorage.removeItem(pdKey(workshop, dns, sepName));
  renderPredictedDefects(workshop, dns, sepName, index);
  const sepEl = document.querySelector(`.separator[data-sep-index="${index}"]`);
  syncSeparatorHeight(sepEl);
}


/* =====================
   Init
===================== */
(function init(){
  const t = localStorage.getItem(UI.themeKey) || "light";
  applyTheme(t);

  // –ù–∞ —Å—Ç–∞—Ä—ã—Ö –≤–µ—Ä—Å–∏—è—Ö –∏–ª–∏ –ø–æ—Å–ª–µ –∏–º–ø–æ—Ä—Ç–æ–≤ —Å–ø–∏—Å–æ–∫ –¶–î–ù–ì –º–æ–≥ –±—ã—Ç—å –æ—á–∏—â–µ–Ω.
  // –í—Å–µ–≥–¥–∞ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º options –∏–∑ WORKSHOP_MAP.
  ensureWorkshopOptions();

  document.getElementById("workshopSelect").disabled = true;
  document.getElementById("dnsSelect").disabled = true;
  document.getElementById("statusFilter").disabled = true;
  document.getElementById("sepSearch").disabled = true;

  const role = getRole();
  // –†–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã –±–µ–∑ —Å–µ—Ä–≤–µ—Ä–∞: –µ—Å–ª–∏ —Ä–æ–ª—å –Ω–µ –≤—ã–±—Ä–∞–Ω–∞, –≤–∫–ª—é—á–∞–µ–º ¬´viewer¬ª –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é,
  // —á—Ç–æ–±—ã –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –∏ —Å–ø–∏—Å–æ–∫ —Å–µ–ø–∞—Ä–∞—Ç–æ—Ä–æ–≤ –Ω–µ –≤—ã–≥–ª—è–¥–µ–ª–∏ ¬´–ø—É—Å—Ç—ã–º–∏¬ª –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏.
  // –ü—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –Ω–∞–∂–∞—Ç—å ¬´–í–æ–π—Ç–∏¬ª –∏ —Å–º–µ–Ω–∏—Ç—å —Ä–æ–ª—å –ø–æ –ø–∞—Ä–æ–ª—é.
  if (!role){
    document.getElementById("authOverlay").style.display = "none";
    setRole("viewer");
    restoreLastSelection();
  } else {
    document.getElementById("authOverlay").style.display = "none";
    setRole(role);
    restoreLastSelection();
  }
})();
</script>

</body>
</html>
